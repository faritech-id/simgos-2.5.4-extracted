-- --------------------------------------------------------
-- Host:                         192.168.137.2
-- Versi server:                 8.0.11 - MySQL Community Server - GPL
-- OS Server:                    Linux
-- HeidiSQL Versi:               10.2.0.5599
-- --------------------------------------------------------

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET NAMES utf8 */;
/*!50503 SET NAMES utf8mb4 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;

-- membuang struktur untuk procedure master.storePPKBPJS
DROP PROCEDURE IF EXISTS `storePPKBPJS`;
DELIMITER //
CREATE DEFINER=`root`@`127.0.0.1` PROCEDURE `storePPKBPJS`(
	IN `PKODE` CHAR(8),
	IN `PNAMA` VARCHAR(75),
	IN `PJENIS` TINYINT,
	IN `PDESWILAYAH` VARCHAR(100),
	IN `PSTATUS` TINYINT
)
BEGIN
	DECLARE VWILAYAH CHAR(10);
	DECLARE VDESWILAYAH VARCHAR(100);
	DECLARE VNAMAWILAYAH VARCHAR(75);
	
	
	SET VDESWILAYAH = REPLACE(PDESWILAYAH, 'KOTA', '');
	
	
	SET VDESWILAYAH = TRIM(REPLACE(VDESWILAYAH, 'KAB.', ''));
	
	
	SELECT w.ID, w.DESKRIPSI INTO VWILAYAH, VNAMAWILAYAH
	  FROM master.wilayah w
	 WHERE w.DESKRIPSI = VDESWILAYAH
	   AND w.JENIS = 2
	 LIMIT 1;
	   
	IF FOUND_ROWS() = 0 THEN
		SET VWILAYAH = NULL;
		SET VNAMAWILAYAH = PDESWILAYAH;
	END IF;
	
	IF NOT EXISTS(SELECT 1 FROM master.ppk WHERE BPJS = PKODE LIMIT 1) THEN
		INSERT INTO master.ppk(BPJS, NAMA, JENIS, WILAYAH, DESWILAYAH, STATUS)
		     VALUES(PKODE, PNAMA, PJENIS, VWILAYAH, VNAMAWILAYAH, PSTATUS);
	ELSE
		UPDATE master.ppk p
		   SET p.NAMA = PNAMA
		   	 , p.JENIS = PJENIS
		   	 , p.WILAYAH = VWILAYAH
		   	 , p.DESWILAYAH = VNAMAWILAYAH
		   	 , p.`STATUS` = PSTATUS
		 WHERE p.BPJS = PKODE
		   AND p.KODE IS NULL;
	END IF;
END//
DELIMITER ;

/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, '') */;
/*!40014 SET FOREIGN_KEY_CHECKS=IF(@OLD_FOREIGN_KEY_CHECKS IS NULL, 1, @OLD_FOREIGN_KEY_CHECKS) */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
