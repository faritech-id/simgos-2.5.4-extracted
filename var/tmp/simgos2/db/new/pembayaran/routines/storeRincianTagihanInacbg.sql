-- --------------------------------------------------------
-- Host:                         192.168.137.2
-- Versi server:                 8.0.11 - MySQL Community Server - GPL
-- OS Server:                    Linux
-- HeidiSQL Versi:               10.2.0.5599
-- --------------------------------------------------------

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET NAMES utf8 */;
/*!50503 SET NAMES utf8mb4 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;

-- membuang struktur untuk procedure pembayaran.storeRincianTagihanInacbg
DROP PROCEDURE IF EXISTS `storeRincianTagihanInacbg`;
DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `storeRincianTagihanInacbg`(IN `PTAGIHAN` CHAR(10))
BEGIN
	DECLARE VTAGIHAN CHAR(10);
	DECLARE VPROSEDUR_NON_BEDAH DECIMAL(60,2);
	DECLARE VPROSEDUR_BEDAH DECIMAL(60,2);
	DECLARE VKONSULTASI DECIMAL(60,2);
	DECLARE VTENAGA_AHLI DECIMAL(60,2);
	DECLARE VPENUNJANG DECIMAL(60,2);
	DECLARE VRADIOLOGI DECIMAL(60,2);
	DECLARE VLABORATORIUM DECIMAL(60,2);
	DECLARE VBANK_DARAH DECIMAL(60,2);
	DECLARE VREHAB_MEDIK DECIMAL(60,2);
	DECLARE VAKOMODASI DECIMAL(60,2);
	DECLARE VAKOMODASI_INTENSIF DECIMAL(60,2);
	DECLARE VOBAT DECIMAL(60,2);
	DECLARE VALKES DECIMAL(60,2);
	DECLARE VBMHP DECIMAL(60,2);
	DECLARE VSEWAALAT DECIMAL(60,2);
	DECLARE VKEPERAWATAN DECIMAL(60,2);
	
	SELECT rt.TAGIHAN
     , @PROSEDUR_NON_BEDAH:=SUM(IF(rt.JENIS=3 AND jt.ID=1, (rt.JUMLAH * rt.TARIF), 0)) PROSEDUR_NON_BEDAH
	  , @PROSEDUR_BEDAH:=SUM(IF(rt.JENIS=3 AND jt.ID=2, (rt.JUMLAH * rt.TARIF), 0)) PROSEDUR_BEDAH
	  , @KONSULTASI:=SUM(IF(rt.JENIS=3 AND jt.ID=3,(rt.JUMLAH * rt.TARIF), 0)) KONSULTASI
	  , @TENAGA_AHLI:=SUM(IF(rt.JENIS=3 AND jt.ID=4, (rt.JUMLAH * rt.TARIF), 0)) TENAGA_AHLI
	  , @PENUNJANG:=SUM(IF(rt.JENIS=3 AND jt.ID=6,(rt.JUMLAH * rt.TARIF), 0)) PENUNJANG
	  , @RADIOLOGI:=SUM(IF(rt.JENIS=3 AND jt.ID=7,(rt.JUMLAH * rt.TARIF), 0))  RADIOLOGI
	  , @LABORATORIUM:=SUM(IF(rt.JENIS=3 AND jt.ID=8,(rt.JUMLAH * rt.TARIF), 0)) LABORATORIUM
	  , @BANK_DARAH:=SUM(IF(rt.JENIS=3 AND jt.ID=9, (rt.JUMLAH * rt.TARIF), 0)) BANK_DARAH
	  , @REHAB_MEDIK:=SUM(IF(rt.JENIS=3 AND jt.ID=10, (rt.JUMLAH * rt.TARIF), 0)) REHAB_MEDIK
	  , @AKOMODASI:=SUM(IF(rt.JENIS=1, (rt.JUMLAH * rt.TARIF),0)) + SUM(IF(rt.JENIS=2 AND r.REF_ID=0, (rt.JUMLAH * rt.TARIF), 0)) AKOMODASI
	  , @AKOMODASI_INTENSIF:=SUM(IF(rt.JENIS=2 AND r.REF_ID=1, (rt.JUMLAH * rt.TARIF), 0)) AKOMODASI_INTENSIF
	  , @OBAT:=SUM(IF(rt.JENIS=4 AND LEFT(br.KATEGORI,3)='101', (rt.JUMLAH * rt.TARIF),0)) OBAT
	  , @ALKES:=SUM(IF(rt.JENIS=4 AND LEFT(br.KATEGORI,3)='102', (rt.JUMLAH * rt.TARIF),0)) ALKES
	  , @BMHP:=SUM(IF(rt.JENIS=6,(rt.JUMLAH * rt.TARIF),0)) 
	     + SUM(IF(rt.JENIS=4 AND LEFT(br.KATEGORI,1)='1' AND LEFT(br.KATEGORI,3) NOT IN ('101','102'), (rt.JUMLAH * rt.TARIF),0)) BMHP
	  , @SEWAALAT:=0 SEWAALAT
	  , ROUND((SUM(rt.JUMLAH * rt.TARIF)) -  (@PROSEDUR_NON_BEDAH+@PROSEDUR_BEDAH+@KONSULTASI+@TENAGA_AHLI+@PENUNJANG+@RADIOLOGI+@LABORATORIUM+@BANK_DARAH+@REHAB_MEDIK+@AKOMODASI+@AKOMODASI_INTENSIF+@OBAT+@ALKES+@BMHP+@SEWAALAT),2) KEPERAWATAN
	  INTO VTAGIHAN, VPROSEDUR_NON_BEDAH, VPROSEDUR_BEDAH, VKONSULTASI, VTENAGA_AHLI, VPENUNJANG, VRADIOLOGI, VLABORATORIUM, VBANK_DARAH, VREHAB_MEDIK
	     , VAKOMODASI, VAKOMODASI_INTENSIF, VOBAT, VALKES, VBMHP, VSEWAALAT, VKEPERAWATAN 
	FROM pembayaran.rincian_tagihan rt
	     LEFT JOIN pendaftaran.kunjungan pk ON rt.REF_ID=pk.NOMOR AND pk.`STATUS`!=0 AND rt.JENIS=2
	     LEFT JOIN master.ruangan r ON pk.RUANGAN=r.ID
	     LEFT JOIN layanan.tindakan_medis t ON rt.REF_ID=t.ID AND rt.JENIS=3 AND t.`STATUS`!=0
	     LEFT JOIN master.tindakan tdk ON t.TINDAKAN=tdk.ID AND tdk.`STATUS`!=0
	     LEFT JOIN master.referensi jt ON tdk.JENIS=jt.ID AND jt.JENIS=74
	     LEFT JOIN pendaftaran.kunjungan pkt ON t.KUNJUNGAN=pkt.NOMOR AND pkt.`STATUS`!=0
	     LEFT JOIN master.ruangan rtk ON pkt.RUANGAN=rtk.ID
	     LEFT JOIN layanan.farmasi f ON rt.REF_ID=f.ID AND rt.JENIS=4 AND f.`STATUS`!=0
	     LEFT JOIN inventory.barang br ON f.FARMASI=br.ID AND br.`STATUS`!=0
	WHERE rt.`STATUS`!=0 AND rt.TAGIHAN=PTAGIHAN
	GROUP BY rt.TAGIHAN;

	IF	FOUND_ROWS() > 0 THEN
			UPDATE pembayaran.tagihan
			   SET PROSEDUR_NON_BEDAH = VPROSEDUR_NON_BEDAH,
			       PROSEDUR_BEDAH = VPROSEDUR_BEDAH,
			       KONSULTASI = VKONSULTASI,
			       TENAGA_AHLI = VTENAGA_AHLI,
			       KEPERAWATAN = VKEPERAWATAN,
			       PENUNJANG = VPENUNJANG,
			       RADIOLOGI = VRADIOLOGI,
			       LABORATORIUM = VLABORATORIUM,
			       BANK_DARAH = VBANK_DARAH,
			       REHAB_MEDIK = VREHAB_MEDIK,
			       AKOMODASI = VAKOMODASI,
			       AKOMODASI_INTENSIF = VAKOMODASI_INTENSIF,
			       OBAT = VOBAT,
			       ALKES = VALKES,
			       BMHP = VBMHP,
			       SEWAALAT = VSEWAALAT
			 WHERE ID = PTAGIHAN;
	END IF;
	
END//
DELIMITER ;

/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, '') */;
/*!40014 SET FOREIGN_KEY_CHECKS=IF(@OLD_FOREIGN_KEY_CHECKS IS NULL, 1, @OLD_FOREIGN_KEY_CHECKS) */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
