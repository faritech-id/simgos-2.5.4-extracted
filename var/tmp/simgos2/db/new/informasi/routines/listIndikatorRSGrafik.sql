-- --------------------------------------------------------
-- Host:                         192.168.137.2
-- Versi server:                 8.0.11 - MySQL Community Server - GPL
-- OS Server:                    Linux
-- HeidiSQL Versi:               10.2.0.5599
-- --------------------------------------------------------

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET NAMES utf8 */;
/*!50503 SET NAMES utf8mb4 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;

-- membuang struktur untuk procedure informasi.listIndikatorRSGrafik
DROP PROCEDURE IF EXISTS `listIndikatorRSGrafik`;
DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `listIndikatorRSGrafik`(IN `PTGL_AWAL` DATE, IN `PTGL_AKHIR` DATE)
    DETERMINISTIC
BEGIN	
	SELECT TTIDUR INTO @TTIDUR FROM informasi.indikator_rs WHERE TANGGAL = PTGL_AKHIR;
	
	SET @sqlText = CONCAT('',
		'SELECT ROUND((SUM(HP) * 100) / ((@TTIDUR) * (SUM(JMLHARI))),2) 
				, ROUND((SUM(LD) / SUM(JMLKLR)),2) 
				, ROUND(((@TTIDUR * SUM(JMLHARI)) - SUM(hp)) / (SUM(JMLKLR)),2) 
				, (SUM(JMLKLR) / (@TTIDUR)) 
				, 0 
		      , 0 
		      , 0 
		      , ROUND((SUM(LD) / SUM(JMLKLR)),2) 
		      , ROUND(((@TTIDUR * SUM(JMLHARI)) - SUM(hp)) / (SUM(JMLKLR)),2) 
		      , 0 
		      , 0 
		      , ROUND(SUM(JMLHARI)/(SUM(JMLKLR) / (@TTIDUR)), 2) 
		      , (10-(ROUND((SUM(HP) * 100) / ((@TTIDUR) * (SUM(JMLHARI))),2)/10)) 
		      , (ROUND((SUM(HP) * 100) / ((@TTIDUR) * (SUM(JMLHARI))),2)/10) 
		      , ROUND(((@TTIDUR * SUM(JMLHARI)) - SUM(hp)) / (SUM(JMLKLR)),2) 
		      , ROUND((SUM(LD) / SUM(JMLKLR)),2) 
		      , ROUND(((@TTIDUR * SUM(JMLHARI)) - SUM(hp)) / (SUM(JMLKLR)),2) 
		      , ROUND((SUM(LD) / SUM(JMLKLR)),2) 
		      , ROUND(SUM(JMLHARI)/(SUM(JMLKLR) / (@TTIDUR)), 2) 
		      , 0 
		      , 0
		      INTO @BOR_VAL, @AVLOS_VAL, @TOI_VAL,@BTO_VAL, @BOR_X, @BOR_Y, @AVLOS_X, @AVLOS_Y, @TOI_X, @TOI_Y, @BTO_X, @BTO_Y
					, @BOR_X1, @BOR_Y1, @AVLOS_X1, @AVLOS_Y1, @TOI_X1, @TOI_Y1, @BTO_X1, @BTO_Y1, @DF
		FROM informasi.indikator_rs irs
		WHERE irs.TANGGAL BETWEEN ''',PTGL_AWAL,''' AND ''',PTGL_AKHIR,'''

	');
	

	PREPARE stmt FROM @sqlText;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;
	
	SET @DF = IF(ROUND(@BOR_Y1 + (@AVLOS_Y1/ 2),2) < 9, 10, ROUND(@BOR_Y1 + (@AVLOS_Y1/ 2),2)) + 1;
	SET @BOR_X1 = (@BOR_X1 * @BTO_Y) / @BOR_Y1;
	SET @BOR_Y1 = @BTO_Y;
	SELECT * FROM (
		SELECT ROUND(@BOR_X,2) BOR_X, ROUND(@BOR_Y,2) BOR_Y, ROUND(@BOR_VAL,2) BOR_VAL
			  , ROUND(@AVLOS_X,2) AVLOS_X, ROUND(@AVLOS_Y,2) AVLOS_Y, ROUND(@AVLOS_VAL,2) AVLOS_VAL
			  , ROUND(@TOI_X,2) TOI_X, ROUND(@TOI_Y,2) TOI_Y, ROUND(@TOI_VAL,2) TOI_VAL
			  , ROUND(@BTO_X,2) BTO_X, ROUND(@BTO_Y,2) BTO_Y, ROUND(@BTO_VAL,2) BTO_VAL
			  , 1 DF_X, ROUND(@DF, 2) DF_Y
		FROM DUAL
		UNION
		SELECT ROUND(@BOR_X1,2) BOR_X, ROUND(@BOR_Y1,2) BOR_Y, ROUND(@BOR_VAL,2) BOR_VAL
			  ,  ROUND(@BTO_X1,2) AVLOS_X, ROUND(@AVLOS_Y1,2) AVLOS_Y, ROUND(@AVLOS_VAL,2) AVLOS_VAL
			  , ROUND(@TOI_X1,2) TOI_X,  ROUND(@BTO_Y,2) TOI_Y, ROUND(@TOI_VAL,2) TOI_VAL
			  , ROUND(@BTO_X1,2) BTO_X, ROUND(@BTO_Y1,2) BTO_Y, ROUND(@BTO_VAL,2) BTO_VAL
			  , 1 DF_X, 3 DF_Y
		FROM DUAL
		UNION
		SELECT ROUND(@BOR_X1,2) BOR_X, ROUND(@BOR_Y1,2) BOR_Y, ROUND(@BOR_VAL,2) BOR_VAL
			  , ROUND(@BTO_X1,2) AVLOS_X, ROUND(@AVLOS_Y1,2) AVLOS_Y, ROUND(@AVLOS_VAL,2) AVLOS_VAL
			  , ROUND(@TOI_X1,2) TOI_X, ROUND(@BTO_Y,2) TOI_Y, ROUND(@TOI_VAL,2) TOI_VAL
			  , ROUND(@BTO_X1,2) BTO_X, ROUND(@BTO_Y1,2) BTO_Y, ROUND(@BTO_VAL,2) BTO_VAL
			  , 3 DF_X, 9 DF_Y
		FROM DUAL
		UNION
		SELECT ROUND(@BOR_X1,2) BOR_X, ROUND(@BOR_Y1,2) BOR_Y, ROUND(@BOR_VAL,2) BOR_VAL
			  , ROUND(@BTO_X1,2) AVLOS_X, ROUND(@AVLOS_Y1,2) AVLOS_Y, ROUND(@AVLOS_VAL,2) AVLOS_VAL
			  , ROUND(@TOI_X1,2) TOI_X, ROUND(@BTO_Y,2) TOI_Y, ROUND(@TOI_VAL,2) TOI_VAL
			  , ROUND(@BTO_X1,2) BTO_X, ROUND(@BTO_Y1,2) BTO_Y, ROUND(@BTO_VAL,2) BTO_VAL
			  , 3 DF_X, ROUND(@DF, 2) DF_Y
		FROM DUAL
		UNION
		SELECT ROUND(@BOR_X1,2) BOR_X, ROUND(@BOR_Y1,2) BOR_Y, ROUND(@BOR_VAL,2) BOR_VAL
			  , ROUND(@BTO_X1,2) AVLOS_X, ROUND(@AVLOS_Y1,2) AVLOS_Y, ROUND(@AVLOS_VAL,2) AVLOS_VAL
			  , ROUND(@TOI_X1,2) TOI_X, ROUND(@BTO_Y,2) TOI_Y, ROUND(@TOI_VAL,2) TOI_VAL
			  , ROUND(@BTO_X1,2) BTO_X, ROUND(@BTO_Y1,2) BTO_Y, ROUND(@BTO_VAL,2) BTO_VAL
			  , 1 DF_X, ROUND(@DF, 2) DF_Y
		FROM DUAL
	) A;
END//
DELIMITER ;

/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, '') */;
/*!40014 SET FOREIGN_KEY_CHECKS=IF(@OLD_FOREIGN_KEY_CHECKS IS NULL, 1, @OLD_FOREIGN_KEY_CHECKS) */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
