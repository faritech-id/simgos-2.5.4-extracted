USE `inventory`;
-- Dumping structure for function inventory.getPeriodeAkhirSo
DROP FUNCTION IF EXISTS `getPeriodeAkhirSo`;
DELIMITER //
CREATE DEFINER=`root`@`localhost` FUNCTION `getPeriodeAkhirSo`(`PRUANGAN` CHAR(10)) RETURNS datetime
    DETERMINISTIC
BEGIN
	DECLARE VPERIODE DATETIME;
	DECLARE VROWS, VFIELDS INT(5);
	
	SET VROWS = 0;
	SET VFIELDS = 0;
	
	SELECT COUNT(*) INTO VFIELDS
	FROM INFORMATION_SCHEMA.COLUMNS
	WHERE TABLE_SCHEMA = 'inventory' AND TABLE_NAME = 'stok_opname' AND COLUMN_NAME = 'TIME';
	  
	SELECT 1, DATE_FORMAT(IF(VFIELDS = 1, CONCAT(TANGGAL,' ',TIME), TANGGAL),'%Y-%m-%d %H:%i:%s') INTO VROWS, VPERIODE 
	FROM stok_opname 
	WHERE RUANGAN = PRUANGAN AND STATUS = 'Final' ORDER BY TANGGAL DESC LIMIT 1;
	
	IF VROWS > 0 THEN
		RETURN VPERIODE;
	ELSE
		RETURN '2000-01-01 00:00:01';
	END IF;
END//
DELIMITER ;