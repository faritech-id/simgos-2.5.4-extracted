-- --------------------------------------------------------
-- Host:                         192.168.137.8
-- Versi server:                 8.0.34 - MySQL Community Server - GPL
-- OS Server:                    Linux
-- HeidiSQL Versi:               12.0.0.6468
-- --------------------------------------------------------

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET NAMES utf8 */;
/*!50503 SET NAMES utf8mb4 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

-- Membuang struktur basisdata untuk pembayaran
USE `pembayaran`;

-- membuang struktur untuk procedure pembayaran.storeAkomodasi
DROP PROCEDURE IF EXISTS `storeAkomodasi`;
DELIMITER //
CREATE PROCEDURE `storeAkomodasi`(
	IN `PKUNJUNGAN` CHAR(19)
)
BEGIN
	DECLARE VTAGIHAN, VNOPEN, VRUANGAN CHAR(10);
	DECLARE VMASUK, VKELUAR DATETIME;
	DECLARE VREF CHAR(21);
	DECLARE VKELAS, VKELAS_RAWAT TINYINT;
	DECLARE VRUANG_KAMAR_TIDUR, VPENJAMIN SMALLINT;
	DECLARE VTANGGAL_PENDAFTARAN, VTANGGAL DATETIME;
	DECLARE VTITIPAN TINYINT;
	DECLARE VPERSENTASE TINYINT;
	DECLARE VDISKON, VPERSENTASE_KENAIKAN DECIMAL(60, 2);
	DECLARE VRUANGAN_REF_ID TINYINT;
	
	SELECT k.NOPEN, k.MASUK, k.KELUAR, k.RUANGAN, k.REF, k.RUANG_KAMAR_TIDUR, IF(k.TITIPAN = 1, k.TITIPAN_KELAS, rk.KELAS), k.TITIPAN, r.REF_ID
	  INTO VNOPEN, VMASUK, VKELUAR, VRUANGAN, VREF, VRUANG_KAMAR_TIDUR, VKELAS, VTITIPAN, VRUANGAN_REF_ID
	  FROM pendaftaran.kunjungan k
	  		 , master.ruang_kamar_tidur rkt
			 , master.ruang_kamar rk
			 , master.ruangan r
	 WHERE k.NOMOR = PKUNJUNGAN
	   AND master.isRawatInap(k.RUANGAN) = 1
		AND rkt.ID = k.RUANG_KAMAR_TIDUR
		AND rk.ID = rkt.RUANG_KAMAR
		AND r.ID = k.RUANGAN
	 LIMIT 1;
	
	IF NOT VNOPEN IS NULL THEN
		SET VKELUAR = IF(VKELUAR IS NULL, NOW(), VKELUAR);				
		SET VTAGIHAN = pembayaran.getIdTagihan(VNOPEN);
		
		SELECT grk.KELAS INTO VKELAS_RAWAT
		  FROM master.group_referensi_kelas grk
		 WHERE grk.REFERENSI_KELAS = VKELAS;
		
		BEGIN
			DECLARE VTARIF_ID, VTARIF_HAK_ID INT;
			DECLARE VTARIF, VTARIF_HAK INT;
			DECLARE VPAKET SMALLINT;
			DECLARE VKELAS_PAKET TINYINT;
			DECLARE VLAMA TINYINT DEFAULT 0;
			DECLARE VLAMA_DIRAWAT SMALLINT DEFAULT 0;
			DECLARE VSELISIH SMALLINT DEFAULT 0;
			DECLARE VKELAS_HAK TINYINT;
		   
		   IF pembayaran.isFinalTagihan(VTAGIHAN) = 0 THEN			   
			   SELECT pkt.ID, pkt.KELAS, pkt.LAMA, pdf.TANGGAL, pj.JENIS, grk.KELAS 
				  INTO VKELAS_PAKET, VKELAS_PAKET, VLAMA, VTANGGAL_PENDAFTARAN, VPENJAMIN, VKELAS_HAK
			     FROM pendaftaran.pendaftaran pdf
			     		 LEFT JOIN master.paket pkt ON pkt.ID = pdf.PAKET,
			     		 pendaftaran.penjamin pj
			     		 LEFT JOIN master.group_referensi_kelas grk ON grk.REFERENSI_KELAS = pj.KELAS
			    WHERE pdf.NOMOR = VNOPEN
				   AND pj.NOPEN = pdf.NOMOR
				 LIMIT 1;
		   
				IF NOT VTANGGAL_PENDAFTARAN IS NULL THEN
					IF NOT VKELAS_PAKET IS NULL THEN
						SET VKELAS = VKELAS_PAKET;
					END IF;
					
					SET VTANGGAL = VMASUK;
					
					IF EXISTS(SELECT 1
						  FROM aplikasi.properti_config pc
						 WHERE pc.ID = 6
						   AND VALUE = 'TRUE') THEN
						SET VTANGGAL = VTANGGAL_PENDAFTARAN;
					END IF;
				
					SET VLAMA_DIRAWAT = pendaftaran.getLamaDirawat(VMASUK, VKELUAR, VNOPEN, PKUNJUNGAN, VREF);
										
					IF VTAGIHAN != '' AND (NOT VPAKET IS NULL OR VPAKET > 0) THEN
						CALL pembayaran.storeRincianTagihanPaket(VTAGIHAN, VPAKET, PKUNJUNGAN, VTANGGAL, 1);
						
						IF NOT VREF IS NULL OR VREF != '' THEN
							SET VLAMA_DIRAWAT = VLAMA_DIRAWAT + pendaftaran.getLamaDirawatSebelumnya(VREF, VPAKET);
						END IF;
					ELSE
						SET VLAMA = 0;
					END IF;
										
					SET VSELISIH = VLAMA_DIRAWAT - VLAMA;
					IF VTAGIHAN != '' AND (VSELISIH > 0 OR VLAMA_DIRAWAT >= 0) THEN
					   IF VSELISIH >= 0 THEN		
							IF VTITIPAN = 1 THEN
								CALL master.getTarifRuangRawatByKelas(VKELAS, VTANGGAL, VTARIF_ID, VTARIF);
							ELSE			    
					      	CALL master.getTarifRuangRawat(VRUANG_KAMAR_TIDUR, VTANGGAL, VTARIF_ID, VTARIF);
					      END IF;
					      
					      IF VKELAS_RAWAT > VKELAS_HAK THEN
					      	CALL master.getTarifRuangRawatByKelas(VKELAS_HAK, VTANGGAL, VTARIF_HAK_ID, VTARIF_HAK);
					      ELSE
					      	SET VTARIF_HAK_ID = VTARIF_ID;
					      	SET VTARIF_HAK = VTARIF;
					      END IF;
					      
					      IF pendaftaran.ikutRawatInapIbu(VNOPEN, VREF) = 1 THEN
					      	CALL master.getTarifDiskon(1, VTANGGAL, VPERSENTASE, VDISKON);
					      ELSE
								SET VPERSENTASE = 0;
								SET VDISKON = 0;
					      END IF;
					      SET VPERSENTASE_KENAIKAN = penjamin_rs.getKenaikanTarif(VPENJAMIN, 2, VTANGGAL);
							IF VPERSENTASE_KENAIKAN > 0 THEN
								SET VTARIF = VTARIF + (VTARIF * VPERSENTASE_KENAIKAN);
							END IF;
						   CALL pembayaran.storeRincianTagihan(VTAGIHAN, PKUNJUNGAN, 2, VTARIF_ID, VSELISIH, VTARIF, VKELAS, VPERSENTASE, VDISKON, 
								JSON_OBJECT(
									'TARIF_HAK', JSON_OBJECT('ID', VTARIF_HAK_ID, 'TOTAL', VTARIF_HAK, 'JUMLAH', VSELISIH),
									'RUANGAN_REF_ID', VRUANGAN_REF_ID
								)
							);
						END IF;
					END IF;
				END IF;
			END IF;
		END;
	END IF;
END//
DELIMITER ;

-- membuang struktur untuk procedure pembayaran.storeRincianTagihan
DROP PROCEDURE IF EXISTS `storeRincianTagihan`;
DELIMITER //
CREATE PROCEDURE `storeRincianTagihan`(
	IN `PTAGIHAN` CHAR(10),
	IN `PREF_ID` CHAR(19),
	IN `PJENIS` TINYINT,
	IN `PTARIF_ID` INT,
	IN `PJUMLAH` DECIMAL(10,2),
	IN `PTARIF` DECIMAL(60,2),
	IN `PKELAS` SMALLINT,
	IN `PPERSENTASE_DISKON` TINYINT,
	IN `PDISKON` DECIMAL(60,2),
	IN `PDATA` JSON
)
BEGIN
	DECLARE VTARIF DECIMAL(60,2);
	DECLARE VJML DECIMAL(10,2);
	DECLARE VJML2 DECIMAL(10,2);
	DECLARE VSTATUS TINYINT;
	DECLARE VPERSENTASE_DISKON TINYINT;
	DECLARE VDISKON TINYINT;
	DECLARE VINSERTED TINYINT DEFAULT TRUE;
	DECLARE VTOTAL DECIMAL(60, 2);
	DECLARE VTOTAL2, VTOTAL3 DECIMAL(60, 2) DEFAULT 0;
	DECLARE VCOUNT TINYINT;
	DECLARE VTAGIHAN CHAR(10);
	
	SET VTOTAL = (PJUMLAH * (PTARIF - IF(PPERSENTASE_DISKON = 0, PDISKON, (PTARIF * (PDISKON/100)))));
	SET VJML2 = PJUMLAH;
	
	# REMOVE JIKA DOUBLE
	SELECT SUM(JUMLAH * TARIF), COUNT(`TAGIHAN`)
	  INTO VTOTAL3, VCOUNT 
	  FROM pembayaran.rincian_tagihan 
	 WHERE TAGIHAN = PTAGIHAN 
	   AND REF_ID = PREF_ID 
		AND JENIS = PJENIS;
	
	IF VCOUNT = 0 THEN
		SET VTOTAL3 = 0;
	ELSE
		IF VCOUNT > 1 THEN 
			DELETE FROM pembayaran.rincian_tagihan WHERE TAGIHAN = PTAGIHAN AND REF_ID = PREF_ID AND JENIS = PJENIS;
			
			IF PJENIS = 2 THEN			
				IF NOT PDATA->>'$.RUANGAN_REF_ID' IS NULL THEN
					UPDATE pembayaran.tagihan t 
					   SET t.AKOMODASI = t.AKOMODASI - IF(PDATA->>'$.RUANGAN_REF_ID' = 0, VTOTAL3, 0)
					   	 , t.AKOMODASI_INTENSIF = t.AKOMODASI_INTENSIF - IF(PDATA->>'$.RUANGAN_REF_ID' = 1, VTOTAL3, 0)
					 WHERE t.ID = PTAGIHAN;
				END IF;
			END IF;
		END IF;
	END IF;
	
	SELECT `TAGIHAN`, TARIF, JUMLAH, PERSENTASE_DISKON, DISKON, STATUS 
	  INTO VTAGIHAN, VTARIF, VJML, VPERSENTASE_DISKON, VDISKON, VSTATUS 
	  FROM pembayaran.rincian_tagihan 
	 WHERE TAGIHAN = PTAGIHAN 
	   AND REF_ID = PREF_ID 
		AND JENIS = PJENIS;
	
	IF	NOT VTAGIHAN IS NULL THEN		
		SET VTOTAL2 = (VJML * (VTARIF - IF(VPERSENTASE_DISKON = 0, VDISKON, (VTARIF * (VDISKON/100)))));
	
		IF VTARIF != PTARIF THEN
			UPDATE pembayaran.tagihan
			   SET TOTAL = (TOTAL - VTOTAL2) + VTOTAL
			 WHERE ID = PTAGIHAN;
		ELSE 
			IF VSTATUS = 0 THEN
				UPDATE pembayaran.tagihan
				   SET TOTAL = TOTAL + VTOTAL
				 WHERE ID = PTAGIHAN;
			END IF;
		END IF;
		
		UPDATE pembayaran.rincian_tagihan 
		   SET TARIF_ID = PTARIF_ID,
		   	 JUMLAH = PJUMLAH,
		   	 TARIF = PTARIF,
		   	 PERSENTASE_DISKON = PPERSENTASE_DISKON,
		   	 DISKON = PDISKON,
		   	 STATUS = 1
		 WHERE TAGIHAN = PTAGIHAN
		 	AND REF_ID = PREF_ID
			AND JENIS = PJENIS;
			
		SET VINSERTED = FALSE;
		SET VJML2 = VJML2 - VJML;
	ELSE
		INSERT INTO pembayaran.rincian_tagihan(TAGIHAN, REF_ID, JENIS, TARIF_ID, JUMLAH, TARIF, PERSENTASE_DISKON, DISKON)
		VALUES(PTAGIHAN, PREF_ID, PJENIS, PTARIF_ID, PJUMLAH, PTARIF, PPERSENTASE_DISKON, PDISKON);
		
		UPDATE pembayaran.tagihan
		   SET TOTAL = TOTAL + VTOTAL - VTOTAL3
		 WHERE ID = PTAGIHAN;
		 
		 SET VTARIF = 0;
		 SET VJML = 0;
	END IF;
	
	SET VTOTAL = VTOTAL - VTOTAL2;
	
	BEGIN
		DECLARE VREF_ID CHAR(5);
		DECLARE VMANUAL TINYINT;
		DECLARE VPENJAMIN_TOTAL DECIMAL(60,2);
		DECLARE VSUCCESS TINYINT DEFAULT TRUE;
		DECLARE CONTINUE HANDLER FOR NOT FOUND SET VSUCCESS = FALSE;
		SELECT LEFT(r.REF_ID, 1), pt.MANUAL, pt.TOTAL INTO VREF_ID, VMANUAL, VPENJAMIN_TOTAL
		  FROM pembayaran.penjamin_tagihan pt,
		  	    master.referensi r
		 WHERE pt.TAGIHAN = PTAGIHAN
		   AND pt.KE = 1
		   AND r.ID = pt.PENJAMIN
			AND r.JENIS = 10
		 LIMIT 1;
		
		IF VSUCCESS THEN		
		   IF VREF_ID = '1' THEN
				CALL pembayaran.prosesPerhitunganAturan1(PTAGIHAN, PREF_ID, PJENIS, VTOTAL, VINSERTED, PKELAS);
			END IF;
				
			IF VREF_ID = '2' THEN
				CALL pembayaran.prosesPerhitunganBPJS(PTAGIHAN, PREF_ID, PJENIS, VTOTAL, VINSERTED, PKELAS);
			END IF;
			
			IF VREF_ID = '3' AND VMANUAL = 0 THEN
				CALL pembayaran.prosesPerhitunganAturan3(PTAGIHAN, PREF_ID, PJENIS, VTOTAL, VINSERTED, PKELAS);
			END IF;
			
			IF VREF_ID = '4' AND VMANUAL = 0 THEN
				CALL pembayaran.prosesPerhitunganJasaRaharja(PTAGIHAN, PREF_ID, PJENIS, VTOTAL, VINSERTED, PKELAS);
			END IF;
			
			IF VREF_ID = '5' AND VMANUAL = 0 THEN
				CALL pembayaran.prosesPerhitunganTotalTagihanPerkelas(PTAGIHAN, PREF_ID, PJENIS, VTOTAL, VINSERTED, PKELAS, PDATA);
			END IF; 
		END IF;		
	END;
	
	CALL pembayaran.prosesDistribusiTarif(PTAGIHAN, PREF_ID, PJENIS, VJML2, VTOTAL, VINSERTED, PKELAS);
END//
DELIMITER ;

/*!40103 SET TIME_ZONE=IFNULL(@OLD_TIME_ZONE, 'system') */;
/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, '') */;
/*!40014 SET FOREIGN_KEY_CHECKS=IFNULL(@OLD_FOREIGN_KEY_CHECKS, 1) */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40111 SET SQL_NOTES=IFNULL(@OLD_SQL_NOTES, 1) */;
