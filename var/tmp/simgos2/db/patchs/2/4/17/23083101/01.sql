USE `layanan`;
DROP FUNCTION IF EXISTS `getBatasLayananSetelahRetur`;
DELIMITER //
CREATE DEFINER=`root`@`localhost` FUNCTION `getBatasLayananSetelahRetur`(`PAWAL` DATE, `PJMLAWAL` DECIMAL(10,0), `PHARI` DECIMAL(10,0), `PJMLRETUR` DECIMAL(10,0)) RETURNS date
    DETERMINISTIC
BEGIN
	DECLARE VROWS, VAWAL, VJMLAWAL, VHARI, VJMLPERHARI, VRETUR, VINTERVALRETUR DECIMAL(10,0);
	DECLARE VTANGGAL DATE;
	SET VROWS=0;
	
	SELECT 1, @tglawal:=PAWAL   , @jml:=PJMLAWAL
   , @hari:=PHARI   , @perhari:=CEIL(@jml/@hari)
   , @retur:=PJMLRETUR   , @haristlretur:=CEIL(@retur/@perhari)
   , @tglakhir:=DATE_SUB(DATE_ADD(@tglawal, INTERVAL @hari DAY), INTERVAL @haristlretur DAY) 
	INTO VROWS, VAWAL, VJMLAWAL, VHARI, VJMLPERHARI, VRETUR, VINTERVALRETUR, VTANGGAL;
   
   IF VROWS > 0 THEN
   	RETURN VTANGGAL;
   END IF;
END//
DELIMITER ;