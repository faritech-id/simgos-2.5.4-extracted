USE `layanan`;
DROP PROCEDURE IF EXISTS `setTglBatasLayananAfterRetur`;
DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `setTglBatasLayananAfterRetur`(IN `PID` CHAR(50), IN `PJUMLAH` DECIMAL(10,2))
BEGIN
	DECLARE VJML DECIMAL(60,2);
	DECLARE VHARI,VFARMASI INT;
	DECLARE VTANGGAL, VTGLBATAS DATE;
	DECLARE VNORM CHAR(10);
	
	SELECT f.JUMLAH, f.HARI, b.TANGGAL, b.NORM, f.FARMASI
	, (SELECT `getBatasLayananSetelahRetur`(b.TANGGAL, f.JUMLAH, f.HARI, PJUMLAH))
	INTO VJML, VHARI, VTANGGAL, VNORM, VFARMASI, VTGLBATAS
	FROM farmasi f, batas_layanan_obat b
	WHERE b.REF = f.ID AND b.`STATUS`=1 AND f.ID=PID ORDER BY b.ID DESC LIMIT 1;
	
	IF VHARI > 0 THEN
		UPDATE batas_layanan_obat SET STATUS = 0 WHERE b.REF = PID;
		INSERT INTO batas_layanan_obat (NORM, FARMASI, TANGGAL, STATUS, REF) VALUES (VNORM,VFARMASI,VTGLBATAS,1,PID);
	END IF;
END//
DELIMITER ;