USE `layanan`;
DROP PROCEDURE IF EXISTS `setTglBatasLayananAfterRetur`;
DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `setTglBatasLayananAfterRetur`(IN `PID` CHAR(50), IN `PJUMLAH` DECIMAL(10,2))
BEGIN
	DECLARE VJML,VTOTALRETUR DECIMAL(60,2);
	DECLARE VHARI,VFARMASI INT;
	DECLARE VTANGGAL, VTGLBATAS DATE;
	DECLARE VNORM CHAR(10);
	
	SELECT SUM(r.JUMLAH) INTO VTOTALRETUR FROM retur_farmasi r WHERE r.ID_FARMASI = PID;
	IF VTOTALRETUR > 0 THEN
		SELECT f.JUMLAH, f.HARI, b.TANGGAL, b.NORM, f.FARMASI
		, (SELECT `getBatasLayananSetelahRetur`(IF(k.KELUAR IS NULL, DATE_FORMAT(f.TANGGAL,'%Y-%m-%d'), DATE_FORMAT(k.KELUAR,'%Y-%m-%d')), f.JUMLAH, f.HARI, VTOTALRETUR))
		INTO VJML, VHARI, VTANGGAL, VNORM, VFARMASI, VTGLBATAS
		FROM farmasi f, batas_layanan_obat b, pendaftaran.kunjungan k
		WHERE k.NOMOR = f.KUNJUNGAN AND b.REF = f.ID AND b.`STATUS`=1 AND f.ID=PID ORDER BY b.ID DESC LIMIT 1;
		
		IF VHARI > 0 THEN
			UPDATE batas_layanan_obat SET STATUS = 0 WHERE REF = PID;
			IF VJML > VTOTALRETUR THEN
				INSERT INTO batas_layanan_obat (NORM, FARMASI, TANGGAL, STATUS, REF) VALUES (VNORM,VFARMASI,VTGLBATAS,1,PID);
			END IF;
		END IF;
	END IF;
END//
DELIMITER ;