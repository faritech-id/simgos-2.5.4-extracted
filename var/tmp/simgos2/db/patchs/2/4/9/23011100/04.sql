-- --------------------------------------------------------
-- Host:                         192.168.137.8
-- Versi server:                 8.0.26 - MySQL Community Server - GPL
-- OS Server:                    Linux
-- HeidiSQL Versi:               12.0.0.6468
-- --------------------------------------------------------

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET NAMES utf8 */;
/*!50503 SET NAMES utf8mb4 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

-- Membuang struktur basisdata untuk pembayaran
USE `pembayaran`;

-- membuang struktur untuk procedure pembayaran.CetakEDC
DROP PROCEDURE IF EXISTS `CetakEDC`;
DELIMITER //
CREATE PROCEDURE `CetakEDC`(
	IN `PNOMOR` CHAR(11)
)
BEGIN
	DECLARE VNOMOR CHAR(11);
	DECLARE VTAGIHAN CHAR(10);
	DECLARE VNOMOR_KUITANSI CHAR(12);
	DECLARE VNAMA_BANK, VNAMA_KARTU, VPEMILIK, 
			  VNAMA_LENGKAP, VNAMA_INSTANSI, VKET, VPENGGUNA VARCHAR(250);
	DECLARE VNOMOR_KARTU CHAR(25);
	DECLARE VTOTAL DECIMAL(60,2);
	DECLARE VAPRV_CODE CHAR(20);
	DECLARE VTGL_EDC DATETIME;
	DECLARE VNORM CHAR(14);
	DECLARE VNIP CHAR(30);
	DECLARE VTAGIHAN_JENIS TINYINT;
	DECLARE VTAGIHAN_REF INT;
	
	SELECT dp.NOMOR, dp.TAGIHAN, bnk.DESKRIPSI NAMA_BANK, nkartu.DESKRIPSI NAMA_KARTU, 
			 dp.NO_ID NOMOR_KARTU ,dp.TOTAL, dp.NAMA PEMILIK, dp.REF APRV_CODE, dp.TANGGAL TGL_EDC,
			 INSERT(INSERT(INSERT(LPAD(t.REF,8,'0'),3,0,'-'),6,0,'-'),9,0,'-') NORM,
			 master.getNamaLengkap(p.NORM) NAMA_LENGKAP,
			 inst.NAMA NAMA_INSTANSI,
			 CONCAT(pembayaran.getInfoTagihanKunjungan(t.ID),' ',inst.NAMA) KET,
			 mp.NIP,
			 master.getNamaLengkapPegawai(mp.NIP) PENGGUNA,
			 t.JENIS, t.REF
	  INTO VNOMOR, VTAGIHAN, VNAMA_BANK, VNAMA_KARTU,
	  	    VNOMOR_KARTU, VTOTAL, VPEMILIK, VAPRV_CODE, VTGL_EDC,
	  	    VNORM, VNAMA_LENGKAP, VNAMA_INSTANSI, VKET, VNIP, VPENGGUNA,
	  	    VTAGIHAN_JENIS, VTAGIHAN_REF
	  FROM pembayaran.tagihan t
	       LEFT JOIN `master`.pasien p ON p.NORM = t.REF,
			 pembayaran.pembayaran_tagihan dp
			 LEFT JOIN aplikasi.pengguna us ON us.ID = dp.OLEH
			 LEFT JOIN master.pegawai mp ON mp.NIP = us.NIP
			 LEFT JOIN master.referensi bnk ON dp.BANK_ID = bnk.ID AND bnk.JENIS = 16
			 LEFT JOIN master.referensi nkartu ON dp.JENIS_KARTU_ID = nkartu.ID AND nkartu.JENIS = 17,
			 (SELECT mp.NAMA 
				 FROM aplikasi.instansi ai
						, master.ppk mp
				WHERE ai.PPK = mp.ID) inst
	WHERE dp.NOMOR = PNOMOR
	AND dp.TAGIHAN = t.ID
	AND dp.JENIS_LAYANAN_ID = 2
	AND NOT dp.`STATUS` = 0;
	
	IF VTAGIHAN_JENIS = 2 THEN 
		SELECT INSERT(INSERT(INSERT(LPAD(t.REF,8,'0'),3,0,'-'),6,0,'-'),9,0,'-') NORM,
			    master.getNamaLengkap(p.NORM) NAMA_LENGKAP,
			    CONCAT('Piutang ', pembayaran.getInfoTagihanKunjungan(t.ID),' ',VNAMA_INSTANSI) KET
		  INTO VNORM, VNAMA_LENGKAP, VKET
		  FROM pembayaran.pelunasan_piutang_pasien ppp
		  		 , pembayaran.tagihan t
		  		 LEFT JOIN `master`.pasien p ON p.NORM = t.REF
		 WHERE ppp.ID = VTAGIHAN_REF
		   AND t.ID = ppp.TAGIHAN_PIUTANG;
	END IF;
	
	SELECT kp.NOMOR 
	  INTO VNOMOR_KUITANSI
	  FROM cetakan.kwitansi_pembayaran kp 
	 WHERE kp.TAGIHAN = VTAGIHAN
	   AND kp.TUNAI = 0
       AND kp.JENIS_LAYANAN_ID = 2
	 ORDER BY kp.TANGGAL DESC
	 LIMIT 1;
	
	SELECT VNOMOR NOMOR, VNOMOR_KUITANSI NOMOR_KUITANSI, VTAGIHAN TAGIHAN, VNAMA_BANK NAMA_BANK, VNAMA_KARTU NAMA_KARTU,
	  	    VNOMOR_KARTU NOMOR_KARTU, VTOTAL TOTAL, VPEMILIK PEMILIK, VAPRV_CODE APRV_CODE, VTGL_EDC TGL_EDC,
	  	    VNORM NORM, VNAMA_LENGKAP NAMA_LENGKAP, VNAMA_INSTANSI NAMA_INSTANSI, VKET KET, VNIP NIP, VPENGGUNA PENGGUNA;
END//
DELIMITER ;

-- membuang struktur untuk procedure pembayaran.CetakKwitansi
DROP PROCEDURE IF EXISTS `CetakKwitansi`;
DELIMITER //
CREATE PROCEDURE `CetakKwitansi`(
	IN `PTAGIHAN` CHAR(10),
	IN `PJENIS` TINYINT
)
BEGIN
	DECLARE VNOMOR_PEMBAYARAN CHAR(11);
	DECLARE VNOMOR_KUITANSI CHAR(12);
   DECLARE VNOMOR_TAGIHAN CHAR(10);
	DECLARE VNAMALENGKAP, VNAMAINSTANSI, VALAMAT, VKET, VPENGGUNA, VPEMBAYAR VARCHAR(250);
	DECLARE VTOTAL, VTOTALTAGIHAN, VTOTALDISKON, VTOTALEDC, VTOTALPENJAMINTAGIHAN DECIMAL(60,2);
	DECLARE VTOTALPIUTANG, VTOTALDEPOSIT, VTOTALSUBSIDI, VVTAGIHAN DECIMAL(60,2);
	DECLARE VTANGGAL, VTANGGALBAYAR DATETIME;
	DECLARE VNORM CHAR(14);
	DECLARE VNIP CHAR(30);
	DECLARE VTAGIHAN, VIDPPK INT;
	DECLARE VREF INT;
	
	SELECT kp.NOMOR 
	  INTO VNOMOR_KUITANSI
	  FROM cetakan.kwitansi_pembayaran kp 
	 WHERE kp.TAGIHAN = PTAGIHAN
	   AND kp.TUNAI = 1
       AND kp.JENIS_LAYANAN_ID = 1
	 ORDER BY kp.TANGGAL DESC
	 LIMIT 1;
	
	SELECT pt.NOMOR, t.ID, t.TANGGAL, t.TOTAL,
			 pt.TANGGAL TANGGALBAYAR,
			 INSERT(INSERT(INSERT(LPAD(t.REF,8,'0'),3,0,'-'),6,0,'-'),9,0,'-') NORM,
			 master.getNamaLengkap(p.NORM) NAMALENGKAP,
			 inst.PPK IDPPK, UPPER(inst.NAMA) NAMAINSTANSI, inst.ALAMAT,
			 CONCAT(pembayaran.getInfoTagihanKunjungan(t.ID),' ',inst.NAMA) KET,
			 mp.NIP,
			 master.getNamaLengkapPegawai(mp.NIP) PENGGUNA, 
			 (SELECT NAMA FROM cetakan.kwitansi_pembayaran kp WHERE kp.TAGIHAN=t.ID ORDER BY kp.TANGGAL DESC LIMIT 1) PEMBAYAR,
			 @tghn:=IF(pj.JENIS=2 AND pjt.NAIK_KELAS=1 OR (pc.VALUE = 'TRUE' AND (pjt.NAIK_KELAS=1 OR pjt.NAIK_KELAS_VIP OR pjt.NAIK_DIATAS_VIP=1)),(pjt.TOTAL_NAIK_KELAS), IF(t.TOTAL < pjt.TOTAL,pjt.TARIF_INACBG_KELAS1,(t.TOTAL))) TOTALTAGIHAN, 
			 @td:=(pembayaran.getTotalDiskon(t.ID)+ pembayaran.getTotalDiskonDokter(t.ID)) TOTALDISKON, 
			 @tedc:=pembayaran.getTotalNonTunai(t.ID) TOTALEDC, 
			 @tj:=pembayaran.getTotalPenjaminTagihan(t.ID) TOTALPENJAMINTAGIHAN, 
			 @tp:=(pembayaran.getTotalPiutangPasien(t.ID) + pembayaran.getTotalPiutangPerusahaan(t.ID)) TOTALPIUTANG,
			 @tdp:=(pembayaran.getTotalDeposit(t.ID) - pembayaran.getTotalPengembalianDeposit(t.ID)) TOTALDEPOSIT,
			 @ts:=pembayaran.getTotalSubsidiTagihan(t.ID) TOTALSUBSIDI,
			 @tot:=ROUND(@tghn - @tj - @ts - @tp - @td - @tedc - @tdp) VTAGIHAN,
			 IF(@tot < 0, 0, @tot) `TAGIHAN`,
			 t.REF
	  INTO VNOMOR_PEMBAYARAN, VNOMOR_TAGIHAN, VTANGGAL, VTOTAL, 
	  		 VTANGGALBAYAR, VNORM, VNAMALENGKAP,
	  		 VIDPPK, VNAMAINSTANSI, VALAMAT, VKET,
	  		 VNIP, VPENGGUNA, VPEMBAYAR,
	  		 VTOTALTAGIHAN, VTOTALDISKON, VTOTALEDC, VTOTALPENJAMINTAGIHAN, VTOTALPIUTANG,
	  		 VTOTALDEPOSIT, VTOTALSUBSIDI, VVTAGIHAN, VTAGIHAN,
	  		 VREF
	  FROM pembayaran.tagihan t
	  		 LEFT JOIN `master`.pasien p ON p.NORM = t.REF
	  		 LEFT JOIN pembayaran.pembayaran_tagihan pt ON pt.TAGIHAN = t.ID AND pt.JENIS = 1 AND pt.`STATUS` IN (1, 2)
	  		 LEFT JOIN pembayaran.tagihan_pendaftaran tpd ON t.ID=tpd.TAGIHAN AND tpd.STATUS=1 AND tpd.UTAMA = 1
		    LEFT JOIN pendaftaran.pendaftaran pd ON tpd.PENDAFTARAN=pd.NOMOR AND pd.STATUS IN (1,2)
		    LEFT JOIN pembayaran.penjamin_tagihan pjt ON t.ID=pjt.TAGIHAN AND pjt.KE=1
		    LEFT JOIN pendaftaran.penjamin pj ON pd.NOMOR=pj.NOPEN
			 LEFT JOIN aplikasi.pengguna us ON us.ID = pt.OLEH
			 LEFT JOIN master.pegawai mp ON mp.NIP = us.NIP,
			 (SELECT mpp.NAMA, mpp.ALAMAT, ai.PPK
				FROM aplikasi.instansi ai
					, master.ppk mpp
				WHERE ai.PPK=mpp.ID) inst
			 , aplikasi.properti_config pc
	 WHERE t.ID = PTAGIHAN
	   AND t.JENIS = PJENIS
	   AND t.`STATUS` = 2
		AND pc.ID = 9;
		
	IF PJENIS = 2 THEN 
		SELECT INSERT(INSERT(INSERT(LPAD(t.REF,8,'0'),3,0,'-'),6,0,'-'),9,0,'-') NORM,
			    master.getNamaLengkap(p.NORM) NAMALENGKAP,
			    CONCAT('Piutang ', pembayaran.getInfoTagihanKunjungan(t.ID),' ',VNAMAINSTANSI) KET
		  INTO VNORM, VNAMALENGKAP, VKET
		  FROM pembayaran.pelunasan_piutang_pasien ppp
		  		 , pembayaran.tagihan t
		  		 LEFT JOIN `master`.pasien p ON p.NORM = t.REF
		 WHERE ppp.ID = VREF
		   AND t.ID = ppp.TAGIHAN_PIUTANG;
	END IF;
	
	SELECT VNOMOR_PEMBAYARAN NOMOR_PEMBAYARAN, VNOMOR_KUITANSI NOMOR_KUITANSI, VNOMOR_TAGIHAN NOMOR_TAGIHAN, VNOMOR_TAGIHAN ID, VTANGGAL TANGGAL, VTOTAL TOTAL, 
	  		 VTANGGALBAYAR TANGGALBAYAR, VNORM NORM, VNAMALENGKAP NAMALENGKAP,
	  		 VIDPPK IDPPK, VNAMAINSTANSI NAMAINSTANSI, VALAMAT ALAMAT, VKET KET,
	  		 VNIP NIP, VPENGGUNA PENGGUNA, VPEMBAYAR PEMBAYAR,
	 		 VTOTALTAGIHAN TOTALTAGIHAN, VTOTALDISKON TOTALDISKON, 
			 VTOTALEDC TOTALEDC, VTOTALPENJAMINTAGIHAN TOTALPENJAMINTAGIHAN, VTOTALPIUTANG TOTALPIUTANG,
	  		 VTOTALDEPOSIT TOTALDEPOSIT, VTOTALSUBSIDI TOTALSUBSIDI, VVTAGIHAN VTAGIHAN, VTAGIHAN `TAGIHAN`;
END//
DELIMITER ;

-- membuang struktur untuk procedure pembayaran.CetakTransfer
DROP PROCEDURE IF EXISTS `CetakTransfer`;
DELIMITER //
CREATE PROCEDURE `CetakTransfer`(
	IN `PNOMOR` CHAR(11)
)
BEGIN
	DECLARE VNOMOR CHAR(11);
	DECLARE VTAGIHAN CHAR(10);
	DECLARE VNOMOR_KUITANSI CHAR(12);
	DECLARE VNAMA_BANK, VNAMA_KARTU, VPENYETOR_NAMA, 
			  VNAMA_LENGKAP, VNAMA_INSTANSI, VKET, VPENGGUNA VARCHAR(250);
	DECLARE VPENYETOR_REKENING CHAR(25);
	DECLARE VTOTAL DECIMAL(60,2);
	DECLARE VKODE_REF CHAR(20);
	DECLARE VTANGGAL DATETIME;
	DECLARE VNORM CHAR(14);
	DECLARE VNIP CHAR(30);
	DECLARE VTAGIHAN_JENIS TINYINT;
	DECLARE VTAGIHAN_REF INT;
	
	SELECT dp.NOMOR, dp.TAGIHAN, bnk.DESKRIPSI NAMA_BANK, nkartu.DESKRIPSI NAMA_KARTU, 
			 dp.NO_ID PENYETOR_REKENING ,dp.TOTAL, dp.NAMA PENYETOR_NAMA, dp.REF KODE_REF, dp.TANGGAL,
			 INSERT(INSERT(INSERT(LPAD(t.REF,8,'0'),3,0,'-'),6,0,'-'),9,0,'-') NORM,
			 master.getNamaLengkap(p.NORM) NAMA_LENGKAP,
			 inst.NAMA NAMA_INSTANSI,
			 CONCAT(pembayaran.getInfoTagihanKunjungan(t.ID),' ',inst.NAMA) KET,
			 mp.NIP,
			 master.getNamaLengkapPegawai(mp.NIP) PENGGUNA,
			 t.JENIS, t.REF
	  INTO VNOMOR, VTAGIHAN, VNAMA_BANK, VNAMA_KARTU,
	  	    VPENYETOR_REKENING, VTOTAL, VPENYETOR_NAMA, VKODE_REF, VTANGGAL,
	  	    VNORM, VNAMA_LENGKAP, VNAMA_INSTANSI, VKET, VNIP, VPENGGUNA,
	  	    VTAGIHAN_JENIS, VTAGIHAN_REF
	  FROM pembayaran.tagihan t
	       LEFT JOIN `master`.pasien p ON p.NORM = t.REF,
			 pembayaran.pembayaran_tagihan dp
			 LEFT JOIN aplikasi.pengguna us ON us.ID = dp.OLEH
			 LEFT JOIN master.pegawai mp ON mp.NIP = us.NIP
			 LEFT JOIN master.referensi bnk ON dp.BANK_ID = bnk.ID AND bnk.JENIS = 16
			 LEFT JOIN master.referensi nkartu ON dp.JENIS_KARTU_ID = nkartu.ID AND nkartu.JENIS = 17,
			 (SELECT mp.NAMA 
				 FROM aplikasi.instansi ai
						, master.ppk mp
				WHERE ai.PPK = mp.ID) inst
	WHERE dp.NOMOR = PNOMOR
	AND dp.TAGIHAN = t.ID
	AND dp.JENIS_LAYANAN_ID = 3
	AND NOT dp.`STATUS` = 0;
	
	IF VTAGIHAN_JENIS = 2 THEN 
		SELECT INSERT(INSERT(INSERT(LPAD(t.REF,8,'0'),3,0,'-'),6,0,'-'),9,0,'-') NORM,
			    master.getNamaLengkap(p.NORM) NAMA_LENGKAP,
			    CONCAT('Piutang ', pembayaran.getInfoTagihanKunjungan(t.ID),' ',VNAMA_INSTANSI) KET
		  INTO VNORM, VNAMA_LENGKAP, VKET
		  FROM pembayaran.pelunasan_piutang_pasien ppp
		  		 , pembayaran.tagihan t
		  		 LEFT JOIN `master`.pasien p ON p.NORM = t.REF
		 WHERE ppp.ID = VTAGIHAN_REF
		   AND t.ID = ppp.TAGIHAN_PIUTANG;
	END IF;
	
	SELECT kp.NOMOR 
	  INTO VNOMOR_KUITANSI
	  FROM cetakan.kwitansi_pembayaran kp 
	 WHERE kp.TAGIHAN = VTAGIHAN
	   AND kp.TUNAI = 0
      AND kp.JENIS_LAYANAN_ID = 3
	 ORDER BY kp.TANGGAL DESC
	 LIMIT 1;
	
	SELECT VNOMOR NOMOR, VNOMOR_KUITANSI NOMOR_KUITANSI, VTAGIHAN TAGIHAN, VNAMA_BANK NAMA_BANK, VNAMA_KARTU NAMA_KARTU,
	  	    VPENYETOR_REKENING PENYETOR_REKENING, VTOTAL TOTAL, VPENYETOR_NAMA PENYETOR_NAMA, VKODE_REF KODE_REF, VTANGGAL TANGGAL,
	  	    VNORM NORM, VNAMA_LENGKAP NAMA_LENGKAP, VNAMA_INSTANSI NAMA_INSTANSI, VKET KET, VNIP NIP, VPENGGUNA PENGGUNA;
END//
DELIMITER ;

/*!40103 SET TIME_ZONE=IFNULL(@OLD_TIME_ZONE, 'system') */;
/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, '') */;
/*!40014 SET FOREIGN_KEY_CHECKS=IFNULL(@OLD_FOREIGN_KEY_CHECKS, 1) */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40111 SET SQL_NOTES=IFNULL(@OLD_SQL_NOTES, 1) */;
