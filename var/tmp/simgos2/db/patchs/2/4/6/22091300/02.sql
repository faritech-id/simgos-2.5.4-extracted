-- --------------------------------------------------------
-- Host:                         192.168.137.8
-- Versi server:                 8.0.26 - MySQL Community Server - GPL
-- OS Server:                    Linux
-- HeidiSQL Versi:               12.0.0.6468
-- --------------------------------------------------------

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET NAMES utf8 */;
/*!50503 SET NAMES utf8mb4 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;


-- Membuang struktur basisdata untuk pembayaran
CREATE DATABASE IF NOT EXISTS `pembayaran`;
USE `pembayaran`;

-- membuang struktur untuk procedure pembayaran.reStoreTagihan
DROP PROCEDURE IF EXISTS `reStoreTagihan`;
DELIMITER //
CREATE PROCEDURE `reStoreTagihan`(
	IN `PTAGIHAN` CHAR(10)
)
BEGIN
	DECLARE VNORM INT;
	DECLARE VPENDAFTARAN CHAR(10);
	DECLARE VPAKET SMALLINT DEFAULT NULL;
	DECLARE VKARTU CHAR(11);
	DECLARE VKARCIS CHAR(11);
	DECLARE VTARIF_ID INT;
	DECLARE VTARIF DECIMAL(60,2);
	DECLARE VQTY DECIMAL(60,2);
	DECLARE VPAKET_DETIL INT DEFAULT 0;
	DECLARE VJENIS_KUNJUNGAN SMALLINT;
	DECLARE VTANGGAL_PENDAFTARAN DATETIME;
	DECLARE VKELAS SMALLINT DEFAULT 0;
	DECLARE VKUNJUNGAN_TMP CHAR(19);
	DECLARE VTANGGAL_TAGIHAN DATETIME DEFAULT NULL;
	DECLARE VTGL_DAFTAR_PASIEN DATETIME;
	DECLARE VPASIEN_BARU TINYINT DEFAULT 0;
	DECLARE VAKTIF_TARIF_ADM_BERDASARKAN_JENIS_PASIEN TINYINT DEFAULT FALSE;	
	
	IF pembayaran.isFinalTagihan(PTAGIHAN) = 0 THEN		
		SELECT t.TANGGAL, p.TANGGAL INTO VTANGGAL_TAGIHAN, VTGL_DAFTAR_PASIEN
		  FROM pembayaran.tagihan t, master.pasien p
		 WHERE t.ID = PTAGIHAN
		   AND t.JENIS = 1
			AND p.NORM = t.REF
		 LIMIT 1;
		 
		SET VPASIEN_BARU = IF(DATE(VTGL_DAFTAR_PASIEN) = DATE(VTANGGAL_TAGIHAN), 1, 0);
				
		IF EXISTS(SELECT 1
			  FROM aplikasi.properti_config pc
			 WHERE pc.ID = 23
			   AND VALUE = 'TRUE') THEN		
			SET VAKTIF_TARIF_ADM_BERDASARKAN_JENIS_PASIEN = TRUE;
		END IF;
				
		UPDATE pembayaran.tagihan t
		   SET t.TOTAL = 0
		   	 , t.PROSEDUR_NON_BEDAH = 0
		   	 , t.PROSEDUR_BEDAH = 0
		   	 , t.KONSULTASI = 0
		   	 , t.TENAGA_AHLI = 0
		   	 , t.KEPERAWATAN = 0
		   	 , t.PENUNJANG = 0
		   	 , t.RADIOLOGI = 0
		   	 , t.LABORATORIUM = 0
		   	 , t.BANK_DARAH = 0
		   	 , t.REHAB_MEDIK = 0
		   	 , t.AKOMODASI = 0
		   	 , t.AKOMODASI_INTENSIF = 0
		   	 , t.OBAT = 0
		   	 , t.OBAT_KRONIS = 0
		   	 , t.OBAT_KEMOTERAPI = 0
		   	 , t.ALKES = 0
		   	 , t.BMHP = 0
		   	 , t.SEWA_ALAT = 0
		   	 , t.RAWAT_INTENSIF = 0
		   	 , t.LAMA_RAWAT_INTENSIF = 0
		 WHERE t.ID = PTAGIHAN
		   AND t.STATUS = 1;		   
		
		UPDATE pembayaran.penjamin_tagihan pt
		   SET pt.TOTAL_NAIK_KELAS = 0,
		   	 pt.NAIK_KELAS = 0,
		   	 pt.NAIK_KELAS_VIP = 0,
		   	 pt.NAIK_DIATAS_VIP = 0,
		   	 pt.TOTAL_TAGIHAN_HAK = 0,	   	
		   	 pt.KELAS = 0,
		   	 pt.LAMA_NAIK = 0
		 WHERE pt.TAGIHAN = PTAGIHAN;
		 
		UPDATE pembayaran.penjamin_tagihan pt,
		       pembayaran.subsidi_tagihan st
		   SET st.TOTAL = 0
		 WHERE pt.TAGIHAN = PTAGIHAN
		   AND st.TAGIHAN = pt.TAGIHAN
			AND st.ID = pt.SUBSIDI_TAGIHAN;
			
		IF NOT EXISTS(SELECT 1 FROM pembayaran.penjamin_tagihan pt WHERE pt.TAGIHAN = PTAGIHAN) THEN
			UPDATE pembayaran.subsidi_tagihan st
			   SET st.TOTAL = 0
			WHERE st.TAGIHAN = PTAGIHAN
			  AND st.`STATUS` = 1;
		END IF;
		 		   		
		SELECT rt.REF_ID INTO VKARTU
		  FROM pembayaran.rincian_tagihan rt,
		  		 master.tarif_administrasi ta
		 WHERE rt.TAGIHAN = PTAGIHAN
		 	AND rt.JENIS = 1
		   AND ta.ID = rt.TARIF_ID	   
		   AND ta.ADMINISTRASI = 1;
		   		
		INSERT INTO pembayaran.rincian_tagihan_temp(TANGGAL, TAGIHAN, REF_ID, JENIS, TARIF_ID, JUMLAH, TARIF, STATUS)
		  SELECT NOW(), TAGIHAN, REF_ID, JENIS, TARIF_ID, JUMLAH, TARIF, STATUS
		    FROM pembayaran.rincian_tagihan WHERE TAGIHAN = PTAGIHAN;
						
		DELETE FROM pembayaran.rincian_tagihan WHERE TAGIHAN = PTAGIHAN;		
		DELETE FROM pembayaran.rincian_tagihan_paket WHERE TAGIHAN = PTAGIHAN;		
		
		SELECT p.NOMOR, p.PAKET, p.TANGGAL 
		  INTO VPENDAFTARAN, VPAKET, VTANGGAL_PENDAFTARAN
		  FROM pembayaran.tagihan_pendaftaran tp,
		  		 pendaftaran.pendaftaran p
		 WHERE tp.TAGIHAN = PTAGIHAN
		   AND p.NOMOR = tp.PENDAFTARAN
		   
		   AND tp.UTAMA = 1
		 LIMIT 1;
		 
		IF VPENDAFTARAN IS NULL THEN
			SET VTANGGAL_PENDAFTARAN = NOW();
		END IF;
		 		
		IF VPAKET > 0 OR NOT VPAKET IS NULL THEN
			CALL master.getTarifPaket(VPAKET, VTANGGAL_PENDAFTARAN, VTARIF_ID, VTARIF);
			CALL pembayaran.storeRincianTagihan(PTAGIHAN, VPENDAFTARAN, 5, VTARIF_ID, 1, VTARIF, 0, 0, 0);
		END IF;
				
		IF (VPAKET > 0 OR NOT VPAKET IS NULL) AND NOT VKARTU IS NULL THEN
			CALL master.inPaket(VPAKET, 3, 1, NULL, VQTY, VPAKET_DETIL);
			IF VPAKET_DETIL > 0 THEN
				CALL pembayaran.storeRincianTagihanPaket(PTAGIHAN, VPAKET_DETIL, VKARTU, VTANGGAL_PENDAFTARAN, 1, 1);
			END IF;
		END IF;
		
		IF VPAKET_DETIL = 0 AND NOT VKARTU IS NULL THEN
		BEGIN
			IF NOT VAKTIF_TARIF_ADM_BERDASARKAN_JENIS_PASIEN THEN						   
				CALL master.getTarifAdministrasi(1, 0, VTANGGAL_PENDAFTARAN, VTARIF_ID, VTARIF);
			ELSE
				CALL master.getTarifAdministrasiBerdasarkanJenisPasien(1, 0, VTANGGAL_PENDAFTARAN, VPASIEN_BARU, VTARIF_ID, VTARIF);
			END IF;
			
			SELECT k.NOMOR, IF(rk.KELAS IS NULL, -1, IF(k.TITIPAN = 1, k.TITIPAN_KELAS, rk.KELAS)) 
			  INTO VKUNJUNGAN_TMP, VKELAS
			  FROM pendaftaran.kunjungan k
			       LEFT JOIN master.ruang_kamar_tidur rkt ON rkt.ID = k.RUANG_KAMAR_TIDUR
			 		 LEFT JOIN master.ruang_kamar rk ON rk.ID = rkt.RUANG_KAMAR
			 WHERE k.NOPEN = VPENDAFTARAN			   
			   AND k.REF IS NULL
			   AND NOT k.`STATUS` = 0;
			
			IF NOT VKELAS IS NULL THEN
				IF VKELAS < 0 THEN			
					SET VKELAS = pembayaran.getKelasRJMengikutiKelasRIYgPertama(PTAGIHAN, VKUNJUNGAN_TMP);
					IF VKELAS < 0 THEN
						SET VKELAS = 0;
					END IF;
				END IF;
			END IF;						
			
			CALL pembayaran.storeRincianTagihan(PTAGIHAN, VKARTU, 1, VTARIF_ID, 1, VTARIF, VKELAS, 0, 0);
		END;
		END IF;
						
		BEGIN
			DECLARE VUTAMA TINYINT;
			DECLARE DATA_NOT_FOUND TINYINT DEFAULT FALSE;
			DECLARE CR_TAGIHAN_PENDAFTARAN CURSOR FOR
				SELECT tp.PENDAFTARAN, tp.UTAMA
				  FROM pembayaran.tagihan_pendaftaran tp
				 WHERE tp.TAGIHAN = PTAGIHAN
				   AND tp.STATUS = 1
				 ORDER BY tp.UTAMA DESC;
			DECLARE CONTINUE HANDLER FOR NOT FOUND SET DATA_NOT_FOUND = TRUE;
			
			OPEN CR_TAGIHAN_PENDAFTARAN;
			EOF: LOOP
				FETCH CR_TAGIHAN_PENDAFTARAN INTO VPENDAFTARAN, VUTAMA;
				
				IF DATA_NOT_FOUND THEN
					UPDATE temp.temp SET ID = 0 WHERE ID = 0;
					LEAVE EOF;
				END IF;
				
				IF VUTAMA = 0 THEN					
					IF EXISTS(SELECT 1
						  FROM aplikasi.properti_config pc
						 WHERE pc.ID = 22
						   AND VALUE = 'TRUE') THEN
						UPDATE temp.temp SET ID = 0 WHERE ID = 0;
						LEAVE EOF;
					END IF;
				END IF;
				
				SELECT kp.ID, r.JENIS_KUNJUNGAN, p.NORM INTO VKARCIS, VJENIS_KUNJUNGAN, VNORM
				  FROM cetakan.karcis_pasien kp
				  		 , pendaftaran.tujuan_pasien tps
				  		 , pendaftaran.pendaftaran p
					  	 , master.ruangan r
				 WHERE kp.NOPEN = VPENDAFTARAN
				   AND kp.JENIS = 1
				   AND tps.NOPEN = kp.NOPEN
					AND r.ID = tps.RUANGAN
					AND p.NOMOR = tps.NOPEN
				 LIMIT 1;
				
				IF (VPAKET > 0 OR NOT VPAKET IS NULL) AND NOT VKARCIS IS NULL THEN
					CALL master.inPaket(VPAKET, 3, 2, NULL, VQTY, VPAKET_DETIL);
					IF VPAKET_DETIL > 0 THEN
						CALL pembayaran.storeRincianTagihanPaket(PTAGIHAN, VPAKET_DETIL, VKARCIS, VTANGGAL_PENDAFTARAN, 1, 1);
					END IF;
				END IF;
				
				IF VPAKET_DETIL = 0 AND NOT VKARCIS IS NULL THEN
					IF NOT VAKTIF_TARIF_ADM_BERDASARKAN_JENIS_PASIEN THEN						   
						CALL master.getTarifAdministrasi(2, VJENIS_KUNJUNGAN, VTANGGAL_PENDAFTARAN, VTARIF_ID, VTARIF);
					ELSE
						IF EXISTS(SELECT 1
							  FROM aplikasi.properti_config pc
							 WHERE pc.ID = 24
							   AND VALUE = 'TRUE') THEN
							IF NOT EXISTS(SELECT 1
								  FROM pendaftaran.kunjungan k,
								  		 pendaftaran.pendaftaran p,
								       master.ruangan rg
								 WHERE NOT k.NOPEN = VPENDAFTARAN
								   AND k.`STATUS` > 0
									AND p.NOMOR = k.NOPEN
									AND p.NORM = VNORM
									AND rg.ID = k.RUANGAN
									AND rg.JENIS_KUNJUNGAN = VJENIS_KUNJUNGAN
								 LIMIT 1) THEN								   							   
								SET VPASIEN_BARU = 1;
							END IF;
						END IF;
						
						CALL master.getTarifAdministrasiBerdasarkanJenisPasien(2, VJENIS_KUNJUNGAN, VTANGGAL_PENDAFTARAN, VPASIEN_BARU, VTARIF_ID, VTARIF);
					END IF;
					
					SET VKELAS = 0;
					
					SELECT k.NOMOR, IF(rk.KELAS IS NULL, -1, IF(k.TITIPAN = 1, k.TITIPAN_KELAS, rk.KELAS))
					  INTO VKUNJUNGAN_TMP, VKELAS
					  FROM pendaftaran.kunjungan k
					       LEFT JOIN master.ruang_kamar_tidur rkt ON rkt.ID = k.RUANG_KAMAR_TIDUR
					 		 LEFT JOIN master.ruang_kamar rk ON rk.ID = rkt.RUANG_KAMAR
					 WHERE k.NOPEN = VPENDAFTARAN			   
					   AND k.REF IS NULL
					   AND NOT k.`STATUS` = 0;
					
					IF NOT VKELAS IS NULL THEN
						IF VKELAS < 0 THEN			
							SET VKELAS = pembayaran.getKelasRJMengikutiKelasRIYgPertama(PTAGIHAN, VKUNJUNGAN_TMP);
							IF VKELAS < 0 THEN
								SET VKELAS = 0;
							END IF;
						END IF;
					END IF;
					
					CALL pembayaran.storeRincianTagihan(PTAGIHAN, VKARCIS, 1, VTARIF_ID, 1, VTARIF, VKELAS, 0, 0);
				END IF;
			END LOOP;
			CLOSE CR_TAGIHAN_PENDAFTARAN;
		END;
				
		BEGIN			
			DECLARE DATA_NOT_FOUND TINYINT DEFAULT FALSE;
			DECLARE CR_TAGIHAN_PENDAFTARAN CURSOR FOR
				SELECT PENDAFTARAN
				  FROM pembayaran.tagihan_pendaftaran
				 WHERE TAGIHAN = PTAGIHAN
				   AND STATUS = 1;
			DECLARE CONTINUE HANDLER FOR NOT FOUND SET DATA_NOT_FOUND = TRUE;
			
			OPEN CR_TAGIHAN_PENDAFTARAN;
			EOF: LOOP
				FETCH CR_TAGIHAN_PENDAFTARAN INTO VPENDAFTARAN;
				
				IF DATA_NOT_FOUND THEN
					UPDATE temp.temp SET ID = 0 WHERE ID = 0;
					LEAVE EOF;
				END IF;
								
				BEGIN					
					DECLARE VKUNJUNGAN CHAR(19);
					DECLARE VJENIS_KUNJUNGAN TINYINT;
					DECLARE KUNJUNGAN_NOT_FOUND TINYINT DEFAULT FALSE;
					DECLARE CR_KUNJUNGAN CURSOR FOR					
						SELECT k.NOMOR, r.JENIS_KUNJUNGAN
						  FROM pendaftaran.pendaftaran p,
						  		 pendaftaran.kunjungan k,
						  		 master.ruangan r
						 WHERE k.NOPEN = p.NOMOR
						   AND k.`STATUS` > 0
						   AND r.ID = k.RUANGAN
						   AND p.NOMOR = VPENDAFTARAN;
					DECLARE CONTINUE HANDLER FOR NOT FOUND SET KUNJUNGAN_NOT_FOUND = TRUE;
					
					OPEN CR_KUNJUNGAN;
					EOF_KUNJUNGAN: LOOP
						FETCH CR_KUNJUNGAN INTO VKUNJUNGAN, VJENIS_KUNJUNGAN;						
						
						IF KUNJUNGAN_NOT_FOUND THEN
							UPDATE temp.temp SET ID = 0 WHERE ID = 0;
							LEAVE EOF_KUNJUNGAN;
						END IF;
												
						IF VJENIS_KUNJUNGAN = 3 THEN							
							CALL pembayaran.storeAkomodasi(VKUNJUNGAN);
						END IF;					
												
						BEGIN							
							DECLARE VTINDAKAN_MEDIS CHAR(11);
							DECLARE VTINDAKAN SMALLINT;
							DECLARE TINDAKAN_MEDIS_NOT_FOUND TINYINT DEFAULT FALSE;							
							DECLARE CR_TINDAKAN_MEDIS CURSOR FOR
								SELECT ID, TINDAKAN
								  FROM layanan.tindakan_medis tm
								 WHERE tm.KUNJUNGAN = VKUNJUNGAN
								   AND tm.`STATUS` > 0;
							DECLARE CONTINUE HANDLER FOR NOT FOUND SET TINDAKAN_MEDIS_NOT_FOUND = TRUE;
							
							OPEN CR_TINDAKAN_MEDIS;
							TINDAKAN_MEDIS_EOF: LOOP
								FETCH CR_TINDAKAN_MEDIS INTO VTINDAKAN_MEDIS, VTINDAKAN;
								
								IF TINDAKAN_MEDIS_NOT_FOUND THEN
									UPDATE temp.temp SET ID = 0 WHERE ID = 0;
									LEAVE TINDAKAN_MEDIS_EOF;
								END IF;
								
								CALL pembayaran.storeTindakanMedis(VKUNJUNGAN, VTINDAKAN_MEDIS, VTINDAKAN);
							END LOOP;
							CLOSE CR_TINDAKAN_MEDIS;
						END;
												
						BEGIN
							DECLARE VLAYANAN_FARMASI CHAR(11);
							DECLARE VFARMASI SMALLINT;
							DECLARE VJUMLAH DECIMAL(60,2);
							DECLARE FARMASI_NO_FOUND TINYINT DEFAULT FALSE;						
							DECLARE CR_FARMASI CURSOR FOR
								SELECT f.ID, f.FARMASI, f.JUMLAH - SUM(IF(rf.JUMLAH IS NULL, 0, rf.JUMLAH)) JUMLAH
								  FROM layanan.farmasi f
								  		 LEFT JOIN layanan.retur_farmasi rf ON rf.ID_FARMASI = f.ID
								 WHERE f.KUNJUNGAN = VKUNJUNGAN
								   AND f.`STATUS` = 2 AND f.TINDAKAN_PAKET = 0 
								 GROUP BY ID
								 HAVING JUMLAH > 0;
							DECLARE CONTINUE HANDLER FOR NOT FOUND SET FARMASI_NO_FOUND = TRUE;
								 
							OPEN CR_FARMASI;
							FARMASI_EOF: LOOP
								FETCH CR_FARMASI INTO VLAYANAN_FARMASI, VFARMASI, VJUMLAH;
								
								IF FARMASI_NO_FOUND THEN
									UPDATE temp.temp SET ID = 0 WHERE ID = 0;
									LEAVE FARMASI_EOF;
								END IF;
								
								 CALL pembayaran.storeFarmasi(VKUNJUNGAN, VLAYANAN_FARMASI, VFARMASI, VJUMLAH);
							END LOOP;
							CLOSE CR_FARMASI;
						END;
												
						CALL pembayaran.storeO2(VKUNJUNGAN);
					END LOOP;
					CLOSE CR_KUNJUNGAN;
				END;							
			END LOOP;
			CLOSE CR_TAGIHAN_PENDAFTARAN;		   
		END;
	END IF;
END//
DELIMITER ;

-- membuang struktur untuk procedure pembayaran.storeAdministrasiFarmasi
DROP PROCEDURE IF EXISTS `storeAdministrasiFarmasi`;
DELIMITER //
CREATE PROCEDURE `storeAdministrasiFarmasi`(
	IN `PKUNJUNGAN` CHAR(19)
)
BEGIN
	DECLARE VORDERID CHAR(21);
	DECLARE VRACIKAN TINYINT;
	DECLARE VTAGIHAN CHAR(10);
	DECLARE VNOPEN CHAR(10);
	DECLARE VTARIF_ID INT;
	DECLARE VTARIF INT;
	DECLARE VPAKET SMALLINT DEFAULT NULL;
	DECLARE VQTY DECIMAL(60,2);
	DECLARE VPAKET_DETIL INT DEFAULT 0;
	DECLARE VREF SMALLINT;
	DECLARE VTANGGAL_PENDAFTARAN DATETIME;
	
	SELECT k.REF, k.NOPEN, p.PAKET, p.TANGGAL 
	  INTO VORDERID, VNOPEN, VPAKET, VTANGGAL_PENDAFTARAN
	  FROM pendaftaran.kunjungan k,
	  	    pendaftaran.pendaftaran p,
	  		 `master`.ruangan r
	 WHERE k.NOMOR = PKUNJUNGAN
	 	AND p.NOMOR = k.NOPEN
	   AND r.ID = k.RUANGAN
	   AND r.JENIS_KUNJUNGAN = 11;
	   
	IF NOT VORDERID IS NULL THEN
		SELECT MAX(odr.RACIKAN) INTO VRACIKAN
		  FROM layanan.order_resep oresep,
		  		 layanan.order_detil_resep odr
		 WHERE odr.ORDER_ID = oresep.NOMOR
		   AND oresep.NOMOR = VORDERID;
		 
		IF NOT VRACIKAN IS NULL THEN
			SET VREF = IF(VRACIKAN = 1, 4, 3);
			IF EXISTS(SELECT 1 FROM `master`.administrasi WHERE ID = VREF AND STATUS = 1) THEN
				SET VTAGIHAN = pembayaran.getIdTagihan(VNOPEN);
				IF pembayaran.isFinalTagihan(VTAGIHAN) = 0 THEN
					IF NOT VPAKET IS NULL OR VPAKET > 0 THEN
						CALL master.inPaket(VPAKET, 3, VREF, NULL, VQTY, VPAKET_DETIL);
						
						IF VTAGIHAN != '' AND VPAKET_DETIL > 0 THEN
							CALL pembayaran.storeRincianTagihanPaket(VTAGIHAN, VPAKET_DETIL, PKUNJUNGAN, VTANGGAL_PENDAFTARAN, 1, 1);
						END IF;
					END IF;
						
					IF VTAGIHAN != '' AND VPAKET_DETIL = 0 THEN
						CALL master.getTarifAdministrasi(VREF, 0, VTANGGAL_PENDAFTARAN, VTARIF_ID, VTARIF);
						CALL pembayaran.storeRincianTagihan(VTAGIHAN, PKUNJUNGAN, 1, VTARIF_ID, 1, VTARIF, 0, 0, 0);
					END IF;
				END IF;
			END IF;
		END IF;
	END IF;
END//
DELIMITER ;

-- membuang struktur untuk procedure pembayaran.storeFarmasi
DROP PROCEDURE IF EXISTS `storeFarmasi`;
DELIMITER //
CREATE PROCEDURE `storeFarmasi`(
	IN `PKUNJUNGAN` CHAR(19),
	IN `PLAYANAN_FARMASI` CHAR(11),
	IN `PFARMASI` SMALLINT,
	IN `PJUMLAH` DECIMAL(60,2)
)
BEGIN
	DECLARE VNOPEN CHAR(10);
	DECLARE VTAGIHAN CHAR(10);
	DECLARE VJENIS_KUNJUNGAN TINYINT;
	DECLARE VTARIF_ID INT;
	DECLARE VTARIF DECIMAL(60,2);
	DECLARE VKELAS SMALLINT DEFAULT 0;
	DECLARE VPAKET SMALLINT DEFAULT NULL;
	DECLARE VQTY DECIMAL(60,2) DEFAULT 0;
	DECLARE VPAKET_DETIL INT DEFAULT 0;
	DECLARE VBARANG_RUANGAN BIGINT;
	DECLARE VTANGGAL DATETIME;
	DECLARE VTGL_PENDAFTARAN DATETIME;
	DECLARE VKUNJUNGAN_YG_MERESEP CHAR(19);
	DECLARE VJUMLAH DECIMAL(60,2) DEFAULT 1.0;
	DECLARE VJUMLAH_RINCIAN DECIMAL(60,2) DEFAULT 1.0;
	DECLARE VPENJAMIN SMALLINT;
	
	SELECT k.NOPEN, r.JENIS_KUNJUNGAN, IF(kr.TITIPAN = 1, kr.TITIPAN_KELAS, IF(rk.KELAS IS NULL, 0, rk.KELAS)) KELAS, p.PAKET, k.MASUK, kr.NOMOR, k.MASUK
	  INTO VNOPEN, VJENIS_KUNJUNGAN, VKELAS, VPAKET, VTANGGAL, VKUNJUNGAN_YG_MERESEP, VTGL_PENDAFTARAN
	  FROM pendaftaran.kunjungan k
	  		 LEFT JOIN layanan.order_resep ores ON ores.NOMOR = k.REF
	  		 LEFT JOIN pendaftaran.kunjungan kr ON kr.NOMOR = ores.KUNJUNGAN
	  		 LEFT JOIN master.ruang_kamar_tidur rkt ON rkt.ID = kr.RUANG_KAMAR_TIDUR
			 LEFT JOIN master.ruang_kamar rk ON rk.ID = rkt.RUANG_KAMAR,
	  		 master.ruangan r,
	  		 pendaftaran.pendaftaran p
	 WHERE k.RUANGAN = r.ID
	   AND k.NOMOR = PKUNJUNGAN
		AND k.NOPEN = p.NOMOR
		AND k.`STATUS` = 2
	 LIMIT 1;
	
	IF NOT VNOPEN IS NULL THEN
		SET VTAGIHAN = pembayaran.getIdTagihan(VNOPEN);
		
		SET VJUMLAH = pembayaran.getJumlahItemRincianPaket(VTAGIHAN, PFARMASI, 2) + PJUMLAH;
				
		SELECT pt.PENJAMIN INTO VPENJAMIN
		  FROM pembayaran.penjamin_tagihan pt 
		 WHERE pt.TAGIHAN = VTAGIHAN
		   AND pt.KE = 1
		 LIMIT 1;
		 
		IF VPENJAMIN IS NULL THEN
			SET VPENJAMIN = 1; 
		END IF;
		
		IF pembayaran.isFinalTagihan(VTAGIHAN) = 0 THEN
		BEGIN
			DECLARE VSISA_PAKET DECIMAL(60,2) DEFAULT 0;
			DECLARE VSISA DECIMAL(60,2) DEFAULT 0;
			
			SET VSISA = PJUMLAH;
			
			IF NOT VPAKET IS NULL OR VPAKET > 0 THEN
				CALL master.inPaket(VPAKET, 2, PFARMASI, NULL, VQTY, VPAKET_DETIL);
				IF VJUMLAH < VQTY THEN
					SET VSISA_PAKET = PJUMLAH;
					SET VSISA = 0;
				ELSE
					SET VSISA_PAKET = PJUMLAH - (VJUMLAH - VQTY);					
					IF VSISA_PAKET > 0 THEN
						SET VSISA = PJUMLAH - VSISA_PAKET;
					END IF;					
				END IF;	
				
				IF VTAGIHAN != '' AND VPAKET_DETIL > 0 AND VSISA_PAKET > 0 THEN
					CALL pembayaran.storeRincianTagihanPaket(VTAGIHAN, VPAKET_DETIL, PLAYANAN_FARMASI, VTANGGAL, VSISA_PAKET, 1);
				END IF;
			END IF;
			
			IF VTAGIHAN != '' AND (VPAKET_DETIL = 0 OR VSISA > 0) THEN
			BEGIN
				DECLARE VKELAS_SBLM SMALLINT;
				DECLARE VKATEGORI CHAR(10);
				
				SELECT b.KATEGORI INTO VKATEGORI
				  FROM inventory.barang b
				 WHERE b.ID = PFARMASI;
								
				CALL inventory.getHargaBarang(PFARMASI, VTARIF_ID, VTARIF, VTGL_PENDAFTARAN);
								
				SET VKELAS_SBLM = pembayaran.getKelasRJMengikutiKelasRIYgPertama(VTAGIHAN, VKUNJUNGAN_YG_MERESEP);
				IF VKELAS_SBLM > 0 THEN
					SET VKELAS = VKELAS_SBLM;
				END IF;
				
				IF NOT VKATEGORI IS NULL THEN
					IF LEFT(VKATEGORI, 3) IN ('101', '102') THEN
						SET VTARIF = master.getTarifMarginPenjaminFarmasi(VPENJAMIN, 1, VTARIF, VTGL_PENDAFTARAN);
						SET VTARIF = master.getTarifFarmasiPerKelas(VKELAS, VTARIF);
					END IF;
				END IF;
				
				CALL pembayaran.storeRincianTagihan(VTAGIHAN, PLAYANAN_FARMASI, 4, VTARIF_ID, VSISA, VTARIF, VKELAS, 0, 0);		
			END;
			END IF;
		END;
		END IF;	
	END IF;
END//
DELIMITER ;

-- membuang struktur untuk procedure pembayaran.storeO2
DROP PROCEDURE IF EXISTS `storeO2`;
DELIMITER //
CREATE PROCEDURE `storeO2`(
	IN `PKUNJUNGAN` CHAR(19)
)
BEGIN
	DECLARE VNOPEN CHAR(10);
	DECLARE VTAGIHAN CHAR(10);
	DECLARE VJENIS_KUNJUNGAN TINYINT;
	DECLARE VTARIF_ID INT;
	DECLARE VTARIF DECIMAL(60,2);
	DECLARE VKELAS SMALLINT DEFAULT 0;
	DECLARE VPAKET SMALLINT DEFAULT NULL;
	DECLARE VQTY DECIMAL(60,2) DEFAULT 0;
	DECLARE VPEMAKAIAN DECIMAL(60,2) DEFAULT 0;
	DECLARE VSISA DECIMAL(60,2) DEFAULT 0;
	DECLARE VPAKET_DETIL INT DEFAULT 0;
	DECLARE VTANGGAL_PENDAFTARAN, VTANGGAL_KUNJUNGAN, VTANGGAL DATETIME;

	SELECT k.NOPEN, r.JENIS_KUNJUNGAN, IF(k.TITIPAN = 1, k.TITIPAN_KELAS, IF(rk.KELAS IS NULL, 0, rk.KELAS)) KELAS, p.PAKET, p.TANGGAL, k.MASUK
	  INTO VNOPEN, VJENIS_KUNJUNGAN, VKELAS, VPAKET, VTANGGAL_PENDAFTARAN, VTANGGAL_KUNJUNGAN
	  FROM pendaftaran.kunjungan k
	  		 LEFT JOIN master.ruang_kamar_tidur rkt ON rkt.ID = k.RUANG_KAMAR_TIDUR
			 LEFT JOIN master.ruang_kamar rk ON rk.ID = rkt.RUANG_KAMAR,
	  		 master.ruangan r,
	  		 pendaftaran.pendaftaran p
	 WHERE k.NOMOR = PKUNJUNGAN
	 	AND k.RUANGAN = r.ID	   
		AND k.NOPEN = p.NOMOR;
		
	IF NOT VNOPEN IS NULL THEN
		SET VTANGGAL = VTANGGAL_KUNJUNGAN;
		
		IF EXISTS(SELECT 1
			  FROM aplikasi.properti_config pc
			 WHERE pc.ID = 6
			   AND VALUE = 'TRUE') THEN
			SET VTANGGAL = VTANGGAL_PENDAFTARAN;
		END IF;
		
		SET VPEMAKAIAN = layanan.getTotalPemakaianO2(PKUNJUNGAN);
		SET VSISA = VPEMAKAIAN;
		SET VTAGIHAN = pembayaran.getIdTagihan(VNOPEN);		
		IF pembayaran.isFinalTagihan(VTAGIHAN) = 0 THEN
			IF NOT VPAKET IS NULL OR VPAKET > 0 THEN
				CALL master.inPaket(VPAKET, 4, 0, NULL, VQTY, VPAKET_DETIL);
				
				SET VSISA = VPEMAKAIAN - VQTY;
				IF VSISA <= 0 AND EXISTS(
					SELECT 1
					  FROM pembayaran.rincian_tagihan rt
					 WHERE rt.TAGIHAN = VTAGIHAN
					   AND rt.REF_ID = PKUNJUNGAN
					   AND rt.JENIS = 6) THEN
					
					CALL pembayaran.batalRincianTagihan(VTAGIHAN, PKUNJUNGAN, 6);
				ELSE
					UPDATE temp.temp SET ID = 0 WHERE ID = 0;
				END IF;
				
				IF VTAGIHAN != '' AND VPAKET_DETIL > 0 AND VPEMAKAIAN > 0 AND VQTY > 0 THEN
					CALL pembayaran.storeRincianTagihanPaket(VTAGIHAN, VPAKET_DETIL, PKUNJUNGAN, VTANGGAL, VPEMAKAIAN, 1);
				END IF;
			END IF;						 
			
			IF VTAGIHAN != '' AND VSISA > 0.0 THEN
			BEGIN
				DECLARE VKELAS_SBLM SMALLINT;								
				
				CALL master.getTarifO2(VTANGGAL, VTARIF_ID, VTARIF);
				
				SET VKELAS_SBLM = pembayaran.getKelasRJMengikutiKelasRIYgPertama(VTAGIHAN, PKUNJUNGAN);
				IF VKELAS_SBLM > 0 THEN
					SET VKELAS = VKELAS_SBLM;
				END IF;
				
				CALL pembayaran.storeRincianTagihan(VTAGIHAN, PKUNJUNGAN, 6, VTARIF_ID, VSISA, VTARIF, VKELAS, 0, 0);						
			END;
			END IF;
		END IF;	
	ELSE
		UPDATE temp.temp SET ID = 0 WHERE ID = 0;
	END IF;
END//
DELIMITER ;

-- membuang struktur untuk procedure pembayaran.storeTindakanMedis
DROP PROCEDURE IF EXISTS `storeTindakanMedis`;
DELIMITER //
CREATE PROCEDURE `storeTindakanMedis`(
	IN `PKUNJUNGAN` CHAR(19),
	IN `PTINDAKAN_MEDIS` CHAR(11),
	IN `PTINDAKAN` SMALLINT
)
BEGIN
	DECLARE VNOPEN, VTAGIHAN, VRUANGAN CHAR(10);
	DECLARE VJENIS_KUNJUNGAN TINYINT;
	DECLARE VTARIF_ID INT;
	DECLARE VTARIF INT;
	DECLARE VKELAS SMALLINT DEFAULT 0;
	DECLARE VPAKET SMALLINT DEFAULT FALSE;
	DECLARE VQTY DECIMAL(60,2) DEFAULT 0.0;
	DECLARE VPAKET_DETIL INT DEFAULT 0;
	DECLARE VJUMLAH DECIMAL(60,2) DEFAULT 1.0;
	DECLARE VREF CHAR(21);
	DECLARE VTANGGAL_PENDAFTARAN, VTANGGAL_TINDAKAN, VTANGGAL DATETIME;
	
	SELECT k.NOPEN, r.JENIS_KUNJUNGAN, IF(r.JENIS_KUNJUNGAN = 3, IF(k.TITIPAN = 1, k.TITIPAN_KELAS, IF(rk.KELAS IS NULL, 0, rk.KELAS))
			 , IF(rkls.KELAS IS NULL, 0, rkls.KELAS)) KELAS
			 , p.PAKET, k.REF, p.TANGGAL, tm.TANGGAL, k.RUANGAN
	  INTO VNOPEN, VJENIS_KUNJUNGAN, VKELAS
	       , VPAKET, VREF, VTANGGAL_PENDAFTARAN, VTANGGAL_TINDAKAN, VRUANGAN
	  FROM layanan.tindakan_medis tm,
	  		 pendaftaran.kunjungan k
	  		 LEFT JOIN master.ruang_kamar_tidur rkt ON rkt.ID = k.RUANG_KAMAR_TIDUR
			 LEFT JOIN master.ruang_kamar rk ON rk.ID = rkt.RUANG_KAMAR,
	  		 master.ruangan r
			 LEFT JOIN master.ruangan_kelas rkls ON rkls.RUANGAN = r.ID AND rkls.`STATUS` = 1,
	  		 pendaftaran.pendaftaran p
	 WHERE tm.ID = PTINDAKAN_MEDIS
	   AND k.NOMOR = PKUNJUNGAN
	 	AND k.NOMOR = tm.KUNJUNGAN	 	
	 	AND k.RUANGAN = r.ID
		AND k.NOPEN = p.NOMOR
	  LIMIT 1;
	
	IF NOT VNOPEN IS NULL THEN
		SET VTANGGAL = VTANGGAL_TINDAKAN;
		
		IF EXISTS(SELECT 1
			  FROM aplikasi.properti_config pc
			 WHERE pc.ID = 6
			   AND VALUE = 'TRUE') THEN
			SET VTANGGAL = VTANGGAL_PENDAFTARAN;
		END IF;
									
		SET VTAGIHAN = pembayaran.getIdTagihan(VNOPEN);
		SET VJUMLAH = pembayaran.getJumlahItemRincianPaket(VTAGIHAN, PTINDAKAN, 1) + 1;
		
		IF NOT (VJENIS_KUNJUNGAN = 3 AND NOT VREF IS NULL) THEN
			BEGIN
				DECLARE VKUNJUNGAN CHAR(19);
				DECLARE VKELAS_SBLM TINYINT;
				
				SELECT r.KUNJUNGAN INTO VKUNJUNGAN
				  FROM (
					SELECT k.KUNJUNGAN
					  FROM pendaftaran.konsul k
					 WHERE k.NOMOR = VREF
					 UNION
					SELECT ol.KUNJUNGAN
					  FROM layanan.order_lab ol
					 WHERE ol.NOMOR = VREF
					 UNION
					SELECT ora.KUNJUNGAN
					  FROM layanan.order_rad ora
					 WHERE ora.NOMOR = VREF
					) r;
					
				IF VJENIS_KUNJUNGAN = 2 THEN
					SET VKUNJUNGAN = PKUNJUNGAN;
				END IF;
				
				IF NOT VKUNJUNGAN IS NULL OR VJENIS_KUNJUNGAN = 2 THEN
					IF EXISTS(SELECT 1
						  FROM aplikasi.properti_config pc
						 WHERE pc.ID = 7
						   AND VALUE = 'TRUE') THEN
						SELECT IF(rk.KELAS IS NULL, 0, rk.KELAS) KELAS
						  INTO VKELAS_SBLM
						  FROM pendaftaran.kunjungan k
						  		 LEFT JOIN master.ruang_kamar_tidur rkt ON rkt.ID = k.RUANG_KAMAR_TIDUR
								 LEFT JOIN master.ruang_kamar rk ON rk.ID = rkt.RUANG_KAMAR 
						 WHERE k.NOMOR = VKUNJUNGAN
							AND k.RUANG_KAMAR_TIDUR > 0
							AND NOT k.`STATUS` = 0;
							
						IF NOT VKELAS_SBLM IS NULL THEN
							IF VKELAS_SBLM > 0 THEN
								SET VKELAS = VKELAS_SBLM;
							END IF;
						END IF;
					END IF;
					
					SET VKELAS_SBLM = pembayaran.getKelasRJMengikutiKelasRIYgPertama(VTAGIHAN, VKUNJUNGAN);
					IF VKELAS_SBLM > 0 THEN
						SET VKELAS = VKELAS_SBLM;
					END IF;
				END IF;
			END;
		END IF;		
				
		IF pembayaran.isFinalTagihan(VTAGIHAN) = 0 THEN
			IF NOT VPAKET IS NULL OR VPAKET > 0 THEN
				CALL master.inPaket(VPAKET, 1, PTINDAKAN, VRUANGAN, VQTY, VPAKET_DETIL);
				#SELECT VPAKET, PTINDAKAN, VRUANGAN, VQTY, VPAKET_DETIL, VJUMLAH;
				IF VTAGIHAN != '' AND VPAKET_DETIL > 0 AND VJUMLAH <= VQTY THEN
					CALL pembayaran.storeRincianTagihanPaket(VTAGIHAN, VPAKET_DETIL, PTINDAKAN_MEDIS, VTANGGAL, 1, 1);
				END IF;
			END IF;
			
			IF VTAGIHAN != '' AND (VPAKET_DETIL = 0 OR VJUMLAH > VQTY) THEN			
				CALL master.getTarifTindakan(PTINDAKAN, VKELAS, VTANGGAL, VTARIF_ID, VTARIF);
				CALL pembayaran.storeRincianTagihan(VTAGIHAN, PTINDAKAN_MEDIS, 3, VTARIF_ID, 1, VTARIF, VKELAS, 0, 0);
			END IF;
		END IF;
	END IF;
END//
DELIMITER ;

/*!40103 SET TIME_ZONE=IFNULL(@OLD_TIME_ZONE, 'system') */;
/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, '') */;
/*!40014 SET FOREIGN_KEY_CHECKS=IFNULL(@OLD_FOREIGN_KEY_CHECKS, 1) */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40111 SET SQL_NOTES=IFNULL(@OLD_SQL_NOTES, 1) */;
