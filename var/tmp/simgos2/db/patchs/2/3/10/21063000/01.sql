USE pendaftaran;

DROP TRIGGER IF EXISTS `onAfterUpdateKunjungan`;
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `onAfterUpdateKunjungan` AFTER UPDATE ON `kunjungan` FOR EACH ROW BEGIN
	DECLARE VTAGIHAN CHAR(10);
	DECLARE VJENIS_PEMBATALAN TINYINT;
	
	SELECT JENIS INTO VJENIS_PEMBATALAN 
	  FROM pembatalan.pembatalan_kunjungan
	 WHERE KUNJUNGAN = OLD.NOMOR
	 ORDER BY TANGGAL DESC LIMIT 1;
	 
	IF FOUND_ROWS() = 0 THEN
		SET VJENIS_PEMBATALAN = 0;
	END IF;
	
	IF pendaftaran.ikutRawatInapIbu(NEW.NOPEN, NEW.REF) = 0 THEN
		IF NEW.RUANG_KAMAR_TIDUR > 0 AND (OLD.STATUS != NEW.STATUS AND (NEW.STATUS = 0 OR NEW.STATUS = 2)) THEN
			IF NOT VJENIS_PEMBATALAN = 1 THEN
				IF VJENIS_PEMBATALAN = 0 THEN
					UPDATE master.ruang_kamar_tidur SET STATUS = 1 WHERE ID = NEW.RUANG_KAMAR_TIDUR;
				ELSE
					IF NOT EXISTS(SELECT 1 FROM pendaftaran.kunjungan k WHERE (NOT k.NOMOR = OLD.NOMOR) AND k.RUANG_KAMAR_TIDUR = NEW.RUANG_KAMAR_TIDUR AND k.STATUS = 1 LIMIT 1) THEN
						UPDATE master.ruang_kamar_tidur SET STATUS = 1 WHERE ID = NEW.RUANG_KAMAR_TIDUR;
					END IF;
				END IF;
			END IF;
		ELSEIF NEW.RUANG_KAMAR_TIDUR > 0 AND (OLD.STATUS != NEW.STATUS AND NEW.STATUS = 1) THEN		
			IF VJENIS_PEMBATALAN = 2 THEN
				UPDATE master.ruang_kamar_tidur SET STATUS = 3 WHERE ID = NEW.RUANG_KAMAR_TIDUR;
			END IF;
		END IF;
	END IF;
	
	
	SET VTAGIHAN = pembayaran.getIdTagihan(OLD.NOPEN);
			   
	
	IF master.isRawatInap(OLD.RUANGAN) THEN
		
		IF (NOT NEW.KELUAR IS NULL AND
			NEW.STATUS != OLD.STATUS AND NEW.STATUS = 2) OR OLD.MASUK != NEW.MASUK THEN
			CALL pembayaran.storeAkomodasi(NEW.NOMOR);
		END IF;
		
		IF NEW.STATUS != OLD.STATUS AND NEW.STATUS = 0 THEN
			IF (NEW.RUANG_KAMAR_TIDUR > 0 OR NOT NEW.RUANG_KAMAR_TIDUR IS NULL) AND NOT NEW.REF IS NULL THEN
				UPDATE pendaftaran.mutasi
				   SET STATUS = 0
				 WHERE NOMOR = NEW.REF;
			END IF;
		END IF;
	ELSE
		BEGIN
			DECLARE VJENIS_KUNJUNGAN TINYINT;
			SELECT JENIS_KUNJUNGAN INTO VJENIS_KUNJUNGAN
			  FROM master.ruangan
			 WHERE ID = OLD.RUANGAN;
			
			IF FOUND_ROWS() = 0 THEN
				SET VJENIS_KUNJUNGAN = 1;
			END IF;
			 
			IF NEW.STATUS != OLD.STATUS AND VJENIS_KUNJUNGAN = 11 THEN
				IF NEW.STATUS = 2 THEN
					CALL pembayaran.storeAdministrasiFarmasi(OLD.NOMOR);
					CALL layanan.finalPelayananFarmasi(OLD.NOMOR);
				ELSEIF NEW.STATUS = 1 THEN
					IF pembayaran.isFinalTagihan(VTAGIHAN) = 0 THEN
						CALL pembayaran.batalRincianTagihan(VTAGIHAN, OLD.NOMOR, 1);
						CALL layanan.batalFinalPelayananFarmasi(OLD.NOMOR);
					END IF;
				END IF;
			END IF;
		END;
	END IF;
	
	IF NEW.STATUS != OLD.STATUS AND NEW.STATUS = 0 THEN
		IF NEW.REF IS NULL THEN
			UPDATE pendaftaran.tujuan_pasien
			   SET STATUS = 1
			 WHERE NOPEN = OLD.NOPEN
			   AND STATUS = 2;
		ELSE
		BEGIN
			DECLARE VID VARCHAR(2);
			SET VID = LEFT(NEW.REF, 2);
			
			CASE VID
				WHEN '10' THEN
					UPDATE pendaftaran.konsul
					   SET STATUS = 0
					 WHERE NOMOR = NEW.REF
					   AND STATUS = 2;
				 WHEN '11' THEN 
					UPDATE pendaftaran.mutasi
					   SET STATUS = 0
					 WHERE NOMOR = NEW.REF
					   AND STATUS = 2;
				WHEN '12' THEN
					UPDATE layanan.order_lab
					   SET STATUS = 0
					 WHERE NOMOR = NEW.REF
					   AND STATUS = 2;
				WHEN '13' THEN
					UPDATE layanan.order_rad
					   SET STATUS = 0
					 WHERE NOMOR = NEW.REF
					   AND STATUS = 2;
				WHEN '14' THEN
					UPDATE layanan.order_resep
					   SET STATUS = 0
					 WHERE NOMOR = NEW.REF
					   AND STATUS = 2;
			END CASE;
		END;
		END IF;
	END IF;
	
	
	IF	(NEW.MASUK != OLD.MASUK) OR (NEW.KELUAR != OLD.KELUAR) THEN
		BEGIN
			DECLARE VJENIS TINYINT DEFAULT 1;
			IF NEW.KELUAR != OLD.KELUAR THEN
				SET VJENIS = 2;
			END IF;
	 		IF EXISTS(SELECT 1 FROM pendaftaran.perubahan_tanggal_kunjungan WHERE KUNJUNGAN = OLD.NOMOR AND JENIS = VJENIS AND STATUS = 1) THEN				
				UPDATE pendaftaran.perubahan_tanggal_kunjungan
				   SET STATUS = 2
				 WHERE KUNJUNGAN = OLD.NOMOR
				   AND JENIS = VJENIS
				   AND STATUS = 1;
			END IF;	
		END;
	END IF;
	
	/*UPDATE DPJP DI TUJUAN PASIEN*/
	IF OLD.DPJP != NEW.DPJP AND OLD.REF IS NULL THEN
		UPDATE tujuan_pasien SET DOKTER = NEW.DPJP WHERE NOPEN = OLD.NOPEN;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;