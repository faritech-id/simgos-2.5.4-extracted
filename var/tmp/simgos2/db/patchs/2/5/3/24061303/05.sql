USE `layanan`;

-- Dumping structure for procedure layanan.CetakHasilKepekaan
DROP PROCEDURE IF EXISTS `CetakHasilKepekaan`;
DELIMITER //
CREATE PROCEDURE `CetakHasilKepekaan`(
	IN `PKUNJUNGAN` CHAR(19)
)
BEGIN
	DROP TEMPORARY TABLE IF EXISTS TEMP_DATA_KEPEKAAN_KIRI;
	DROP TEMPORARY TABLE IF EXISTS TEMP_DATA_KEPEKAAN_KANAN;
	
	SET @brs1:=0;
	SET @brs2:=0;
	SET @brs3:=0;
	SET @brs4:=0;
	SET @id:=0;
	SET @id2:=0;
	SET @id3:=0;
	SET @id4:=0;
	
	CREATE TEMPORARY TABLE TEMP_DATA_KEPEKAAN_KIRI ENGINE=MEMORY
   SELECT IF(CONCAT(IDBAKTERI,BRS) = CONCAT(IDBAKTERI,JUMLAH+1), @brs4:=1, IF(@id2 != IDBAKTERI, @brs4:=1, @brs4:=@brs4+1)) BRS2
			 , @id2:=IDBAKTERI, cd.BRS, cd.KUNJUNGAN, cd.IDBAKTERI, cd.BAKTERI, cd.ANTIBIOTIK, cd.HASIL, cd.JUMLAH
			 , IF(LEFT(UPPER(LTRIM(cd.HASIL)),1) = 'R', 1, 0) STS
	  FROM (SELECT IF(@id != ab.IDBAKTERI, @brs3:=1, @brs3:=@brs3+1) BRS
	  				   , @id:=ab.IDBAKTERI, ab.KUNJUNGAN, ab.IDBAKTERI, ab.BAKTERI, ab.ANTIBIOTIK, ab.HASIL
	   				, JUMLAH JUMLAH
	  		    FROM (SELECT lk.KUNJUNGAN,lk.BAKTERI IDBAKTERI, bk.DESKRIPSI BAKTERI, an.DESKRIPSI ANTIBIOTIK, lk.HASIL
								  , ROUND((SELECT COUNT(*) FROM layanan.hasil_lab_kepekaan lk1 WHERE lk1.KUNJUNGAN=lk.KUNJUNGAN AND lk1.BAKTERI=lk.BAKTERI AND lk.`STATUS`!=0)/2) JUMLAH
						   FROM layanan.hasil_lab_kepekaan lk
		      				  LEFT JOIN master.referensi bk ON lk.BAKTERI=bk.ID AND bk.JENIS=129
			   				  LEFT JOIN master.referensi an ON lk.ANTIBIOTIK=an.ID AND an.JENIS=128
						  WHERE lk.KUNJUNGAN=PKUNJUNGAN AND lk.`STATUS` != 0
						  ORDER BY lk.BAKTERI,lk.ANTIBIOTIK
	  		  ) ab
	  ) cd
	 WHERE BRS <= JUMLAH;
	
   CREATE TEMPORARY TABLE TEMP_DATA_KEPEKAAN_KANAN ENGINE=MEMORY
   SELECT IF(CONCAT(IDBAKTERI,BRS) = CONCAT(IDBAKTERI,JUMLAH+1), @brs2:=1, IF(@id4 != IDBAKTERI, @brs2:=1, @brs2:=@brs2+1)) BRS2
	 		 , @id4:=IDBAKTERI, cd.BRS, cd.KUNJUNGAN, cd.IDBAKTERI, cd.BAKTERI, cd.ANTIBIOTIK, cd.HASIL, cd.JUMLAH
			 , IF(LEFT(UPPER(LTRIM(cd.HASIL)),1) = 'R', 1, 0) STS
	  FROM (SELECT IF(@id3 != ab.IDBAKTERI, @brs1:=1, @brs1:=@brs1+1) BRS
						, @id3:=ab.IDBAKTERI, ab.KUNJUNGAN, ab.IDBAKTERI, ab.BAKTERI, ab.ANTIBIOTIK, ab.HASIL
		   			, JUMLAH JUMLAH
			    FROM (SELECT lk.KUNJUNGAN,lk.BAKTERI IDBAKTERI, bk.DESKRIPSI BAKTERI, an.DESKRIPSI ANTIBIOTIK, lk.HASIL
								  , ROUND((SELECT COUNT(*) FROM layanan.hasil_lab_kepekaan lk1 WHERE lk1.KUNJUNGAN=lk.KUNJUNGAN AND lk1.BAKTERI=lk.BAKTERI AND lk.`STATUS`!=0)/2) JUMLAH
						   FROM layanan.hasil_lab_kepekaan lk
		      				  LEFT JOIN master.referensi bk ON lk.BAKTERI=bk.ID AND bk.JENIS=129
			   				  LEFT JOIN master.referensi an ON lk.ANTIBIOTIK=an.ID AND an.JENIS=128
						  WHERE lk.KUNJUNGAN=PKUNJUNGAN AND lk.`STATUS` != 0
					     ORDER BY lk.BAKTERI,lk.ANTIBIOTIK
	  		    ) ab
	  ) cd
	WHERE BRS > JUMLAH;
	 
  SELECT kr.KUNJUNGAN, kr.BRS, kr.IDBAKTERI, kr.BAKTERI BAKTERI_KR, kr.ANTIBIOTIK ANTIBIOTIK_KR, kr.HASIL HASIL_KR
         , BRS_KN, BAKTERI1, ANTIBIOTIK_KN, HASIL_KN, IFNULL(STS,0) STS_KR, IFNULL(STS_KN,0) STS_KN
    FROM TEMP_DATA_KEPEKAAN_KIRI kr
  		   LEFT JOIN (
				SELECT kn.BRS2, kn.IDBAKTERI, kn.KUNJUNGAN KUNJUNGAN1, kn.BRS BRS_KN, kn.BAKTERI BAKTERI1, kn.ANTIBIOTIK ANTIBIOTIK_KN, kn.HASIL HASIL_KN, STS STS_KN
				  FROM TEMP_DATA_KEPEKAAN_KANAN kn
			) gf ON gf.BRS2=kr.BRS2 AND gf.IDBAKTERI=kr.IDBAKTERI
  ORDER BY kr.IDBAKTERI, kr.BRS;	 	
END//
DELIMITER ;