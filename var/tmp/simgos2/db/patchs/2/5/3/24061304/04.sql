USE `medicalrecord`;

-- Dumping structure for procedure medicalrecord.CetakBarthelIndex
DROP PROCEDURE IF EXISTS `CetakBarthelIndex`;
DELIMITER //
CREATE PROCEDURE `CetakBarthelIndex`(
	IN `PNOPEN` CHAR(10)
)
BEGIN 	
	SET @brs=0;
SELECT @brs:=@brs+1 BARIS, NORM, NAMA_PASIEN, TANGGAL_LAHIR, JENIS_KELAMIN, KUNJUNGAN, RUANGAN, PENDAFTARAN
		, IF(@brs=1, 'Sebelum Sakit', IF(@brs=2, 'Saat Masuk RS', DATE_FORMAT(TANGGAL,'%d-%m-%Y'))) TANGGAL
		, KENDALI_RANGSANG_DEFEKASI, KET_KENDALI_RANGSANG_DEFEKASI
		, KENDALI_RANGSANG_KEMIH, KET_KENDALI_RANGSANG_KEMIH
		, BERSIH_DIRI, KET_BERSIH_DIRI
		, PENGGUNAAN_JAMBAN, KET_PENGGUNAAN_JAMBAN
		, MAKAN, KET_MAKAN
		, PERUBAHAN_SIKAP, KET_PERUBAHAN_SIKAP
		, PINDAH_JALAN, KET_PINDAH_JALAN
		, PAKAI_BAJU, KET_PAKAI_BAJU
		, NAIK_TURUN_TANGGA, KET_NAIK_TURUN_TANGGA
		, MANDI, KET_MANDI
		, @TOTAL:=(KENDALI_RANGSANG_DEFEKASI+KENDALI_RANGSANG_KEMIH+BERSIH_DIRI+PENGGUNAAN_JAMBAN+MAKAN+PERUBAHAN_SIKAP+PINDAH_JALAN+PAKAI_BAJU+NAIK_TURUN_TANGGA+MANDI) TOTAL
		, IF(@TOTAL>125,'Mandiri',IF(@TOTAL>64,'Ketergantungan sebagian','Ketergantungan Total')) KETERANGAN
		, PETUGAS, IDPETUGAS
	FROM (
SELECT p.NORM, `master`.getNamaLengkap(pd.NORM) NAMA_PASIEN, p.TANGGAL_LAHIR, IF(p.JENIS_KELAMIN=1,'Laki-Laki','Perempuan') JENIS_KELAMIN
		, bi.KUNJUNGAN, r.DESKRIPSI RUANGAN, bi.PENDAFTARAN
	   ,  DATE_FORMAT(bi.TANGGAL,'%d-%m-%Y') TANGGAL
		,  IFNULL(krd.SCORING,0) KENDALI_RANGSANG_DEFEKASI
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=232) KET_KENDALI_RANGSANG_DEFEKASI
		, IFNULL(krk.SCORING,0) KENDALI_RANGSANG_KEMIH
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=233) KET_KENDALI_RANGSANG_KEMIH
		, IFNULL(bd.SCORING,0) BERSIH_DIRI
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=234) KET_BERSIH_DIRI
		, IFNULL(pj.SCORING,0) PENGGUNAAN_JAMBAN
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=235) KET_PENGGUNAAN_JAMBAN
		, IFNULL(mk.SCORING,0) MAKAN
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=236) KET_MAKAN
		, IFNULL(ps.SCORING,0) PERUBAHAN_SIKAP
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=237) KET_PERUBAHAN_SIKAP
		, IFNULL(jl.SCORING,0) PINDAH_JALAN
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=238) KET_PINDAH_JALAN
		, IFNULL(pb.SCORING,0) PAKAI_BAJU
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=239) KET_PAKAI_BAJU
		, IFNULL(tr.SCORING,0) NAIK_TURUN_TANGGA
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=239) KET_NAIK_TURUN_TANGGA
		, IFNULL(mn.SCORING,0) MANDI
		, (SELECT REPLACE(GROUP_CONCAT(CONCAT(f.SCORING,'=',f.DESKRIPSI) SEPARATOR ';'),';','\r') FROM `master`.referensi f WHERE f.JENIS=239) KET_MANDI
		, `master`.getNamaLengkapPegawai(pg.NIP) PETUGAS, pg.ID IDPETUGAS
	FROM medicalrecord.penilaian_barthel_index bi
	     LEFT JOIN aplikasi.pengguna pg ON bi.OLEH=pg.ID
	     LEFT JOIN `master`.referensi krd ON krd.JENIS=232 AND bi.KENDALI_RANGSANG_DEFEKASI=krd.ID
	     LEFT JOIN `master`.referensi krk ON krk.JENIS=233 AND bi.KENDALI_RANGSANG_KEMIH=krk.ID
	     LEFT JOIN `master`.referensi bd ON bd.JENIS=234 AND bi.BERSIH_DIRI=bd.ID
	     LEFT JOIN `master`.referensi pj ON pj.JENIS=235 AND bi.PENGGUNAAN_JAMBAN=pj.ID
	     LEFT JOIN `master`.referensi mk ON mk.JENIS=236 AND bi.MAKAN=mk.ID
	     LEFT JOIN `master`.referensi ps ON ps.JENIS=237 AND bi.PERUBAHAN_SIKAP=ps.ID
	     LEFT JOIN `master`.referensi jl ON jl.JENIS=238 AND bi.PINDAH_JALAN=jl.ID
	     LEFT JOIN `master`.referensi pb ON pb.JENIS=239 AND bi.PAKAI_BAJU=pb.ID
	     LEFT JOIN `master`.referensi tr ON tr.JENIS=240 AND bi.NAIK_TURUN_TANGGA=tr.ID 
	     LEFT JOIN `master`.referensi mn ON mn.JENIS=241 AND bi.MANDI=mn.ID
		, pendaftaran.kunjungan k
		, `master`.ruangan r
		, pendaftaran.pendaftaran pd
		, `master`.pasien p
	WHERE pd.NOMOR=PNOPEN AND bi.`STATUS`!=0
	  AND bi.KUNJUNGAN=k.NOMOR AND k.`STATUS`!=0
	  AND k.NOPEN=pd.NOMOR AND pd.`STATUS`!=0
	  AND k.RUANGAN=r.ID AND pd.NORM=p.NORM
	ORDER BY bi.SEBELUM_SAKIT DESC, bi.TANGGAL ASC
) ab;

END//
DELIMITER ;