USE `layanan`;

-- Dumping structure for function pendaftaran.getPendaftaranAsal
DROP PROCEDURE IF EXISTS `layanan`.`storeOrderResepDiFarmasi`;

DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `layanan`.`storeOrderResepDiFarmasi`(IN `PID` CHAR(21), IN `POLEH` SMALLINT
)
BEGIN
	DECLARE DATA_NOT_FOUND INT DEFAULT FALSE;
	DECLARE VIDFARMASI CHAR(11);
	DECLARE VKUNJUNGAN CHAR(19);
	DECLARE VFARMASI, VSTATUSPAKET, VTINDAKAN SMALLINT;
	DECLARE VJUMLAH DECIMAL(6,2);
	DECLARE VATURAN_PAKAI VARCHAR(250);
	DECLARE VKETERANGAN VARCHAR(250);
	DECLARE VRACIKAN TINYINT;
	DECLARE VGROUP_RACIKAN TINYINT;
	DECLARE VPETUNJUK_RACIKAN, VDOSIS VARCHAR(250);
	DECLARE VJUMLAH_RACIKAN DECIMAL(10,0);
	DECLARE VFREKUENSI, VRUTE_PEMBERIAN INT(11);
	
	DECLARE CRDATA CURSOR FOR
		SELECT c.NOMOR, b.FARMASI, b.JUMLAH, b.DOSIS, b.ATURAN_PAKAI, b.KETERANGAN
			, b.RACIKAN, b.GROUP_RACIKAN, b.PETUNJUK_RACIKAN, b.JUMLAH_RACIKAN, b.FREKUENSI, b.RUTE_PEMBERIAN, b.TINDAKAN_PAKET, b.TINDAKAN
		  FROM layanan.order_resep a,		  
		  	 	 layanan.order_detil_resep b,
		  	 	 pendaftaran.kunjungan c
		 WHERE a.NOMOR = PID
		   AND a.STATUS = 2
		   AND a.NOMOR = c.REF
		   AND a.NOMOR = b.ORDER_ID;
		   
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET DATA_NOT_FOUND = TRUE;
	
	OPEN CRDATA;
		DATA_END: LOOP
			FETCH CRDATA INTO VKUNJUNGAN, VFARMASI, VJUMLAH, VDOSIS, VATURAN_PAKAI, VKETERANGAN
				, VRACIKAN, VGROUP_RACIKAN, VPETUNJUK_RACIKAN, VJUMLAH_RACIKAN, VFREKUENSI, VRUTE_PEMBERIAN, VSTATUSPAKET, VTINDAKAN;
		
			IF DATA_NOT_FOUND THEN
				UPDATE temp.temp SET ID = 0 WHERE ID = 0;
				LEAVE DATA_END;
			END IF;	
			
			BEGIN
				SET VIDFARMASI = generator.generateIdFarmasi(DATE(NOW()));
				
				INSERT INTO layanan.farmasi(ID, KUNJUNGAN, FARMASI, JUMLAH, ATURAN_PAKAI, KETERANGAN
					, RACIKAN, GROUP_RACIKAN, PETUNJUK_RACIKAN, JUMLAH_RACIKAN, DOSIS, FREKUENSI, TINDAKAN_PAKET, TINDAKAN , RUTE_PEMBERIAN
					, TANGGAL, OLEH)
					VALUES(VIDFARMASI, VKUNJUNGAN, VFARMASI, VJUMLAH, VATURAN_PAKAI, VKETERANGAN
					, VRACIKAN, VGROUP_RACIKAN, VPETUNJUK_RACIKAN, VJUMLAH_RACIKAN, VDOSIS, VFREKUENSI, VSTATUSPAKET, VTINDAKAN, VRUTE_PEMBERIAN
					, NOW(), POLEH);
					
				UPDATE layanan.order_detil_resep
				   SET REF = VIDFARMASI
				 WHERE ORDER_ID = PID
				   AND FARMASI = VFARMASI
					AND (REF IS NULL OR REF = '');
			END;
		END LOOP;
	CLOSE CRDATA;
END//
DELIMITER ;