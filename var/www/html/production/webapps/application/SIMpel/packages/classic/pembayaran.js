Ext.define("pembayaran.kasir.Model",{extend:"data.model.Model",serviceName:"pembayaran/kasir",fields:[{name:"ID",type:"int"},{name:"NAMA",type:"string"},{name:"NIP",type:"string"}]});Ext.define("pembayaran.kasir.Store",{extend:"data.store.Store",model:"pembayaran.kasir.Model",alias:"store.kasir-store"});Ext.define("pembayaran.pembayarantagihan.Model",{extend:"data.model.Model",serviceName:"pembayaran/pembayarantagihan",fields:[{name:"NOMOR",type:"string"},{name:"TAGIHAN",type:"string"},{name:"JENIS",type:"int"},{name:"JENIS_LAYANAN_ID",type:"int",defaultValue:1},{name:"PENYEDIA_ID",type:"int",allowNull:true},{name:"TANGGAL",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"REKENING_ID",type:"int",allowNull:true},{name:"NO_ID",type:"string",allowNull:true},{name:"NAMA",type:"string",allowNull:true},{name:"REF",type:"string"},{name:"JENIS_KARTU_ID",type:"int",allowNull:true},{name:"BANK_ID",type:"int",allowNull:true},{name:"DESKRIPSI",type:"string"},{name:"BIAYA_ADMIN",type:"float"},{name:"TOTAL",type:"float"},{name:"BRIDGE",type:"int",defaultValue:0},{name:"TRANSAKSI_KASIR_NOMOR",type:"int"},{name:"TANGGAL_DIBUAT",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"BATAS_WAKTU",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"OLEH",type:"int"},{name:"STATUS",type:"int",defaultValue:1}],idProperty:"NOMOR"});Ext.define("pembayaran.pembayarantagihan.Store",{extend:"data.store.Store",model:"pembayaran.pembayarantagihan.Model",alias:"store.pembayaran-pembayarantagihan-store"});Ext.define("pembayaran.penyedia.Model",{extend:"data.model.Model",serviceName:"pembayaran/penyedia",fields:[{name:"ID",type:"int"},{name:"NAMA",type:"string"},{name:"JENIS_PENYEDIA_ID",type:"int"},{name:"REFERENSI_ID",type:"int"},{name:"STATUS_ID",type:"int"}],idProperty:"ID"});Ext.define("pembayaran.penyedia.Store",{extend:"data.store.Store",model:"pembayaran.penyedia.Model",alias:"store.pembayaran-penyedia-store"});Ext.define("pembayaran.penyedia.layanan.Model",{extend:"data.model.Model",serviceName:"pembayaran/layanan-penyedia",fields:[{name:"ID",type:"int"},{name:"PENYEDIA_ID",type:"int"},{name:"JENIS_LAYANAN_ID",type:"int"},{name:"DRIVER",type:"string"},{name:"KODE",type:"string"},{name:"STATUS_ID",type:"int"}],idProperty:"ID"});Ext.define("pembayaran.penyedia.layanan.Store",{extend:"data.store.Store",model:"pembayaran.penyedia.layanan.Model",alias:"store.pembayaran-penyedia-layanan-store"});Ext.define("pembayaran.piutang.pasien.Model",{extend:"data.model.Model",serviceName:"pembayaran/pelunasanpiutang/pasien",fields:[{name:"ID",type:"int"},{name:"TAGIHAN_PIUTANG",type:"string"},{name:"ANGSURAN_KE",type:"int"},{name:"JUMLAH_ANGSURAN_DIBAYAR",type:"int"},{name:"TOTAL_BAYAR",type:"float"},{name:"JENIS_PEMBAYARAN",type:"int"},{name:"OLEH",type:"int"},{name:"STATUS",type:"int"}],idProperty:"ID"});Ext.define("pembayaran.piutang.pasien.Store",{extend:"data.store.Store",model:"pembayaran.piutang.pasien.Model",alias:"store.pembayaran-piutang-pasien-store"});Ext.define("pembayaran.piutang.perusahaan.Model",{extend:"data.model.Model",serviceName:"pembayaran/pelunasanpiutang/perusahaan",fields:[{name:"ID",type:"int"},{name:"TAGIHAN_PIUTANG",type:"string"},{name:"PENJAMIN",type:"int"},{name:"TOTAL_PIUTANG",type:"float"},{name:"TOTAL_BAYAR",type:"float"},{name:"OLEH",type:"int"},{name:"STATUS",type:"int"}],idProperty:"ID"});Ext.define("pembayaran.piutang.perusahaan.Store",{extend:"data.store.Store",model:"pembayaran.piutang.perusahaan.Model",alias:"store.pembayaran-piutang-perusahaan-store"});Ext.define("pembayaran.tagihan.discount.tenagamedis.Model",{extend:"data.model.Model",serviceName:"pembayaran/diskon/tindakantenagamedis",fields:[{name:"ID",type:"string"},{},{name:"STATUS",type:"int",defaultValue:1}],idProperty:"ID"});Ext.define("pembayaran.tagihan.discount.tenagamedis.Store",{extend:"data.store.Store",model:"pembayaran.tagihan.discount.tenagamedis.Model",alias:"store.discount-tenagamedis-store"});Ext.define("pembayaran.tagihan.klaim.Model",{extend:"data.model.Model",serviceName:"pembayaran/tagihan-klaim",fields:[{name:"ID",type:"string"},{name:"TAGIHAN",type:"string"},{name:"NORM",type:"int"},{name:"NOPEN",type:"string"},{name:"MASUK",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"KELUAR",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"TANGGAL_FINAL",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"PENJAMIN",type:"int"},{name:"JENIS",type:"int"},{name:"TOTAL",type:"float"},{name:"STATUS",type:"int"}],idProperty:"ID"});Ext.define("pembayaran.tagihan.klaim.Store",{extend:"data.store.Store",model:"pembayaran.tagihan.klaim.Model",alias:"store.pembayaran-tagihan-klaim-store"});Ext.define("pembayaran.tagihan.nontunai.bank.Model",{extend:"data.model.Model",serviceName:"pembayaran/transfer",fields:[{name:"ID",type:"int"},{name:"TAGIHAN",type:"string"},{name:"BANK_ASAL",type:"int"},{name:"REKENING",type:"int"},{name:"NAMA_PENYETOR",type:"string"},{name:"REF",type:"string"},{name:"TANGGAL_TRANSFER",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"TOTAL",type:"float"},{name:"TANGGAL",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"OLEH",type:"int"},{name:"JENIS",type:"int"},{name:"STATUS",type:"int"}],idProperty:"ID"});Ext.define("pembayaran.tagihan.nontunai.bank.Store",{extend:"data.store.Store",model:"pembayaran.tagihan.nontunai.bank.Model",alias:"store.pembayaran-tagihan-nontunai-bank-store"});Ext.define("pembayaran.tagihan.pembatalan.Model",{extend:"data.model.Model",serviceName:"pembayaran/pembatalantagihan",fields:[{name:"ID",type:"int"},{name:"TAGIHAN",type:"string"},{name:"JENIS",type:"int"},{name:"TANGGAL",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"OLEH",type:"int"},{name:"STATUS",type:"int",defaultValue:1}],idProperty:"ID"});Ext.define("pembayaran.kasir.Combo",{extend:"com.Combo",alias:"widget.kasir-combo",viewModel:{stores:{store:{type:"kasir-store"}}},valueField:"ID",displayField:"NAMA",minChars:2,emptyText:"[Pilih Kasir]",queryMode:"remote",queryParam:"QUERY"});Ext.define("pembayaran.pembayarantagihan.List",{extend:"com.Grid",xtype:"pembayaran-pembayarantagihan-list",viewModel:{stores:{store:{type:"pembayaran-pembayarantagihan-store"}}},hideHeaders:true,initComponent:function(){var a=this;a.columns=[{xtype:"templatecolumn",flex:2,tpl:new Ext.XTemplate("{[this.getContent(values)]}",{getContent:function(m){var k=m.REFERENSI.JENIS_LAYANAN.CONFIG?Ext.JSON.decode(m.REFERENSI.JENIS_LAYANAN.CONFIG):null,g=k?k.content:"No. Content",i=a.getReferensi(m,"PENYEDIA"),c=a.getReferensi(m,"JENIS_KARTU"),h=a.getReferensi(m,"BANK"),n=a.getReferensi(m,"KASIR"),j=a.getReferensi(m,"REKENING"),f=a.getReferensi(m,"TAGIHAN"),l=a.getReferensi(f,"PASIEN"),e=["Dibatalkan","Belum Terbayarkan","Sudah Terbayarkan"],b=["silver","red","green"];g=a.replaceAll(g,"{[values.REF]}",a.ifNull(m.REF));g=a.replaceAll(g,"{[values.NO_ID]}",a.ifNull(m.NO_ID));g=a.replaceAll(g,"{[values.NAMA]}",a.ifNull(m.NAMA));g=a.replaceAll(g,"{[values.TANGGAL]}",a.tanggalFormat(m.TANGGAL));if(i){g=a.replaceAll(g,"{[values.REFERENSI.PENYEDIA.NAMA]}",a.ifNull(i.NAMA))}if(c){g=a.replaceAll(g,"{[values.REFERENSI.JENIS_KARTU.DESKRIPSI]}",a.ifNull(c.DESKRIPSI));g=a.replaceAll(g,"{[values.REFERENSI.JENIS_KARTU.DESKRIPSI]}",a.ifNull(c.DESKRIPSI))}if(h){g=a.replaceAll(g,"{[values.REFERENSI.BANK.DESKRIPSI]}",a.ifNull(h.DESKRIPSI));g=a.replaceAll(g,"{[values.REFERENSI.BANK.DESKRIPSI]}",a.ifNull(h.DESKRIPSI))}if(j){var d=a.getReferensi(j,"BANK");g=a.replaceAll(g,"{[values.REFERENSI.REKENING.NOMOR]}",a.ifNull(j.NOMOR));g=a.replaceAll(g,"{[values.REFERENSI.REKENING.PEMILIK]}",a.ifNull(j.PEMILIK));g=a.replaceAll(g,"{[values.REFERENSI.REKENING.REFERENSI.BANK.DESKRIPSI]}",a.ifNull(d.DESKRIPSI))}if(n){g=a.replaceAll(g,"{[values.REFERENSI.KASIR.NAMA]}",a.ifNull(n.NAMA))}g+=" <span style='font-weight: bold; font-size: 13px; color: "+b[m.STATUS]+"'>Status: "+e[m.STATUS]+"<span/>";return g}})},{xtype:"templatecolumn",flex:1,align:"right",tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 18px; white-space:normal !important;">{[this.getTotal(values)]} </div>',{getTotal:function(c){var b=Number(c.TOTAL);return Ext.util.Format.number(b<0?0:b,"0,000")}})}];a.callParent()},ifNull:function(a,b){return a?a:b},tanggalFormat:function(b){var a=Ext.isDate(b)?b:Ext.Date.parse(b,"Y-m-d H:i:s");return Ext.Date.format(a,"d F Y H:i:s")}});Ext.define("pembayaran.pembayarantagihan.Workspace",{extend:"com.Form",xtype:"pembayaran-pembayarantagihan-workspace",model:"data.model.Tagihan",layout:"fit",bodyPadding:0,items:[{xtype:"pembayaran-pembayarantagihan-list"}],onLoadRecord:function(b,c){var a=b.down("pembayaran-pembayarantagihan-list");a.setParams({TAGIHAN:c.get("ID"),NOT:Ext.JSON.encode({STATUS:[0]})});a.load()}});Ext.define("pembayaran.penerimaan.detail",{extend:"com.Form",alias:"widget.pembayaran-penerimaan-detail",html:"2"});Ext.define("pembayaran.penerimaan.List",{extend:"com.Grid",alias:"widget.pembayaran-penerimaan-list",controller:"pembayaran-penerimaan-list",viewModel:{stores:{store:{type:"tagihan-store"}}},hideHeaders:true,waitRefresh:true,bind:{store:"{store}"},columns:[{xtype:"templatecolumn",flex:1,tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 12px; white-space:normal !important;">Id Transaksi: {[values.ID]} </div>')},{xtype:"widgetcolumn",flex:1,align:"right",widget:{xtype:"panel",items:[{bind:{data:{items:"{store.data.items}"}},tpl:new Ext.XTemplate('<div style="text-align: left; font-size: 12px; white-space:normal !important;">Open : {[this.tanggalFormat(values.TANGGAL)]}</div>','<div style="font-size: 12px; text-align: left;  white-space:normal !important;">Close : {[this.tanggalFormat(values.TANGGAL)]}</div>',{getFormatNorm:function(f){var e=Ext.String.leftPad(f,8,"0"),d=Ext.String.insert(Ext.String.insert(Ext.String.insert(e,".",2),".",5),".",8);return d},tanggalFormat:function(c){var d=Ext.isDate(c)?c:Ext.Date.parse(c,"Y-m-d H:i:s");return Ext.Date.format(d,"d-m-Y H:i:s")}})},{xtype:"button",text:"Detail",handler:"onShowDetail"}]}}],loadStore:function(c){var b=this.getViewModel(),a=b.get("store");if(a){a.removeAll();a.queryParams=a.queryParams||{};if(c){a.queryParams=c}a.load({callback:function(d){if(d){if(d.length>0){b.set("status",d[0].get("STATUS"))}}}})}}});Ext.define("pembayaran.penerimaan.ListController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-penerimaan-list",init:function(){var c=this,d=c.getStore("store");if(d){d.on("load",function(b,a){if(a){if(a.length==0){d.removeAll()}}c.getView().waitRefresh=false})}},onView:function(a){var b=this,c=a.ownerCt.getWidgetRecord();b.getView().fireEvent("viewtagihan",c)},onShowDetail:function(){var a=this;a._onShowDetail=Ext.create("Ext.Window",{closable:true,modal:true,maximizable:true,constrain:this.getView(),header:{height:20,cls:"bgheaderTop"},layout:"fit",minWidth:900,minHeight:400,border:false,items:[{xtype:"pembayaran-penerimaan-detail"}]}).show()}});Ext.define("pembayaran.penerimaan.Workspace",{extend:"com.Form",alias:"widget.pembayaran-penerimaan-Workspace",cls:"shadow-panel",border:true,layout:"border",inRefresh:false,header:{iconCls:"x-fa fa-credit-card",title:"Penerimaan Kasir",margin:0,padding:"5 10 5 10",cls:"x-color-w",layout:{type:"hbox",align:"middle"},items:[{xtype:"component",flex:1},{xtype:"button",iconCls:"x-fa fa-refresh",tooltip:"Refresh",ui:"soft-cyan",margin:"0 0 0 1"}]},items:[{region:"center",reference:"listpenerimaankasir",xtype:"pembayaran-penerimaan-list"}],loadStore:function(b){var a=this.down("[reference=listpenerimaankasir]");a.loadStore({STATUS:1,JENIS:4})},refresh:function(){if(!this.inRefresh){this.getController().init()}}});Ext.define("pembayaran.penjualan.List",{extend:"com.Grid",alias:"widget.pembayaran-penjualan-list",controller:"pembayaran-penjualan-list",viewModel:{data:{listConfig:{history:true}},stores:{store:{type:"tagihan-store"}}},header:{iconCls:"x-fa fa-credit-card",title:"Tagihan Penjualan",margin:0,padding:"5 10 5 10",cls:"x-color-w",layout:{type:"hbox",align:"middle"},items:[{xtype:"component",flex:1},{xtype:"search-field",emptyText:"[NO. TAGIHAN]",listeners:{search:"onSearch",clear:"onClear"}},{xtype:"button",iconCls:"x-fa fa-refresh",tooltip:"Refresh",ui:"soft-cyan",margin:"0 0 0 1",handler:"onRefresh"},{xtype:"button",iconCls:"x-fa fa-history",tooltip:"History Tagihan / Pembayaran",ui:"soft-green",margin:"0 0 0 1",bind:{hidden:"{!listConfig.history}"},handler:"onHistory"}]},hideHeaders:true,waitRefresh:true,initComponent:function(){var a=this;a.columns=[{xtype:"templatecolumn",flex:2,tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 12px; white-space:normal !important;">{[values.ID]} ~ {[this.getReferensi(values, "PENJUALAN", "PENGUNJUNG")]} </div>','<div style="font-size: 12px; white-space:normal !important;">{[this.tanggalFormat(values.TANGGAL)]}</div>')},{xtype:"templatecolumn",flex:1,align:"right",tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 18px; white-space:normal !important;">{[this.numberFormat(values.TOTAL + values.PEMBULATAN)]} </div>')},{xtype:"widgetcolumn",text:"Status",align:"right",flex:1,widget:{xtype:"fieldcontainer",defaults:{padding:2},items:[{xtype:"button",text:"Batal",ui:"soft-red",action:2,hidden:true,margin:"0 1 0 0",handler:"onClickBatalTagihan"},{xtype:"button",text:"View",action:0,margin:"0 1 0 0",handler:"onViewTagihanPenjualan"},{xtype:"button",text:"Cetak Kwitansi",action:1,handler:"onCetakKwitansi",bind:{hidden:"{getStatusCetakKwitansi}"}}]},onWidgetAttach:"onWidgetAttach"}];a.callParent()}});Ext.define("pembayaran.penjualan.ListController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-penjualan-list",init:function(){this.filter={query:""}},privates:{cari:function(){var e=this,a=e.getView(),c=a.getStore(),b=a.down("pagingtoolbar"),d={};if(e.filter.query==""){delete c.queryParams.ID}else{d.ID=e.filter.query}a.setParams(d);if(b){b.moveFirst()}else{a.load()}}},onSearch:function(a,b){this.filter.query=b;this.cari()},onClear:function(a){this.filter.query="";this.cari()},onViewTagihanPenjualan:function(c){var d=this,b=d.getView(),a=c.ownerCt.getWidgetRecord();b.waitRefresh=true;b.openDialog("",true,0,0,{xtype:"tagihan-penjualan-Workspace",title:"Tagihan Penjualan",ui:"panel-cyan",showCloseButton:true},function(e,g){var f=g.down("tagihan-penjualan-Workspace");g.on({close:function(){b.app.pauseAutoRefresh=false;b.waitRefresh=false;b.refresh()}});b.app.pauseAutoRefresh=true;f.load(a)})},onRefresh:function(a){var c=this,b=c.getView();b.waitRefresh=false;b.refresh()},onHistory:function(b){var c=this,a=c.getView();a.waitRefresh=true;a.openDialog("",true,0,0,{xtype:"pembayaran-penjualan-list",title:"History Pembayaran Tagihan Penjualan",ui:"panel-cyan",showCloseButton:true},function(d,f){var e=f.down("pembayaran-penjualan-list");e.setListConfig({history:false});e.on({close:function(){a.waitRefresh=false;a.refresh();f.close()}});e.setGridConfig({paging:true});e.loadStore({STATUS:2,JENIS:4})})},onCetakKwitansi:function(b){var c=this,a=c.getView(),d=b.ownerCt.getWidgetRecord(),e=d.get("ID");a.cetak({NAME:"pembayaran.CetakKwitansiPenjualan",TYPE:"Word",EXT:"docx",PARAMETER:{PTAGIHAN:e,PJENIS:4},REQUEST_FOR_PRINT:true,PRINT_NAME:"CetakKwitansiPenjualan"})},onClickBatalTagihan:function(b){var c=this,a=c.getView(),d=b.ownerCt.getWidgetRecord();a.showMessageBox({title:"Pembatalan tagihan penjualan",message:"Anda yakin ingin membatalkan tagihan ini ?",ui:"window-red",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,animateTarget:b,fn:function(e){if(e==="yes"){d.set("STATUS",0);d.showError=true;d.animateTarget=b;d.scope=c;d.save({callback:function(f,g,h){if(h){a.notifyMessage("Tagihan telah dibatalkan");a.reload()}else{a.reload()}}})}}})},onWidgetAttach:function(i,d,a){var f=this,g=f.getView(),c=g.app.xpriv("121402"),b=a.get("STATUS"),h=d.down("[action=1]"),e=d.down("[action=2]");h.setHidden(b!=2);if(c){e.setHidden(b!=1)}}});Ext.define("pembayaran.penyedia.Combo",{extend:"com.Combo",alias:"widget.pembayaran-penyedia-combo",viewModel:{stores:{store:{type:"pembayaran-penyedia-store"}}},valueField:"ID",displayField:"NAMA",emptyText:"[Pilih Penyedia Pembayaran]"});Ext.define("pembayaran.penyedia.layanan.Combo",{extend:"com.Combo",alias:"widget.pembayaran-penyedia-layanan-combo",viewModel:{stores:{store:{type:"pembayaran-penyedia-layanan-store"}}},valueField:"ID",emptyText:"[Pilih Layanan Penyedia]",displayField:"NAMA",tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="x-boundlist-item">','<div"><strong>{REFERENSI.JENIS_LAYANAN.DESKRIPSI}</strong></div>',"</div>","</tpl>"),displayTpl:Ext.create("Ext.XTemplate",'<tpl for=".">',"{REFERENSI.JENIS_LAYANAN.DESKRIPSI}","</tpl>")});Ext.define("pembayaran.piutang.pasien.Form",{extend:"com.Form",xtype:"pembayaran-piutang-pasien-form",controller:"pembayaran-piutang-pasien-form",model:"pembayaran.piutang.pasien.Model",viewModel:{data:{formConfig:{create:true},identitas:{norm:0,nama:undefined,alamat:undefined,tgllahir:undefined,nomortagihan:undefined,piutang:undefined,besarangsuran:undefined}},formulas:{getTotalPiutang:function(a){var b=a("identitas");if(b.piutang){return Ext.util.Format.number(b.piutang,"0,00")}return""},getBesarAngsuran:function(a){var b=a("identitas");if(b.besarangsuran){return Ext.util.Format.number(b.besarangsuran,"0,00")}return""}}},defaults:{margin:3},items:[{xtype:"fieldset",title:"Identitas Pasien",layout:"vbox",defaults:{width:"100%",margin:5},defaultType:"label",items:[{bind:{text:"No. RM : {identitas.norm}"}},{bind:{text:"Nama & Tanggal Lahir : {identitas.nama} *{identitas.tgllahir}*"}},{bind:{text:"Alamat: {identitas.alamat}"}},{bind:{text:"Nomor Tagihan : {identitas.nomortagihan}"}},{bind:{text:"Total Piutang : Rp. {getTotalPiutang}"}},{bind:{text:"Besar Angsuran : Rp. {getBesarAngsuran}"}}]},{border:false,defaults:{width:"99%",margin:5},items:[{layout:"hbox",border:false,fieldLabel:"Jenis Pembayaran",defaults:{width:"50%",margin:"0 2 2 2",labelAlign:"top",readOnly:true},items:[{xtype:"combo",fieldLabel:"Jenis Pembayaran",store:Ext.create("data.store.Store",{fields:["ID","DESKRIPSI"],data:[{ID:1,DESKRIPSI:"Bayar Sekaligus"},{ID:2,DESKRIPSI:"Angsuran"}]}),name:"JENIS_PEMBAYARAN",displayField:"DESKRIPSI",valueField:"ID"},{xtype:"numberfield",fieldLabel:"Angsuran Ke",hideTrigger:true,emptyText:"Angsuran Ke",name:"ANGSURAN_KE"}]},{layout:"hbox",border:false,fieldLabel:"Jenis Pembayaran",defaults:{width:"100%",margin:"0 2 2 2",labelAlign:"top"},items:[{fieldLabel:"Total Bayar (Rp)",xtype:"numberfield",hideTrigger:true,labelAlign:"top",minValue:0,name:"TOTAL_BAYAR",bind:"{record.TOTAL_BAYAR}",reference:"txttotalbayar"}]}]}],buttons:[{text:"Buat Tagihan",iconCls:"x-fa fa-plus",ui:"soft-black",bind:{hidden:"{!formConfig.create}"},handler:"onBuatTagihan"},{text:"Simpan",iconCls:"x-fa fa-save",ui:"soft-blue",bind:{hidden:"{formConfig.create}"},handler:"onSimpan"}],setIdentitasPasien:function(c){var b=this,a=b.getViewModel(),d=a.get("identitas");c=Ext.apply(d,c);a.set("identitas",c)}});Ext.define("pembayaran.piutang.pasien.FormController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-pasien-form",onSimpan:function(c){var e=this,d=e.getViewModel(),b=d.get("record"),a=e.getView();b.set("TAGIHAN",{REF:b.get("ID"),JENIS:2,TOTAL:b.get("TOTAL_BAYAR"),STATUS:1});a.save(c)},onBuatTagihan:function(c){var f=this,e=f.getViewModel(),b=e.get("record"),a=f.getView(),d=[];if(a.getForm().isValid()){a.showMessageBox({title:"Konfirmasi",message:"Anda yakin ingin membuat tagihan untuk piutang ini ?",ui:"window-red",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,animateTarget:c,fn:function(g){if(g==="yes"){d.push({JENIS:2,TANGGAL:Ext.Date.format(a.getSysdate(),"Y-m-d H:i:s"),TOTAL:b.get("TOTAL_BAYAR")});a.setLoading(true);b.set("TAGIHAN",d);a.save(c,{success:"Tagihan berhasil di buat",failed:"Gagal membuat tagihan"},function(j,h,i){a.setLoading(false)})}}})}},onChangeNumberJumlahAngsuran:function(b,f){var d=this,c=d.getViewModel(),a=d.getReferences(),e=c.get("identitas");if(f){a.txttotalbayar.setValue(f*e.besarangsuran)}}});Ext.define("pembayaran.piutang.pasien.Grid",{extend:"com.Grid",xtype:"pembayaran-piutang-pasien-grid",viewModel:{stores:{store:{type:"pembayaran-piutang-pasien-store"}}},columns:[{xtype:"rownumberer",text:"No",align:"left",width:60},{text:"Nomor Tagihan Piutang",flex:1,dataIndex:"TAGIHAN_PIUTANG"},{xtype:"templatecolumn",text:"Jenis Pembayaran",dataIndex:"JENIS_PEMBAYARAN",flex:1,xtype:"templatecolumn",tpl:Ext.create("Ext.XTemplate",'<div style="white-space:normal;">{[this.getDeskripsi(values.JENIS_PEMBAYARAN)]}</div>',{getDeskripsi:function(a){return(a==1)?"Bayar Sekaligus":(a==2)?"Angsuran":""}})},{text:"Angsurang Ke",flex:1,dataIndex:"ANGSURAN_KE"},{xtype:"templatecolumn",text:"Status",dataIndex:"JENIS_PEMBAYARAN",flex:1,xtype:"templatecolumn",tpl:Ext.create("Ext.XTemplate",'<div style="white-space:normal; color:{[this.getColor(values.STATUS)]}">{[this.getDeskripsi(values.STATUS)]}</div>',{getDeskripsi:function(a){return(a==1)?"Belum Bayar":(a==2)?"Telah Bayar":"Batal"},getColor:function(a){return(a==1)?"red":(a==2)?"#30d402":"black"}})},{xtype:"numbercolumn",format:"Rp 00,00",text:"Total Bayar",flex:1.5,align:"right",dataIndex:"TOTAL_BAYAR",summaryRenderer:"onSummaryRenderer"}],features:[{ftype:"summary",dock:"bottom"}],doAfterLoad:function(c,b,d,a){c.fireEvent("afterLoad",c,b,d)},getAngsurangKe:function(){var e=this,c=e.getViewModel(),b=1,a=c.get("store");if(a.getCount()>0){var d=a.getCount(),f=a.getAt(d-1);if(f){b=f.get("ANGSURAN_KE")+f.get("JUMLAH_ANGSURAN_DIBAYAR")}}return b},getTotalPembayaran:function(){var c=this,a=c.getStore(),b=0;if(a){a.each(function(d){if(d.get("STATUS")==2){b+=d.get("TOTAL_BAYAR")}})}return b}});Ext.define("pembayaran.piutang.pasien.Workspace",{extend:"com.Form",xtype:"pembayaran-piutang-pasien-workspace",controller:"pembayaran-piutang-pasien-workspace",viewModel:{stores:{storeTagihan:{type:"tagihan-store"}},data:{tagihan:undefined,piutang:undefined}},layout:{type:"border"},border:true,bodyPadding:0,defaults:{flex:1,margin:"1 0 1 0"},items:[{region:"north",title:"Piutang pasien",reference:"listpiutang",xtype:"piutangperorangan-list",listeners:{select:"onSelectPiutang"}},{region:"center",title:"Daftar pembayaran piutang nomor tagihan : ",xtype:"pembayaran-piutang-pasien-grid",reference:"gridpembayaranpiutan",listeners:{afterLoad:"onAfterLoadGrid"}}],initComponent:function(){var b=this,a=b.getController();b.callParent();var d=b.down("piutangperorangan-list"),c=b.down("pembayaran-piutang-pasien-grid");d.setGridConfig({paging:true});d.getHeaderContainer().remove(4);d.getHeaderContainer().remove(4);d.getHeaderContainer().add({text:"Nomor Tagihan",flex:1,dataIndex:"TAGIHAN"});c.header={items:[{xtype:"button",iconCls:"x-fa fa-print",text:"Rincian Piutang",action:0,reference:"btncetakrincian",padding:4,ui:"soft-blue",margin:"1 1 1 1",scope:a,handler:"onCetakRincianPiutang"},{xtype:"button",iconCls:"x-fa fa-money",text:"Buat Tagihan",action:0,reference:"btnbuattagihan",disabled:true,padding:4,ui:"soft-red",margin:"1 1 1 1",scope:a,handler:"onFormPembayaran"}]};c.getHeaderContainer().add({xtype:"widgetcolumn",text:"Action",align:"center",width:150,widget:{xtype:"fieldcontainer",layout:{type:"vbox",align:"stretch"},items:[{xtype:"button",iconCls:"x-fa fa-money",text:"Pembayaran",ui:"soft-green",action:1,margin:"0 1 2 0",scope:a,handler:"onClikMethodPembayaran"},{xtype:"button",iconCls:"x-fa fa-edit",text:"Edit",ui:"soft-gray",action:2,margin:"0 1 0 0",scope:a,handler:"onEditTagihan"}]},onWidgetAttach:"onWidgetAttach"})},load:function(f){var d=this,b=d.getReferences(),c=d.getViewModel(),e=d.down("pembayaran-piutang-pasien-grid"),a=d.down("piutangperorangan-list");b.btnbuattagihan.setDisabled(true);c.set("pasien",f);c.set("piutang",undefined);e.getStore().removeAll();e.setTitle("Daftar pembayaran piutang nomor tagihan : ");a.load({NORM:f.get("NORM"),STATUS:1})}});Ext.define("pembayaran.piutang.pasien.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-pasien-workspace",total:0,bayar:0,belum:0,privates:{loadGridPembayaran:function(b){var c=this,a=c.getReferences();a.btnbuattagihan.setDisabled(true);a.gridpembayaranpiutan.setTitle("Daftar pembayaran piutang nomor tagihan : "+b);a.gridpembayaranpiutan.load({TAGIHAN_PIUTANG:b})}},onSummaryRenderer:function(d,b,c){var a='<span style="font-size: 17px; font-weight: bold"><span style="color: #30d402">'+Ext.util.Format.number(this.bayar,"0,00")+' + </span><span style="color: red">'+Ext.util.Format.number(this.belum,"0,00")+" = </span>"+Ext.util.Format.number(this.total,"0,00")+"</span>";return a},onFormPembayaran:function(l){var h=this,j=h.getView(),i=h.getReferences(),b=h.getViewModel(),k=b.get("pasien"),g=false,e=i.gridpembayaranpiutan.getAngsurangKe(),d=b.get("piutang");if(d){var c=d.get("TOTAL"),a=i.gridpembayaranpiutan.getTotalPembayaran(),f=c-a;g=f>0;if(g){j.openDialog("",true,600,420,{xtype:"pembayaran-piutang-pasien-form",showCloseButton:true,iconCls:"x-fa fa-money",title:"Buat tagihan : "+d.get("TAGIHAN")},function(p,o){var m=o.down("pembayaran-piutang-pasien-form"),n={TAGIHAN_PIUTANG:d.get("TAGIHAN"),JENIS_PEMBAYARAN:d.get("JENIS_PEMBAYARAN"),JUMLAH_ANGSURAN_DIBAYAR:1,ANGSURAN_KE:e,STATUS:1};if(d.get("JENIS_PEMBAYARAN")==1){n.TOTAL_BAYAR=d.get("TOTAL")}else{if(d.get("JENIS_PEMBAYARAN")==2){n.TOTAL_BAYAR=d.get("BESAR_ANGSURAN")}}m.setIdentitasPasien({norm:k.get("NORM"),nama:k.get("NAMA"),tgllahir:Ext.Date.format(k.get("TANGGAL_LAHIR"),"Y-m-d H:m:i"),alamat:k.get("ALAMAT"),nomortagihan:d.get("TAGIHAN"),piutang:d.get("TOTAL"),besarangsuran:d.get("BESAR_ANGSURAN")});m.createRecord(n);m.on("save",function(q){o.close();h.loadGridPembayaran(d.get("TAGIHAN"))})},l)}else{j.notifyMessage("Pembuatan tagihan mencapai batas piutang pasien","danger-red")}}else{j.notifyMessage("Silahkan pilih piutang terlebih dahulu","danger-red")}},onWidgetAttach:function(b,d,e){var a=e.get("STATUS"),c=d.down("[action=2]");c.setHidden(a==2)},onEditTagihan:function(b){var d=this,a=d.getView(),c=d.getViewModel(),e=c.get("pasien"),f=b.ownerCt.getWidgetRecord();if(f){a.openDialog("",true,600,420,{xtype:"pembayaran-piutang-pasien-form",showCloseButton:true,iconCls:"x-fa fa-money",title:"Edit tagihan : "+f.get("TAGIHAN_PIUTANG")},function(i,h){var g=h.down("pembayaran-piutang-pasien-form");g.setIdentitasPasien({norm:e.get("NORM"),nama:e.get("NAMA"),tgllahir:Ext.Date.format(e.get("TANGGAL_LAHIR"),"Y-m-d H:m:i"),alamat:e.get("ALAMAT"),nomortagihan:f.get("TAGIHAN_PIUTANG"),piutang:f.get("TOTAL"),besarangsuran:f.get("BESAR_ANGSURAN")});g.setFormConfig({create:false});g.loadRecord(f);g.on("save",function(j){h.close();d.loadGridPembayaran(f.get("TAGIHAN_PIUTANG"))})},b)}},onSelectPiutang:function(a,d){var c=this,b=c.getViewModel();b.set("piutang",d);this.loadGridPembayaran(d.get("TAGIHAN"))},onClikMethodPembayaran:function(d){var f=this,c=f.getReferences(),h=d.ownerCt.getWidgetRecord(),e=f.getViewModel(),g=e.get("pasien"),a=e.get("storeTagihan"),b=f.getView();b.openDialog("",true,0,0,{xtype:"pembayaran-piutang-pasien-tagihan-workspace",showCloseButton:true,ui:"panel-cyan",iconCls:"x-fa fa-money",title:"Pembayaran tagihan piutang pasien an. "+g.get("NAMA")},function(k,j){var i=j.down("pembayaran-piutang-pasien-tagihan-workspace");i.setLoading(true);a.setQueryParams({REF:h.get("ID"),JENIS:2});a.load({callback:function(m,l,n){if(n){i.setLoading(false);i.load(m[0])}else{i.setLoading(false);j.close()}}});j.on("close",function(){c.btnbuattagihan.setDisabled(true);c.gridpembayaranpiutan.reload()})})},onAfterLoadGrid:function(a,c,e){var d=this,b=d.getReferences();b.btnbuattagihan.setDisabled(false);d.total=0;d.belum=0;d.bayar=0;if(e){if(Ext.isArray(c)){Ext.Array.each(c,function(f){d.total+=f.get("TOTAL_BAYAR");if(f.get("STATUS")==1){d.belum+=f.get("TOTAL_BAYAR")}if(f.get("STATUS")==2){d.bayar+=f.get("TOTAL_BAYAR")}})}}},onCetakRincianPiutang:function(i){var d=this,e=d.getView(),a=d.getViewModel(),g=a.get("pasien"),h=d.getReferences().gridpembayaranpiutan,c=h.getParams(),b={TYPE:"Pdf",EXT:"pdf",REQUEST_FOR_PRINT:false,NAME:"pembayaran.CetakRincianPiutangPasien",PRINT_NAME:"CetakMR"},f={PNORM:g.get("NORM"),PTAGIHAN_PIUTANG:"",CETAK_HEADER:1};if(c.TAGIHAN_PIUTANG){f.PTAGIHAN_PIUTANG=c.TAGIHAN_PIUTANG}b.PARAMETER=f;e.cetak(b)}});Ext.define("pembayaran.piutang.pasien.tagihan.Info",{extend:"com.Form",xtype:"pembayaran-piutang-pasien-tagihan-info",controller:"pembayaran-piutang-pasien-tagihan-info",viewModel:{data:{tagihan:undefined,pembayaran:undefined,viewConfig:{tagihanFinal:false,tagihanHak:false,cetakKuitansi:false},total:0},formulas:{adaPembayaranTunai:function(a){var b=a("total");return b>0}}},width:300,bodyPadding:0,items:[{border:false,autoScroll:true,flex:1,layout:{type:"vbox",align:"stretch"},defaults:{fontSize:"15px",height:55},items:[{xtype:"headervalue",fontSize:"20px",paddingText:"7px 0 0 0",height:60,reference:"totaltagihan",title:"Total Tagihan"},{xtype:"headervalue",reference:"totaljaminan",title:"Total Jaminan"},{xtype:"headervalue",reference:"totalnon",title:"Total Pembayaran Non Tunai"},{xtype:"headervalue",fontSize:"25px",paddingText:"7px 0 0 0",height:65,reference:"totaltunai",title:"Total Harus Bayar / Tunai"}]},{height:260,layout:{type:"vbox",align:"stretch"},items:[{xtype:"kwitansi-form",title:"Kwitansi",bind:{hidden:"{!adaPembayaranTunai}"},reference:"kwitansi"},{xtype:"button",ui:"soft-cerulen",text:"Finalkan Tagihan",hidden:true,bind:{hidden:"{!viewConfig.tagihanFinal}"},handler:"onFinalTagihan"},{xtype:"button",iconCls:"x-fa fa-print",ui:"soft-cyan",text:"Cetak Kwitansi",bind:{hidden:"{!viewConfig.cetakKuitansi}"},handler:"onCetakKwitansi"}]}],load:function(h){var l=this,c=l.getViewModel(),f=webservice.app?webservice.app:false,g=f?f.xpriv:false,j=l.down("kwitansi-form"),d=l.down("[reference=totaltagihan]"),k=l.down("[reference=totaljaminan]"),o=l.down("[reference=totalnon]"),i=l.down("[reference=totaltunai]");if(h){var n=l.getReferensi(h.data,"KWITANSI_PEMBAYARAN");if(n){Ext.Array.each(n,function(p){j.loadRecord(Ext.create("data.model.KwitansiPembayaran",p));j.setFormConfig({viewOnly:true,cetak:!g("121301",false)?false:true});j.setParamReport({name:"pembayaran.CetakKwitansi",params:{PTAGIHAN:h.get("ID"),PJENIS:h.get("JENIS")}})})}else{j.setFormConfig({cetak:g("121301",false)});j.createRecord({TAGIHAN:h.get("ID")})}var b=h.get("TOTAL"),a=l.hitungTotalJaminan(h),e=l.hitungTotalNonTunai(h);c.set("tagihan",h);var m=b-a-e;m=m<0?0:m;d.setValue(b);k.setValue(a);o.setValue(e);i.setValue(m);c.set("total",m);h.set("TOTAL_TUNAI",m);if(g){c.set("viewConfig.cetakKuitansi",g("121301",false)&&h.get("STATUS")==1);if(!g("1201",false)){c.set("viewConfig.tagihanFinal",false);return}}c.set("viewConfig.tagihanFinal",h.get("STATUS")==1)}},hitungTotalJaminan:function(b){var c=0,a=this.getReferensi(b.data,"PENJAMIN_TAGIHAN");if(a){Ext.Array.each(a,function(d){c+=Number(d.TOTAL)})}return c},hitungTotalNonTunai:function(b){var c=0,a=this.getReferensi(b.data,"NON_TUNAI");if(a){Ext.Array.each(a,function(d){c+=Number(d.TOTAL)})}return c}});Ext.define("pembayaran.piutang.pasien.tagihan.InfoController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-pasien-tagihan-info",onCetakKwitansi:function(){var e=this,a=e.getView(),d=e.getViewModel(),b=e.getReferences(),c=a.getPropertyConfig("34")=="TRUE";tghn=d.get("tagihan");a.openDialog("",true,100,50,{xtype:"kwitansi-form",title:"Kwitansi",ui:"panel-cyan",otomatisasinomor:c,showCloseButton:true},function(f,i){var g=i.down("kwitansi-form"),h={TAGIHAN:tghn.get("ID"),STATUS:1};if(c){h.JENIS_PEMBAYARAN=4;h.NUMAUTO=1}g.setFormConfig({viewOnly:false,cetak:true});g.setParamReport({name:"pembayaran.CetakKwitansi",params:{PTAGIHAN:tghn.get("ID"),PJENIS:tghn.get("JENIS")}});g.createRecord(h);g.on("cetak",function(j){b.kwitansi.loadRecord(j);i.close()})})},onFinalTagihan:function(b){var d=this,c=d.getViewModel(),a=d.getView(),g=a.app,f=g?g.xpriv:false,e=g?(g.trxksr?g.trxksr:false):false;if(!f("1201",false)){a.notifyMessage("Anda tidak memiliki hak akses untuk melakukan Tagihan Final","danger-blue");return}if(!e){a.notifyMessage("Anda belum membuka transaksi kasir / open cashier","danger-blue");return}d.finalTagihanPopup(d,a,b)},finalTagihanPopup:function(c,a,b){a.showMessageBox({title:"Finalkan Tagihan",message:"Anda yakin ingin memfinalkan tagihan ini ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"no",animateTarget:b,fn:function(d){if(d==="yes"){c.finalTagihan(b)}}})},finalTagihan:function(j){var g=this,b=g.getViewModel(),i=g.getView(),c=i.app,e=c?c.xpriv:false,f=c?(c.trxksr?c.trxksr:false):false,a=b.get("tagihan"),h=b.get("total"),d=Ext.create("pembayaran.pembayarantagihan.Model",{TAGIHAN:a.get("ID"),JENIS:4,TUNAI:1,REF:f,TRANSAKSI_KASIR_NOMOR:f,TOTAL:h,STATUS:2});j.setDisabled(true);d.animateTarget=j;d.scope=g;d.showError=true;d.save({callback:function(m,k,l){if(l){i.notifyMessage("Tagihan telah di finalkan","danger-blue");b.set("viewConfig.tagihanFinal",false);b.set("pembayaran",d);a.set("STATUS",2);if(h>0){if(e("121301",false)){i.showMessageBox({title:"Cetak Kwitansi",message:"Anda ingin mencetak kwitansi ?",ui:"window-cyan",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:j,fn:function(n){if(n==="yes"){g.onCetakKwitansi()}}})}}i.fireEvent("finalsuccess")}j.setDisabled(false)}})}});Ext.define("pembayaran.piutang.pasien.tagihan.Tab",{extend:"com.Tab",xtype:"pembayaran-piutang-pasien-tagihan-tab",controller:"pembayaran-piutang-pasien-tagihan-tab",viewModel:{data:{tagihan:undefined}},bodyPadding:0,activeTab:0,items:[{title:"Rincian",iconCls:"x-fa fa-list",xtype:"pembayaran-piutang-pasien-grid",listeners:{afterLoad:"onAfterLoadGrid"}},{title:"Penjamin",xtype:"workspace-penjamintagihan",iconCls:"x-fa fa-user-secret",listeners:{load:"onReload"}},{title:"Non Tunai",jenis:5,notLoadLinks:true,iconCls:"x-fa fa-credit-card",xtype:"workspace-nontunai",listeners:{load:"onReload"}}],load:function(b){var c=this,a=c.getViewModel(),d=c.getActiveTab();a.set("tagihan",b);if(d){if(d.xtype=="pembayaran-piutang-pasien-grid"){d.load({ID:b.get("REF")})}else{d.load(b)}}else{if(c.items.getCount()>0){c.setActiveTab(0)}}},listeners:{tabchange:"onChangeTab"}});Ext.define("pembayaran.piutang.pasien.tagihan.TabController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-pasien-tagihan-tab",total:0,onChangeTab:function(b,a){var c=this.getViewModel().get("tagihan");if(a.load){if(a.xtype=="pembayaran-piutang-pasien-grid"){a.load({ID:c.get("REF")})}else{a.load(c)}}},onReload:function(a){this.getView().fireEvent("load",a)},onSummaryRenderer:function(d,b,c){var a='<span style="font-size: 17px; font-weight: bold">'+Ext.util.Format.number(this.total,"0,00")+"</span>";return a},onAfterLoadGrid:function(a,b,d){var c=this;c.total=0;if(d){if(Ext.isArray(b)){Ext.Array.each(b,function(e){c.total+=e.get("TOTAL_BAYAR")})}}}});Ext.define("pembayaran.piutang.pasien.tagihan.Workspace",{extend:"com.Form",xtype:"pembayaran-piutang-pasien-tagihan-workspace",controller:"pembayaran-piutang-pasien-tagihan-workspace",viewModel:{data:{tagihan:undefined,allowBatalFinal:false},formulas:{getFormatTagihan:function(e){var f=e("tagihan.ID")+"",d=f?f.substring(0,6)+"."+f.substring(6):"";return d},getInfoTanggal:function(c){var f=c("tagihan.TANGGAL"),e=f?Ext.Date.format(f,"d F Y H:i:s"):"";return e},isAllowBatalFinal:function(a){var c=a("tagihan.STATUS")==2,b=a("allowBatalFinal");if(!c){return false}return b}}},layout:{type:"border"},bodyPadding:0,defaults:{margin:"2 2 2 2",border:false},header:{itemPosition:1,items:[{xtype:"component",bind:{html:"<strong>No. Tagihan: {getFormatTagihan} / {getInfoTanggal}</strong>"},margin:"0 5 0 0"},{xtype:"button",iconCls:"x-fa fa-chain-broken",tooltip:"Batalkan Final",bind:{hidden:"{!isAllowBatalFinal}"},ui:"soft-red",handler:"onBatalFinal"},{xtype:"button",ui:"soft-asperages",iconCls:"x-fa fa-refresh",tooltip:"Perbarui Data",handler:"onReload"}]},items:[{region:"center",flax:1,xtype:"pembayaran-piutang-pasien-tagihan-tab",listeners:{load:"onReload"}},{region:"east",split:true,collapsible:true,title:"Info Pembayaran",xtype:"pembayaran-piutang-pasien-tagihan-info",listeners:{finalsuccess:"onReload"}}],load:function(d){var e=this,c=e.getViewModel(),g=e.app.xpriv("1208"),b=e.down("pembayaran-piutang-pasien-tagihan-tab"),a=b.getActiveTab(),f=e.down("pembayaran-piutang-pasien-tagihan-info");c.set("tagihan",d);f.load(d);if(a.notLoadLinks==undefined){b.load(d)}c.set("allowBatalFinal",g)}});Ext.define("pembayaran.piutang.pasien.tagihan.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-pasien-tagihan-workspace",onReload:function(e){var d=this,a=this.getView(),c=d.getViewModel(),b=c.get("tagihan");a.setLoading(true);(new Ext.util.DelayedTask(function(){var f=Ext.create("data.model.Tagihan",{ID:b.get("ID")});f.load({callback:function(i,g,h){if(h){a.load(i)}if(Ext.isFunction(e)){e(i)}a.setLoading(false)}})})).delay(1500)},onBatalFinal:function(c){var f=this,a=f.getView(),e=f.getViewModel(),d=e.get("tagihan"),b=true;if(a.app){b=!a.app.xpriv("1208")}if(b){a.notifyMessage("Anda tidak memiliki Hak Akses untuk melakukan Pembatalan tagihan final!");return}a.showMessageBox({title:"Pembatalan Tagihan Final",message:"Anda yakin ingin membatalkan tagihan final?",buttons:Ext.Msg.YESNO,ui:"window-red",icon:Ext.Msg.QUESTION,animateTarget:c,fn:function(g){if(g==="yes"){a.openDialog("",true,100,50,{ui:"panel-red",showCloseButton:true,xtype:"pembatalan-tagihan-form",title:"Pembatalan Tagihan Final"},function(h,j){var i=j.down("pembatalan-tagihan-form");i.on("save",function(m,k,l){f.onReload();j.close()});i.createRecord({TAGIHAN:d.get("ID"),JENIS:1,TANGGAL:a.getSysdate()})})}}})}});Ext.define("pembayaran.piutang.perusahaan.Form",{extend:"com.Form",xtype:"pembayaran-piutang-perusahaan-form",controller:"pembayaran-piutang-perusahaan-form",model:"pembayaran.piutang.perusahaan.Model",viewModel:{data:{formConfig:{create:true},identitas:{norm:0,nama:undefined,alamat:undefined,tgllahir:undefined,total:0}}},defaults:{margin:3},items:[{xtype:"fieldset",title:"Identitas Pasien",layout:"vbox",defaults:{width:"100%",margin:5},defaultType:"label",items:[{bind:{text:"No. RM : {identitas.norm}"}},{bind:{text:"Nama & Tanggal Lahir : {identitas.nama} *{identitas.tgllahir}*"}},{bind:{text:"Alamat: {identitas.alamat}"}}]},{layout:"hbox",border:false,defaults:{width:"50%",margin:"0 2 2 2",labelAlign:"top",readOnly:true},items:[{fieldLabel:"Nomor Tagihan",xtype:"textfield",labelAlign:"top",name:"TAGIHAN_PIUTANG"},{fieldLabel:"Penjamin",xtype:"referensi-combo",params:{JENIS:10,STATUS:1},firstLoad:true,emptyText:"[ PENJAMIN ]",name:"PENJAMIN",flex:1}]},{layout:"hbox",border:false,defaults:{width:"50%",margin:"0 2 2 2",labelAlign:"top",xtype:"numberfield",hideTrigger:true,labelAlign:"top",readOnly:true},items:[{fieldLabel:"Total Piutang (Rp)",name:"TOTAL_PIUTANG",reference:"txttotalpiutang"},{fieldLabel:"Total Bayar (Rp)",readOnly:false,name:"TOTAL_BAYAR",minValue:0,bind:{maxValue:"{identitas.total}",value:"{record.TOTAL_BAYAR}"},reference:"txttotalbayar"}]}],buttons:[{text:"Buat Tagihan",iconCls:"x-fa fa-plus",ui:"soft-black",bind:{hidden:"{!formConfig.create}"},handler:"onBuatTagihan"},{text:"Simpan",iconCls:"x-fa fa-save",ui:"soft-blue",bind:{hidden:"{formConfig.create}"},handler:"onSimpan"}],setIdentitasPasien:function(c){var b=this,a=b.getViewModel();_identitas=a.get("identitas");c=Ext.apply(_identitas,c);a.set("identitas",c)}});Ext.define("pembayaran.piutang.perusahaan.FormController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-perusahaan-form",onSimpan:function(c){var e=this,d=e.getViewModel(),b=d.get("record"),a=e.getView();b.set("TAGIHAN",{REF:b.get("ID"),JENIS:3,TOTAL:b.get("TOTAL_BAYAR"),STATUS:1});a.save(c)},onBuatTagihan:function(c){var f=this,e=f.getViewModel(),b=e.get("record"),a=f.getView(),d=[];if(a.getForm().isValid()){a.showMessageBox({title:"Konfirmasi",message:"Anda yakin ingin membuat tagihan untuk piutang ini ?",ui:"window-red",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,animateTarget:c,fn:function(g){if(g==="yes"){d.push({JENIS:3,TANGGAL:Ext.Date.format(a.getSysdate(),"Y-m-d H:i:s"),TOTAL:b.get("TOTAL_BAYAR"),STATUS:1});a.setLoading(true);b.set("TAGIHAN",d);a.save(c,{success:"Tagihan berhasil di buat",failed:"Gagal membuat tagihan"},function(j,h,i){a.setLoading(false)})}}})}}});Ext.define("pembayaran.piutang.perusahaan.Grid",{extend:"com.Grid",xtype:"pembayaran-piutang-perusahaan-grid",viewModel:{stores:{store:{type:"pembayaran-piutang-perusahaan-store"}}},columns:[{xtype:"rownumberer",text:"No",align:"left",width:60},{text:"Nomor Tagihan Piutang",flex:1,dataIndex:"TAGIHAN_PIUTANG"},{xtype:"templatecolumn",text:"Jenis Pembayaran",dataIndex:"PENJAMIN",flex:1,xtype:"templatecolumn",tpl:Ext.create("Ext.XTemplate",'<div style="white-space:normal;">{[this.getReferensi(values, "PENJAMIN", "DESKRIPSI")]}</div>')},{xtype:"numbercolumn",format:"Rp 00,00",text:"Total Bayar",text:"Total Piutang",flex:1,dataIndex:"TOTAL_PIUTANG"},{xtype:"templatecolumn",text:"Status",dataIndex:"JENIS_PEMBAYARAN",flex:1,xtype:"templatecolumn",tpl:Ext.create("Ext.XTemplate",'<div style="white-space:normal; color:{[this.getColor(values.STATUS)]}">{[this.getDeskripsi(values.STATUS)]}</div>',{getDeskripsi:function(a){return(a==1)?"Belum Bayar":(a==2)?"Telah Bayar":"Batal"},getColor:function(a){return(a==1)?"red":(a==2)?"#30d402":"black"}})},{xtype:"numbercolumn",format:"Rp 00,00",text:"Total Bayar",flex:1.5,align:"right",dataIndex:"TOTAL_BAYAR",summaryRenderer:"onSummaryRenderer"}],features:[{ftype:"summary",dock:"bottom"}],doAfterLoad:function(c,b,d,a){c.fireEvent("afterLoad",c,b,d)},getTotalPembayaran:function(){var c=this,a=c.getStore(),b=0;if(a){a.each(function(d){if(d.get("STATUS")==2){b+=d.get("TOTAL_BAYAR")}})}return b}});Ext.define("pembayaran.piutang.perusahaan.Workspace",{extend:"com.Form",xtype:"pembayaran-piutang-perusahaan-workspace",controller:"pembayaran-piutang-perusahaan-workspace",viewModel:{stores:{storeTagihan:{type:"tagihan-store"}},data:{pasien:undefined,piutang:undefined}},layout:{type:"border"},border:true,bodyPadding:0,defaults:{flex:1,margin:"1 0 1 0"},items:[{region:"north",title:"Piutang perusahaan berdasarkan tagihan",reference:"listpiutang",xtype:"piutang-penjamin-list",listeners:{select:"onSelectGridPiutang"}},{region:"center",reference:"gridpembayaran",title:"Daftar pembayaran piutang nomor tagihan : ",xtype:"pembayaran-piutang-perusahaan-grid",listeners:{afterLoad:"onAfterLoadGrid"}}],initComponent:function(){var b=this,a=b.getController();b.callParent();var c=b.down("piutang-penjamin-list");lstbayar=b.down("pembayaran-piutang-perusahaan-grid");c.setGridConfig({paging:true});c.getHeaderContainer().remove(4);c.getHeaderContainer().remove(4);c.getHeaderContainer().add({text:"Total Rp.",flex:1,xtype:"numbercolumn",format:"Rp 00,00",align:"right",dataIndex:"TOTAL"},{text:"Nomor Tagihan",flex:1,dataIndex:"TAGIHAN"});lstbayar.header={items:[{xtype:"button",iconCls:"x-fa fa-money",text:"Buat Tagihan",action:0,reference:"btnbuattagihan",disabled:true,padding:4,ui:"soft-red",margin:"1 1 1 1",scope:a,handler:"onFormPembayaran"}]};lstbayar.getHeaderContainer().add({xtype:"widgetcolumn",text:"Action",align:"center",width:150,widget:{xtype:"fieldcontainer",layout:{type:"vbox",align:"stretch"},items:[{xtype:"button",iconCls:"x-fa fa-money",text:"Pembayaran",ui:"soft-green",action:1,margin:"0 1 2 0",scope:a,handler:"onClikMethodPembayaran"},{xtype:"button",iconCls:"x-fa fa-edit",text:"Edit",ui:"soft-gray",action:2,margin:"0 1 0 0",scope:a,handler:"onEditTagihan"}]},onWidgetAttach:"onWidgetAttach"})},load:function(f){var d=this,b=d.getReferences(),c=d.getViewModel(),e=d.down("pembayaran-piutang-perusahaan-grid"),a=d.down("piutang-penjamin-list");b.btnbuattagihan.setDisabled(true);c.set("pasien",f);c.set("piutang",undefined);e.getStore().removeAll();e.setTitle("Daftar pembayaran piutang nomor tagihan : ");a.load({NORM:f.get("NORM"),STATUS:1})}});Ext.define("pembayaran.piutang.perusahaan.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-perusahaan-workspace",total:0,bayar:0,belum:0,privates:{loadGridPembayaran:function(c){var b=this,a=b.getReferences();a.btnbuattagihan.setDisabled(true);a.gridpembayaran.setTitle("Daftar pembayaran piutang nomor tagihan : "+c.TAGIHAN);a.gridpembayaran.load(c)}},onSummaryRenderer:function(d,b,c){var a='<span style="font-size: 17px; font-weight: bold"><span style="color: #30d402">'+Ext.util.Format.number(this.bayar,"0,00")+' + </span><span style="color: red">'+Ext.util.Format.number(this.belum,"0,00")+" = </span>"+Ext.util.Format.number(this.total,"0,00")+"</span>";return a},onFormPembayaran:function(k){var g=this,i=g.getView(),b=g.getViewModel(),j=b.get("pasien"),h=g.getReferences(),f=false,d=b.get("piutang");if(d){var c=d.get("TOTAL"),a=h.gridpembayaran.getTotalPembayaran(),e=c-a;f=e>0;if(f){i.openDialog("",true,600,420,{xtype:"pembayaran-piutang-perusahaan-form",title:"Pembayaran piutang perusahaan",showCloseButton:true,iconCls:"x-fa fa-money"},function(m,n){var l=n.down("pembayaran-piutang-perusahaan-form");l.createRecord({TAGIHAN_PIUTANG:d.get("TAGIHAN"),PENJAMIN:d.get("PENJAMIN"),TOTAL_PIUTANG:c,TOTAL_BAYAR:e,STATUS:1});l.setIdentitasPasien({norm:j.get("NORM"),nama:j.get("NAMA"),tgllahir:Ext.Date.format(j.get("TANGGAL_LAHIR"),"Y-m-d H:m:i"),alamat:j.get("ALAMAT"),total:e});l.on("save",function(){n.close();g.loadGridPembayaran({TAGIHAN:d.get("TAGIHAN"),PENJAMIN:d.get("PENJAMIN")})})})}else{i.notifyMessage("Pembuatan tagihan mencapai batas piutang pasien","danger-red")}}else{i.notifyMessage("Silahkan pilih piutang terlebih dahulu","danger-red")}},onWidgetAttach:function(b,d,e){var a=e.get("STATUS"),c=d.down("[action=2]");c.setHidden(a==2)},onEditTagihan:function(k){var f=this,h=f.getView(),b=f.getViewModel(),j=b.get("pasien"),g=f.getReferences(),d=k.ownerCt.getWidgetRecord(),i=b.get("piutang");if(d){var c=i.get("TOTAL"),a=g.gridpembayaran.getTotalPembayaran(),e=c-a;h.openDialog("",true,600,420,{xtype:"pembayaran-piutang-perusahaan-form",showCloseButton:true,iconCls:"x-fa fa-money",title:"Edit tagihan : "+d.get("TAGIHAN_PIUTANG")},function(n,m){var l=m.down("pembayaran-piutang-perusahaan-form");l.setIdentitasPasien({norm:j.get("NORM"),nama:j.get("NAMA"),tgllahir:Ext.Date.format(j.get("TANGGAL_LAHIR"),"Y-m-d H:m:i"),alamat:j.get("ALAMAT"),total:e});l.setFormConfig({create:false});l.loadRecord(d);l.on("save",function(o){m.close();f.loadGridPembayaran({TAGIHAN:d.get("TAGIHAN_PIUTANG"),PENJAMIN:d.get("PENJAMIN")})})},k)}},onSelectGridPiutang:function(a,d){var c=this,b=c.getViewModel();b.set("piutang",d);this.loadGridPembayaran({TAGIHAN:d.get("TAGIHAN"),PENJAMIN:d.get("PENJAMIN")})},onClikMethodPembayaran:function(i){var e=this,f=e.getReferences(),d=i.ownerCt.getWidgetRecord(),b=e.getViewModel(),g=e.getView(),h=b.get("piutang"),c=g.getReferensi(h.getData(),"PENJAMIN","DESKRIPSI"),a=b.get("storeTagihan");g.openDialog("",true,0,0,{xtype:"pembayaran-piutang-perusahaan-tagihan-workspace",showCloseButton:true,ui:"panel-cyan",iconCls:"x-fa fa-money",title:"Pembayaran tagihan piutang perusahaan an. "+c},function(l,k){var j=k.down("pembayaran-piutang-perusahaan-tagihan-workspace");j.setLoading(true);a.setQueryParams({REF:d.get("ID"),JENIS:3});a.load({callback:function(n,m,o){if(o){j.setLoading(false);j.load(n[0])}else{j.setLoading(false);k.close()}}});k.on("close",function(){f.btnbuattagihan.setDisabled(true);f.gridpembayaran.reload()})})},onAfterLoadGrid:function(b){var c=this,a=c.getReferences();a.btnbuattagihan.setDisabled(false)}});Ext.define("pembayaran.piutang.perusahaan.tagihan.Info",{extend:"com.Form",xtype:"pembayaran-piutang-perusahaan-tagihan-info",controller:"pembayaran-piutang-perusahaan-tagihan-info",viewModel:{data:{tagihan:undefined,pembayaran:undefined,viewConfig:{tagihanFinal:false,tagihanHak:false,cetakKuitansi:false},total:0},formulas:{adaPembayaranTunai:function(a){var b=a("total");return b>0}}},width:300,bodyPadding:0,items:[{border:false,autoScroll:true,flex:1,layout:{type:"vbox",align:"stretch"},defaults:{fontSize:"15px",height:55},items:[{xtype:"headervalue",fontSize:"20px",paddingText:"7px 0 0 0",height:60,reference:"totaltagihan",title:"Total Tagihan"},{xtype:"headervalue",reference:"totalnon",title:"Total Pembayaran Non Tunai"},{xtype:"headervalue",fontSize:"25px",paddingText:"7px 0 0 0",height:65,reference:"totaltunai",title:"Total Harus Bayar / Tunai"}]},{height:160,layout:{type:"vbox",align:"stretch"},items:[{xtype:"kwitansi-form",title:"Kwitansi",bind:{hidden:"{!adaPembayaranTunai}"},reference:"kwitansi"},{xtype:"button",ui:"soft-cerulen",text:"Finalkan Tagihan",hidden:true,bind:{hidden:"{!viewConfig.tagihanFinal}"},handler:"onFinalTagihan"},{xtype:"button",iconCls:"x-fa fa-print",ui:"soft-cyan",text:"Cetak Kwitansi",bind:{hidden:"{!viewConfig.cetakKuitansi}"},handler:"onCetakKwitansi"}]}],load:function(g){var j=this,b=j.getViewModel(),e=webservice.app?webservice.app:false,f=e?e.xpriv:false,i=j.down("kwitansi-form"),c=j.down("[reference=totaltagihan]"),m=j.down("[reference=totalnon]"),h=j.down("[reference=totaltunai]");if(g){var l=j.getReferensi(g.data,"KWITANSI_PEMBAYARAN");if(l){Ext.Array.each(l,function(n){i.loadRecord(Ext.create("data.model.KwitansiPembayaran",n));i.setFormConfig({viewOnly:true,cetak:!f("121301",false)?false:true});i.setParamReport({name:"pembayaran.CetakKwitansi",params:{PTAGIHAN:g.get("ID"),PJENIS:g.get("JENIS")}})})}else{i.setFormConfig({cetak:f("121301",false)});i.createRecord({TAGIHAN:g.get("ID")})}var a=g.get("TOTAL"),d=j.hitungTotalNonTunai(g);b.set("tagihan",g);var k=a-d;k=k<0?0:k;c.setValue(a);m.setValue(d);h.setValue(k);b.set("total",k);g.set("TOTAL_TUNAI",k);if(f){b.set("viewConfig.cetakKuitansi",f("121301",false)&&g.get("STATUS")==1);if(!f("1201",false)){b.set("viewConfig.tagihanFinal",false);return}}b.set("viewConfig.tagihanFinal",g.get("STATUS")==1)}},hitungTotalNonTunai:function(b){var c=0,a=this.getReferensi(b.data,"NON_TUNAI");if(a){Ext.Array.each(a,function(d){c+=Number(d.TOTAL)})}return c}});Ext.define("pembayaran.piutang.perusahaan.tagihan.InfoController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-perusahaan-tagihan-info",onCetakKwitansi:function(){var e=this,a=e.getView(),d=e.getViewModel(),b=e.getReferences(),c=a.getPropertyConfig("34")=="TRUE";tghn=d.get("tagihan");a.openDialog("",true,100,50,{xtype:"kwitansi-form",title:"Kwitansi",ui:"panel-cyan",otomatisasinomor:c,showCloseButton:true},function(f,i){var g=i.down("kwitansi-form"),h={TAGIHAN:tghn.get("ID"),STATUS:1};if(c){h.JENIS_PEMBAYARAN=4;h.NUMAUTO=1}g.setFormConfig({viewOnly:false,cetak:true});g.setParamReport({name:"pembayaran.CetakKwitansiPiutangPasien",params:{PTAGIHAN:tghn.get("ID"),PJENIS:tghn.get("JENIS")}});g.createRecord(h);g.on("cetak",function(j){b.kwitansi.loadRecord(j);i.close()})})},onFinalTagihan:function(b){var d=this,c=d.getViewModel(),a=d.getView(),g=c.get("tagihan"),h=a.app,f=h?h.xpriv:false,e=h?(h.trxksr?h.trxksr:false):false;if(!f("1201",false)){a.notifyMessage("Anda tidak memiliki hak akses untuk melakukan Tagihan Final","danger-blue");return}if(!e){a.notifyMessage("Anda belum membuka transaksi kasir / open cashier","danger-blue");return}d.finalTagihanPopup(d,a,b)},finalTagihanPopup:function(c,a,b){a.showMessageBox({title:"Finalkan Tagihan",message:"Anda yakin ingin memfinalkan tagihan ini ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"no",animateTarget:b,fn:function(d){if(d==="yes"){c.finalTagihan(b)}}})},finalTagihan:function(j){var g=this,b=g.getViewModel(),i=g.getView(),c=i.app,e=c?c.xpriv:false,f=c?(c.trxksr?c.trxksr:false):false,a=b.get("tagihan"),h=b.get("total"),d=Ext.create("pembayaran.pembayarantagihan.Model",{TAGIHAN:a.get("ID"),JENIS:4,TUNAI:1,REF:f,TRANSAKSI_KASIR_NOMOR:f,TOTAL:h,STATUS:2});j.setDisabled(true);d.animateTarget=j;d.scope=g;d.showError=true;d.save({callback:function(m,k,l){if(l){i.notifyMessage("Tagihan telah di finalkan","danger-blue");b.set("viewConfig.tagihanFinal",false);b.set("pembayaran",d);a.set("STATUS",2);if(h>0){if(e("121301",false)){i.showMessageBox({title:"Cetak Kwitansi",message:"Anda ingin mencetak kwitansi ?",ui:"window-cyan",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:j,fn:function(n){if(n==="yes"){g.onCetakKwitansi()}}})}}i.fireEvent("finalsuccess")}j.setDisabled(false)}})}});Ext.define("pembayaran.piutang.perusahaan.tagihan.Tab",{extend:"com.Tab",xtype:"pembayaran-piutang-perusahaan-tagihan-tab",controller:"pembayaran-piutang-perusahaan-tagihan-tab",viewModel:{data:{tagihan:undefined}},bodyPadding:0,activeTab:0,items:[{title:"Rincian",iconCls:"x-fa fa-list",xtype:"pembayaran-piutang-perusahaan-grid",listeners:{afterLoad:"onAfterLoadGrid"}},{title:"Non Tunai",jenis:7,notLoadLinks:true,iconCls:"x-fa fa-credit-card",xtype:"workspace-nontunai",listeners:{load:"onReload"}}],load:function(b){var c=this,a=c.getViewModel(),d=c.getActiveTab();a.set("tagihan",b);if(d){if(d.xtype=="pembayaran-piutang-perusahaan-grid"){d.load({ID:b.get("REF")})}else{d.load(b)}}else{if(c.items.getCount()>0){c.setActiveTab(0)}}},listeners:{tabchange:"onChangeTab"}});Ext.define("pembayaran.piutang.perusahaan.tagihan.TabController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-perusahaan-tagihan-tab",total:0,onChangeTab:function(b,a){var c=this.getViewModel().get("tagihan");if(a.load){if(a.xtype=="pembayaran-piutang-perusahaan-grid"){a.load({ID:c.get("REF")})}else{a.load(c)}}},onReload:function(a){this.getView().fireEvent("load",a)},onSummaryRenderer:function(d,b,c){var a='<span style="font-size: 17px; font-weight: bold">'+Ext.util.Format.number(this.total,"0,00")+"</span>";return a},onAfterLoadGrid:function(a,b,d){var c=this;c.total=0;if(d){if(Ext.isArray(b)){Ext.Array.each(b,function(e){c.total+=e.get("TOTAL_BAYAR")})}}}});Ext.define("pembayaran.piutang.perusahaan.tagihan.Workspace",{extend:"com.Form",xtype:"pembayaran-piutang-perusahaan-tagihan-workspace",controller:"pembayaran-piutang-perusahaan-tagihan-workspace",viewModel:{data:{tagihan:undefined,allowBatalFinal:false},formulas:{isAllowBatalFinal:function(a){var c=a("tagihan.STATUS")==2,b=a("allowBatalFinal");if(!c){return false}return b}}},layout:{type:"border"},bodyPadding:0,defaults:{margin:"2 2 2 2",border:false},header:{itemPosition:1,items:[{xtype:"button",iconCls:"x-fa fa-chain-broken",tooltip:"Batalkan Final",bind:{hidden:"{!isAllowBatalFinal}"},ui:"soft-red",handler:"onBatalFinal"},{xtype:"button",ui:"soft-asperages",iconCls:"x-fa fa-refresh",tooltip:"Perbarui Data",handler:"onReload"}]},items:[{region:"center",flax:1,xtype:"pembayaran-piutang-perusahaan-tagihan-tab",listeners:{load:"onReload"}},{region:"east",split:true,collapsible:true,title:"Info Pembayaran",xtype:"pembayaran-piutang-perusahaan-tagihan-info",listeners:{finalsuccess:"onReload"}}],load:function(b){var a=this.getViewModel(),c=this.down("pembayaran-piutang-perusahaan-tagihan-tab"),d=this.down("pembayaran-piutang-perusahaan-tagihan-info");a.set("tagihan",b);d.load(b);c.load(b)}});Ext.define("pembayaran.piutang.perusahaan.tagihan.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-piutang-perusahaan-tagihan-workspace",onReload:function(e){var d=this,a=this.getView(),c=d.getViewModel(),b=c.get("tagihan");a.setLoading(true);(new Ext.util.DelayedTask(function(){var f=Ext.create("data.model.Tagihan",{ID:b.get("ID")});f.load({callback:function(i,g,h){if(h){a.load(i)}if(Ext.isFunction(e)){e(i)}a.setLoading(false)}})})).delay(1500)},onBatalFinal:function(c){var f=this,a=f.getView(),e=f.getViewModel(),d=e.get("tagihan"),b=true;if(a.app){b=!a.app.xpriv("1208")}if(b){a.notifyMessage("Anda tidak memiliki Hak Akses untuk melakukan Pembatalan tagihan final!");return}a.showMessageBox({title:"Pembatalan Tagihan Final",message:"Anda yakin ingin membatalkan tagihan final?",buttons:Ext.Msg.YESNO,ui:"window-red",icon:Ext.Msg.QUESTION,animateTarget:c,fn:function(g){if(g==="yes"){a.openDialog("",true,100,50,{ui:"panel-red",showCloseButton:true,xtype:"pembatalan-tagihan-form",title:"Pembatalan Tagihan Final"},function(h,j){var i=j.down("pembatalan-tagihan-form");i.on("save",function(m,k,l){f.onReload();j.close()});i.createRecord({TAGIHAN:d.get("ID"),JENIS:1,TANGGAL:a.getSysdate()})})}}})}});Ext.define("pembayaran.tagihan.HeaderInputNumber",{extend:"Ext.form.Panel",xtype:"header-input-number",viewModel:{data:{value:0},formulas:{getValueNumber:function(a){var b=a("value");b=b?b:0;return Ext.util.Format.number(b,"0,00")}}},border:false,fontWeight:"bold",fontSize:"17px",paddingText:"4 0 0 0",layout:{type:"vbox",align:"stretch"},bodyPadding:5,initComponent:function(){var a=this;a.items=[{xtype:"numberfield",minValue:0,hideTrigger:true,allowDecimals:false,selectOnFocus:true,keyNavEnabled:false,fieldStyle:"font-family: arial; font-size: 24px; text-align: right",bind:"{value}",listeners:{change:function(b,d,c){a.fireEvent("numberchange",d,c)}}},{layout:{type:"hbox",align:"stretch"},items:[{xtype:"component",html:"Rp.",margin:"0 5 0 0"},{xtype:"component",flex:1,style:{fontWeight:a.fontWeight,fontSize:a.fontSize,textAlign:"right",padding:a.paddingText},bind:{html:"{getValueNumber}"}}]}];a.callParent()},setValue:function(a){this.getViewModel().set("value",a)},getValue:function(){return this.getViewModel().get("value")}});Ext.define("pembayaran.tagihan.HeaderValue",{extend:"Ext.form.Panel",xtype:"headervalue",viewModel:{data:{value:0},formulas:{getValueNumber:function(a){var b=a("value");b=b?b:0;return Ext.util.Format.number(b,"0,00")}}},border:false,fontWeight:"bold",fontSize:"17px",paddingText:"4 0 0 0",layout:{type:"hbox",align:"stretch"},bodyPadding:5,initComponent:function(){var a=this;a.items=[{xtype:"component",html:"Rp.",margin:"0 5 0 0"},{xtype:"component",flex:1,style:{fontWeight:a.fontWeight,fontSize:a.fontSize,textAlign:"right",padding:a.paddingText},bind:{html:"{getValueNumber}"}}];a.callParent()},setValue:function(a){this.getViewModel().set("value",a)},getValue:function(){return this.getViewModel().get("value")}});Ext.define("pembayaran.tagihan.Info",{extend:"com.Form",xtype:"tagihan-info",controller:"tagihan-info",viewModel:{data:{tagihan:undefined,pembayaran:undefined,viewConfig:{tagihanFinal:false,tagihanHak:false,cetakKuitansi:false},total:0,info:""},formulas:{adaPembayaranTunai:function(a){var b=a("total");return b>0}}},layout:{type:"vbox",align:"stretch"},width:300,bodyPadding:0,header:{itemPosition:1,items:[{xtype:"button",ui:"soft-red",iconCls:"x-fa fa-calculator",tooltip:"Hitung Ulang Tagihan",bind:{hidden:"{!viewConfig.tagihanFinal}"},handler:"onHitungUlang",margin:"0 1 0 0"},{xtype:"button",ui:"soft-cyan",iconCls:"x-fa fa-info",tooltip:"Informasi",handler:"onInfo"}]},initComponent:function(){var a=this;a.callParent();a.suspendLayouts();a.add(a.lCetakan());a.add(a.lInfoTagihan());a.add(a.lBtnTagihan());a.resumeLayouts()},lCetakan:function(){var a=this;return{height:30,layout:{type:"hbox",align:"stretch"},reference:"cetakrekapdanrincian",hidden:true,defaultType:"button",items:[{text:"Cetak Rekap",iconCls:"x-fa fa-print",ui:"soft-cyan",rptName:"CetakRekapRincianPasien",flex:1,handler:"onCetak"},{text:"Cetak Rincian",iconCls:"x-fa fa-print",ui:"soft-cerulen",flex:1,menu:[{text:"Format 1",rptName:a.kode+"CetakRincianPasien",handler:"onCetak"},{text:"Format 2",rptName:"CetakRincianPasien",handler:"onCetak"},{text:"Format 3",rptName:a.kode+"CetakRincianPasienPerGroup",handler:"onCetak"},{text:"Format 4",rptName:"CetakRincianKegiatanPasien",handler:"onCetak"}]}]}},lInfoTagihan:function(){var a=this;return{autoScroll:true,flex:1,layout:{type:"vbox",align:"stretch"},defaults:{fontSize:"15px",height:55},items:[{xtype:"headervalue",fontSize:"20px",paddingText:"7px 0 0 0",height:60,reference:"totaltagihan",title:"Total Tagihan"},{xtype:"headervalue",reference:"totaltagihanhak",title:"Total Tagihan Hak",hidden:true,bind:{hidden:"{!viewConfig.tagihanHak}"}},{xtype:"headervalue",reference:"totaljaminan",title:"Total Jaminan"},{xtype:"headervalue",reference:"totalsubsidi",title:"Total Subsidi"},{xtype:"headervalue",reference:"totalpiutang",title:"Total Piutang"},{xtype:"headervalue",reference:"totaldiskon",title:"Total Diskon"},{xtype:"headervalue",reference:"totalnon",title:"Total Pembayaran Non Tunai"},{xtype:"headervalue",reference:"totalbulat",title:"Pembulatan"},{xtype:"headervalue",fontSize:"25px",paddingText:"7px 0 0 0",height:65,reference:"totaltunai",title:"<b>Total Harus Bayar / Tunai</b>"},{xtype:"headervalue",reference:"totaluangmuka",title:"Total Deposit"},{xtype:"headervalue",reference:"sisapembayaran",title:"<b>Sisa Pembayaran</b>"},{xtype:"header-input-number",reference:"pembayarantunai",title:"<b>Input Pembayaran Tunai</b>",height:100,listeners:{numberchange:function(d){var c=0,b=a.down("[reference=sisapembayaran]"),e=a.down("[reference=kembalian]");if(d){c=d}c=c-b.getValue();if(c<0){c=0}e.setValue(c)}}},{xtype:"headervalue",reference:"kembalian",title:"<b>Sisa Kembalian</b>",fontSize:"24px",paddingText:"7px 0 0 0",height:65}]}},lBtnTagihan:function(){return{height:160,layout:{type:"vbox",align:"stretch"},items:[{xtype:"kwitansi-form",title:"Kwitansi",bind:{hidden:"{!adaPembayaranTunai}"},reference:"kwitansi"},{xtype:"button",ui:"soft-cerulen",text:"Finalkan Tagihan",hidden:true,bind:{hidden:"{!viewConfig.tagihanFinal}"},handler:"onFinalTagihan"},{xtype:"button",iconCls:"x-fa fa-print",ui:"soft-cyan",text:"Cetak Kwitansi",bind:{hidden:"{!viewConfig.cetakKuitansi}"},handler:"onCetakKwitansi"}]}},load:function(w){var t=this,r=t.getViewModel(),d=webservice.app?webservice.app:false,y=d?d.xpriv:false,p=t.down("kwitansi-form"),k=t.down("[reference=totaltagihan]"),P=t.down("[reference=totaltagihanhak]"),Q=t.down("[reference=totaljaminan]"),W=t.down("[reference=totalsubsidi]"),N=t.down("[reference=totalpiutang]"),n=t.down("[reference=totaldiskon]"),S=t.down("[reference=totalnon]"),m=t.down("[reference=totalbulat]"),j=t.down("[reference=totaltunai]"),h=t.down("[reference=totaluangmuka]"),M=t.down("[reference=sisapembayaran]");r.set("viewConfig.tagihanHak",false);t.down("[reference=cetakrekapdanrincian]").setHidden(!y("1213",false));if(w){var E=t.getReferensi(w.data,"KWITANSI_PEMBAYARAN");if(E){Ext.Array.each(E,function(X){p.loadRecord(Ext.create("data.model.KwitansiPembayaran",X));p.setFormConfig({viewOnly:true,cetak:!y("121301",false)?false:true})})}else{p.setFormConfig({cetak:y("121301",false)});p.createRecord({TAGIHAN:w.get("ID")})}var K=w.get("TOTAL"),b=0,O=w.get("PEMBULATAN"),c=t.hitungTotalJaminan(w),U=t.hitungTotalSubsidi(w),V=t.hitungTotalPiutang(w),g=t.hitungTotalDiskon(w),C=t.hitungTotalNonTunai(w),l=t.hitungTotalUangMuka(w),z=t.getPenjamin(w,2),G=0;r.set("tagihan",w);if(z){var v=t.getInfoInacbg(w),q=t.getPropertyConfig("59"),s=Ext.Date.format(w.get("TANGGAL"),"Y-m-d"),x=q=="NULL";if(!x){x=s<q}if(z.NAIK_KELAS==1){K=Number(z.TOTAL_NAIK_KELAS);r.set("info","<span style='color: maroon; font-size: 14px'>Tagihan ini menggunakan perhitungan <br/>Selisih (tarif INA-CBG Naik Kelas - Tarif INA-CBG Hak Kelas)</span>"+v)}if(x){if(z.NAIK_KELAS_VIP==1){K=Number(z.TOTAL_NAIK_KELAS);var B=Number(t.getPropertyConfig("16")),o=t.getPropertyConfig("20")=="TRUE",D=t.getPropertyConfig("57")=="TRUE",G=Number(z.SELISIH_MINIMAL),u=Number(z.TARIF_INACBG_KELAS1),f=Number(z.PERSENTASE_TARIF_INACBG_KELAS1),R=Number(z.TOTAL_TAGIHAN_VIP),T="<span style='color: maroon; font-size: 14px'>Tagihan ini menggunakan perhitungan <br/>Selisih (tarif INA-CBG Kelas 1 - Tarif INA-CBG Hak Kelas) + <br/>";K+=G;if(B==0||o){if(D){T+="Mana yang lebih kecil: [Tarif INA-CBG Kelas 1 x 75%] atau [Total Tagihan VIP (Akomodasi + Visite)]<br>["+Ext.util.Format.number(u,"0,00")+" x 75%] = ["+Ext.util.Format.number(R,"0,00")+"]</span>"}else{var L=u*(f/100);T+="(Tarif INA-CBG Kelas 1 x "+f+"%) = ("+Ext.util.Format.number(u,"0,00")+" x "+f+"%) = "+Ext.util.Format.number(L,"0,00")+"</span>"}}else{T+="((Tarif INA-CBG Kelas 1 x "+B+"%) >= (Tarif RS - Tarif INA-CBG Kelas 1) = (Tarif INA-CBG Kelas 1 x "+B+"%)) </br>((Tarif RS - Tarif INA-CBG Kelas 1) >= (Tarif INA-CBG Kelas 1 x 75%) = (Tarif INA-CBG Kelas 1 x 75%))</br>((Tarif RS - Tarif INA-CBG Kelas 1) > (Tarif INA-CBG Kelas 1 x "+B+"%) & <= (Tarif INA-CBG Kelas 1 x 75%) = (Tarif RS - Tarif INA-CBG Kelas 1))</span>"+v}r.set("info",T)}if(z.NAIK_DIATAS_VIP==1){if(z.TOTAL_TAGIHAN_HAK>0){r.set("viewConfig.tagihanHak",true);b=Number(z.TOTAL_TAGIHAN_HAK)}r.set("info","<span style='color: maroon; font-size: 14px'>Tagihan ini menggunakan perhitungan<br/>(tarifrs - jaminan inacbg hak kelas) = selisih bayar<br/>jika ada selisih bayar maka (jaminan inacbg hak kelas > tagihan hak maka (tarifrs - jaminan inacbg hak kelas))<br/>atau (jaminan inacbg hak kelas < tagihan hak maka (tarifrs - tagihan hak))<br/>subsidi = tagihan hak - jaminan inacbg hak kelas</span>"+v)}if(t.getPropertyConfig("9")=="TRUE"){if(z.NAIK_KELAS==1||z.NAIK_KELAS_VIP==1||z.NAIK_DIATAS_VIP==1){K=Number(z.TOTAL_NAIK_KELAS);U=0;b=0;r.set("info","<span style='color: maroon; font-size: 14px'>KEBIJAKAN RS:<br/>Tagihan ini menggunakan perhitungan <br/>Selisih (Total Akomodasi Naik Kelas - Total Akomodasi Hak Kelas)</span>"+v)}}}else{if(z.NAIK_KELAS_VIP==1||z.NAIK_DIATAS_VIP==1){K=Number(z.TOTAL_NAIK_KELAS);var i=t.getPropertyConfig("60"),G=Number(z.SELISIH_MINIMAL),u=Number(z.TARIF_INACBG_KELAS1),f=Number(z.PERSENTASE_TARIF_INACBG_KELAS1),R=i==2?Number(z.TOTAL_TAGIHAN_VIP_AKOMODASI_DAN_VISITE):Number(z.TOTAL_TAGIHAN_VIP),a=u*(75/100),A=Number(w.get("TOTAL"))-Number(z.TOTAL),J=R<a?R:a,H=u-Number(z.TOTAL),F=A+H;ketentuan="<br><br><i><span style='color: red'>Ketentuan selisih biaya hak rawat kelas 1 naik kelas diatas kelas 1 dan hak kelas rawat 2 ke kelas diatas kelas 1 tidak berlaku apabila pelayanan rawat inap tidak melebihi tarif INA-CBG sesuai hak peserta</span></i>",K+=G;T="<h3>PERHITUNGAN SELISIH BIAYA MODE: "+i+"</h3>";T+="<div style='font-size: 14px'><h4>Peserta Hak Kelas "+(z.KELAS_KLAIM==3?"1":"2")+" naik ke Kelas di atas Kelas 1:</h4><table border=0><tr><td>a. Tarif Rill Fasyankes</td><td>: Rp. "+Ext.util.Format.number(Number(w.get("TOTAL")),"0,00")+"</td></tr><tr><td>b. Tarif VIP "+(i==2?"(akomodasi + visite dokter & perawat)":"")+"</td><td>: Rp. "+Ext.util.Format.number(R,"0,00")+"</td></tr><tr><td>c. Tarif INA-CBG Kelas 1</td><td>: Rp. "+Ext.util.Format.number(u,"0,00")+"</td></tr><tr><td>d. Tarif INA-CBG Hak Kelas "+(z.KELAS_KLAIM==3?"1":"2")+"</td><td>: Rp. "+Ext.util.Format.number(Number(z.TOTAL),"0,00")+"</td></tr></table><h4>Perhitungan selisih biaya:</h4><table border=0><tr><td>e. Selisih INA-CBG Kelas 1 di kurangi INA-CBG Hak Kelas "+(z.KELAS_KLAIM==3?"1":"2")+":</td><td></td></tr><tr><td>Rp. "+Ext.util.Format.number(u,"0,00")+" - Rp. "+Ext.util.Format.number(Number(z.TOTAL),"0,00")+"</td><td>= Rp. "+Ext.util.Format.number(H,"0,00")+"</td></tr><tr><td>f. Maksimal 75% dari Tarif INA-CBG Kelas 1:</td><td></td></tr><tr><td>75% x Rp. "+Ext.util.Format.number(u,"0,00")+"</td><td>= Rp. "+Ext.util.Format.number(a,"0,00")+"</td></tr><tr><td>g. Selisih Tarif Rill Fasyankes di kurangi INA-CBG Hak Kelas "+(z.KELAS_KLAIM==3?"1":"2")+":</td><td></td></tr><tr><td>Rp. "+Ext.util.Format.number(Number(w.get("TOTAL")),"0,00")+" - Rp. "+Ext.util.Format.number(Number(z.TOTAL),"0,00")+"</td><td>= Rp. "+Ext.util.Format.number(A,"0,00")+"</td></tr></table><h3>Peserta bayar:</h3><table border=0>";if(A>0){if(i==1||i==2){T+="<tr><td>h. Mana lebih kecil (b atau f): </td><td></td></tr><tr><td>Rp. "+Ext.util.Format.number(R,"0,00")+" atau Rp. "+Ext.util.Format.number(a,"0,00")+"</td><td>= <span style='color: green; font-size: 14px; font-weight: bold'>Rp. "+Ext.util.Format.number(J,"0,00")+"</span></td></tr>"}if(i==3){J=A<(H+a)?A:(H+a);T+="<tr><td>h. Mana lebih kecil (g atau (e + f)) </td><td></td></tr><tr><td>(Rp. "+Ext.util.Format.number(A,"0,00")+" atau (Rp. "+Ext.util.Format.number(H,"0,00")+" + Rp. "+Ext.util.Format.number(a,"0,00")+" = Rp. "+Ext.util.Format.number(H+a,"0,00")+"))</td><td>= <span style='color: green; font-size: 14px; font-weight: bold'>Rp. "+Ext.util.Format.number(J,"0,00")+"</span></td></tr>"}if(i==4){var e=u*((Number(w.get("TOTAL"))-u)/u);J=(e<a?e:a)+H;T+="<tr><td>h. ((Mana lebih kecil (c * ((a - c) / c)) atau f) + e) </td><td>:</td></tr><tr><td>(((Rp. "+Ext.util.Format.number(u,"0,00")+" * ((Rp. "+Ext.util.Format.number(Number(w.get("TOTAL")),"0,00")+" - Rp. "+Ext.util.Format.number(u,"0,00")+") / Rp. "+Ext.util.Format.number(u,"0,00")+") = Rp. "+Ext.util.Format.number(e,"0,00")+") atau Rp. "+Ext.util.Format.number(a,"0,00")+") + Rp. "+Ext.util.Format.number(H,"0,00")+")</td><td>= <span style='color: green; font-size: 14px; font-weight: bold'>Rp. "+Ext.util.Format.number(J,"0,00")+"</span></td></tr>"}if(i==5){J=F<a?F:a;T+="<tr><td>h. Mana lebih kecil ((g + e) atau f) </td><td>:</td></tr><tr><td>(Rp. "+Ext.util.Format.number(A,"0,00")+" + Rp. "+Ext.util.Format.number(H,"0,00")+" = Rp. "+Ext.util.Format.number(F,"0,00")+") atau Rp. "+Ext.util.Format.number(a,"0,00")+"</td><td>= <span style='color: green; font-size: 14px; font-weight: bold'>Rp. "+Ext.util.Format.number(J,"0,00")+"</span></td></tr>"}}else{T+="<tr><td><b><i>h. Karena g <= 0 maka pasien tidak dikenakan iur biaya </i><b></td><td><span style='color: green; font-size: 14px; font-weight: bold'>Rp. 0</span></td></tr>";J=0}T+="</table><h3>Total Biaya yang di terima Fasyankes:</h3><table border=0><tr><td>d + h = Rp. "+Ext.util.Format.number(Number(z.TOTAL),"0,00")+" + Rp. "+Ext.util.Format.number(J,"0,00")+"</td><td>= <span style='color: green; font-size: 14px; font-weight: bold'>Rp. "+Ext.util.Format.number(Number(z.TOTAL)+J,"0,00")+"</span></td></tr></table></div>";r.set("info",v+T+ketentuan)}}}var I=K-c-U-V-g-C;I=I<0?0:I;I=Number(I)+Number(O);k.setValue(K);P.setValue(b);Q.setValue(c);W.setValue(U);N.setValue(V);n.setValue(g);S.setValue(C);m.setValue(O);j.setValue(I);h.setValue(l);M.setValue(I-l);r.set("total",I);w.set("TOTAL_TUNAI",I);if(y){r.set("viewConfig.cetakKuitansi",y("121301",false));if(!y("1201",false)){r.set("viewConfig.tagihanFinal",false);return}}r.set("viewConfig.tagihanFinal",w.get("STATUS")==1)}},getInfoInacbg:function(b){var d=this,e=d.getReferensi(b.getData(),"TAGIHAN_PENDAFTARAN"),c=null,a="";if(e){if(Ext.isArray(e)){e.forEach(function(g){var f=d.getReferensi(g,"PENDAFTARAN"),h=d.getReferensi(f,"INACBG");if(h){c=h}})}}if(c){a+="<div style='font-size: 14px'><h3>INFO TARIF INA-CBG:</h3><table border=0><tr><td>Sub Acute</td><td>: "+Ext.util.Format.number(c.TARIFSA,"0,000")+"</td></tr><tr><td>Chronic</td><td>: "+Ext.util.Format.number(c.TARIFSC,"0,000")+"</td></tr><tr><td>Special Procedur</td><td>: "+Ext.util.Format.number(c.TARIFSP,"0,000")+"</td></tr><tr><td>Special Prosthesis</td><td>: "+Ext.util.Format.number(c.TARIFSR,"0,000")+"</td></tr><tr><td>Special Investigation</td><td>: "+Ext.util.Format.number(c.TARIFSI,"0,000")+"</td></tr><tr><td>Special Drug</td><td>: "+Ext.util.Format.number(c.TARIFSD,"0,000")+"</td></tr><tr><td>Tarif Kelas 1</td><td>: "+Ext.util.Format.number(c.TARIFKLS1,"0,000")+"</td></tr><tr><td>Tarif Kelas 2</td><td>: "+Ext.util.Format.number(c.TARIFKLS2,"0,000")+"</td></tr><tr><td>Tarif Kelas 3</td><td>: "+Ext.util.Format.number(c.TARIFKLS3,"0,000")+"</td></tr><tr><td><b>Total Tarif</b></td><td>: <b>"+Ext.util.Format.number(c.TOTALTARIF,"0,000")+"</b></td></tr></table></div>"}return a},hitungTotalJaminan:function(b){var c=0,a=this.getReferensi(b.data,"PENJAMIN_TAGIHAN");if(a){Ext.Array.each(a,function(d){c+=Number(d.TOTAL)})}return c},getPenjamin:function(c,d){var b=this.getReferensi(c.data,"PENJAMIN_TAGIHAN"),a=undefined;if(b){Ext.Array.each(b,function(e){if(e.PENJAMIN==d){a=e}})}return a},hitungTotalUangMuka:function(b){var c=0,a=this.getReferensi(b.data,"DEPOSIT"),d=this.getReferensi(b.data,"PENGEMBALIAN_DEPOSIT");if(a){Ext.Array.each(a,function(e){if(e.JENIS==1){c+=Number(e.TOTAL)}else{c-=Number(e.TOTAL)}})}if(d){Ext.Array.each(d,function(e){c-=Number(e.TOTAL)})}return c},hitungTotalPiutang:function(b){var d=0,c=this.getReferensi(b.data,"PIUTANG_PASIEN"),a=this.getReferensi(b.data,"PIUTANG_PERUSAHAAN");if(c){Ext.Array.each(c,function(e){d+=Number(e.TOTAL)})}if(a){Ext.Array.each(a,function(e){d+=Number(e.TOTAL)})}return d},hitungTotalDiskon:function(b){var c=0,d=this.getReferensi(b.data,"DISKON"),a=this.getReferensi(b.data,"DISKON_DOKTER");if(d){Ext.Array.each(d,function(e){c+=(Number(e.ADMINISTRASI)+Number(e.AKOMODASI)+Number(e.SARANA_NON_AKOMODASI)+Number(e.PARAMEDIS))})}if(a){Ext.Array.each(a,function(e){c+=Number(e.TOTAL)})}return c},hitungTotalNonTunai:function(b){var c=0,a=this.getReferensi(b.data,"NON_TUNAI");if(a){Ext.Array.each(a,function(d){c+=Number(d.TOTAL)})}return c},hitungTotalSubsidi:function(a){var b=0,c=this.getReferensi(a.data,"SUBSIDI_TAGIHAN");if(c){Ext.Array.each(c,function(d){if(d.STATUS==1){b+=Number(d.TOTAL)}})}return b}});Ext.define("pembayaran.tagihan.InfoController",{extend:"Ext.app.ViewController",alias:"controller.tagihan-info",onHitungUlang:function(c){var e=this,a=e.getView(),d=e.getViewModel(),f=d.get("tagihan"),b=Ext.create("data.model.Tagihan",{ID:f.get("ID")});if(f.get("KUNCI")==0&&a.getPropertyConfig(69)=="TRUE"){a.notifyMessage("Silahkan kunci tagihan terlebih dahulu","danger-blue");return}b.set("HITUNGULANG",1);a.ownerCt.setLoading(true);b.animateTarget=c;b.scope=e;b.showError=true;b.timeout=600000;b.save({callback:function(i,g,h){if(h){a.fireEvent("hitungtagihan")}a.ownerCt.setLoading(false)}})},onFinalTagihan:function(p){var k=this,b=k.getViewModel(),m=k.getView(),a=b.get("tagihan"),n=m.getReferensi(a.getData(),"TAGIHAN_PENDAFTARAN"),g=null,h=m.getReferensi(a.data,"PASIEN"),c=m.app,o="",f=c?c.xpriv:false,j=c?(c.trxksr?c.trxksr:false):false;if(!f("1201",false)){m.notifyMessage("Anda tidak memiliki hak akses untuk melakukan Tagihan Final","danger-blue");return}if(!j){m.notifyMessage("Anda belum membuka transaksi kasir / open cashier","danger-blue");return}if(a.get("KUNCI")==0&&m.getPropertyConfig(69)=="TRUE"){m.notifyMessage("Silahkan kunci tagihan terlebih dahulu<br>kemudian hitung ulang dan lakukan final tagihan","danger-blue");return}n.forEach(function(q){if(q.UTAMA==1){o=q.PENDAFTARAN;g=m.getReferensi(q,"KUNJUNGAN")}});if(g==null){var e=Ext.create("kunjungan.List",{ui:"panel-cyan",showCloseButton:true,title:"History Kunjungan Pasien "+h.get("NAMA")+"("+h.get("NORM")+")"}),i=true;e.setListConfig({paging:false,hiddenPencarian:true,hiddenLihatAction:true,hiddenFinalAction:false});e.setParams({TAGIHAN:a.get("ID"),JENIS_KUNJUNGAN:"!3",STATUS:1});if(f("1215",false)){var d=Ext.create("pendaftaran.penerimaanlayanan.List",{ui:"panel-cyan",showCloseButton:true,title:"Daftar Penerimaan Layanan yang belum di terima an. Pasien "+h.get("NAMA")+"("+h.get("NORM")+")"}),l=true;d.load({NOPEN:o,STATUS:1});d.doAfterLoad=function(q,s,t,r){if(t){if(s.length>0){if(l){l=false;m.openDialog("",true,"70%","60%",d,function(u,v){k.windowDlgPl=v})}return}}if(k.windowDlgPl){k.windowDlgPl.close()}e.load()}}else{e.load()}e.doAfterLoad=function(q,s,t,r){if(t){if(s.length>0){if(i){i=false;m.openDialog("",true,"90%","70%",e,function(u,v){k.windowDlg=v;v.on("close",function(){m.fireEvent("afterfinalkunjungan")})})}}else{if(k.windowDlg){k.windowDlg.close()}k.finalTagihanPopup(k,m,p)}}else{if(k.windowDlg){k.windowDlg.close()}k.finalTagihanPopup(k,m,p)}}}else{k.finalTagihanPopup(k,m,p)}},finalTagihanPopup:function(c,a,b){a.showMessageBox({title:"Finalkan Tagihan",message:"Anda yakin ingin memfinalkan tagihan ini ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"no",animateTarget:b,fn:function(d){if(d==="yes"){c.finalTagihan(b)}}})},finalTagihan:function(j){var g=this,b=g.getViewModel(),i=g.getView(),c=i.app,e=c?c.xpriv:false,f=c?(c.trxksr?c.trxksr:false):false,a=b.get("tagihan"),h=b.get("total"),d=Ext.create("pembayaran.pembayarantagihan.Model",{TAGIHAN:a.get("ID"),JENIS:1,TUNAI:1,REF:f,TRANSAKSI_KASIR_NOMOR:f,TOTAL:h,STATUS:2});i.ownerCt.setLoading(true);j.setDisabled(true);d.animateTarget=j;d.scope=g;d.showError=true;d.save({callback:function(m,k,l){if(l){i.notifyMessage("Tagihan telah di finalkan","danger-blue");b.set("viewConfig.tagihanFinal",false);b.set("pembayaran",d);a.set("STATUS",2);if(h>0){if(e("121301",false)){i.showMessageBox({title:"Cetak Kwitansi",message:"Anda ingin mencetak kwitansi ?",ui:"window-cyan",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:j,fn:function(n){if(n==="yes"){g.onCetakKwitansi()}}})}}}i.ownerCt.setLoading(false);j.setDisabled(false)}})},onCetakKwitansi:function(){var d=this,a=d.getView(),c=d.getViewModel(),b=d.getReferences(),e=c.get("tagihan");if(e.get("STATUS")==1){a.notifyMessage("Silahkan lakukan final tagihan terlebih dahulu...");return}a.openDialog("",true,100,50,{xtype:"kwitansi-form",title:"Kwitansi",ui:"panel-cyan",showCloseButton:true},function(f,h){var g=h.down("kwitansi-form");g.setFormConfig({viewOnly:false,cetak:true});g.createRecord({TAGIHAN:e.get("ID"),STATUS:1});g.on("cetak",function(i){b.kwitansi.loadRecord(i);h.close()})})},onCetak:function(a){this.cetakRincian(a.rptName)},privates:{cetakRincian:function(f){var e=this,a=e.getView(),h=e.getViewModel().get("tagihan"),b="Word",d="docx",g=true,c="Cetak Rincian";a.showMessageBox({title:c,message:"Tekan tombol Yes/Ya utk cetak langsung<br/>Tekan tombol No/Tidak untuk Preview",ui:"window-cyan",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:e,fn:function(i){if(i!="yes"){b="Pdf";d="pdf";g=false}a.cetak({NAME:"pembayaran."+f,TYPE:b,EXT:d,PARAMETER:{PTAGIHAN:h.get("ID"),PKASIR:a.app.usrNm,PSTATUS:1},REQUEST_FOR_PRINT:g,PRINT_NAME:"CetakRincian"},function(j){a.printPreview(c,j)})}})}},onInfo:function(b){var d=this,a=d.getView(),c=d.getViewModel();if(c.get("info")==""){a.notifyMessage("Tagihan ini tidak memiliki informasi")}else{a.openWindow({modal:true,title:"Informasi Tagihan",closable:true,maximized:false,width:"40%",height:"90%",animateTarget:b,border:false,constrain:d,layout:"fit",header:{iconCls:"x-fa fa-info",margin:0,padding:"10 15 10 15"},items:{xtype:"component",padding:20,html:c.get("info")}})}}});Ext.define("pembayaran.tagihan.Links",{extend:"com.Tab",alias:"widget.tagihan-links",cls:"x-br-top",ui:"header-tab",items:[{title:"Rincian",xtype:"workspace-rincian",iconCls:"x-fa fa-list-alt",listeners:{afterfinalkunjungan:"onAfterFinalKunjungan"}},{title:"Deposit",xtype:"workspace-deposit",listeners:{load:"onReload"},iconCls:"x-fa fa-dollar"},{title:"Penjamin",xtype:"workspace-penjamintagihan",iconCls:"x-fa fa-user-secret",listeners:{load:"onReload"}},{title:"Piutang",xtype:"workspace-piutang",iconCls:"x-fa fa-money",listeners:{load:"onReload"}},{title:"Non Tunai",xtype:"workspace-nontunai",jenis:2,notLoadLinks:true,listeners:{load:"onReload"},iconCls:"x-fa fa-credit-card"},{title:"Discount",xtype:"workspace-discount",listeners:{load:"onReload"},iconCls:"x-fa fa-unlink"},{title:"Info Pembayaran",xtype:"pembayaran-pembayarantagihan-workspace",listeners:{load:"onReload"},iconCls:"x-fa fa-info"}],load:function(b){var c=this;var a=c.getActiveTab();if(a){if(a.loadRecord){a.loadRecord(b)}else{if(a.load){a.load(b)}}}}});Ext.define("pembayaran.tagihan.List",{extend:"com.Grid",alias:"widget.tagihan-list",controller:"tagihan-list",viewModel:{stores:{store:{type:"tagihan-store"}}},hideHeaders:true,initComponent:function(){var a=this;a.columns=[{xtype:"templatecolumn",flex:2,tpl:new Ext.XTemplate("{[this.info(values)]}",{info:function(m){var f=this,h='<div style="font-weight: bold; font-size: 12px; white-space:normal !important;">{TAGIHAN_ID} - {TAGIHAN_TANGGAL} {STATUS}</div>',e='<div style="font-weight: bold; white-space:normal !important; border-top: .5px dashed gray">{GABUNG_KE}</div><div style="white-space:normal !important;">Pendaftaran: {PENDAFTARAN}</div><div style="white-space:normal !important;">{RUANGAN}</div>',d='<div style="font-size: 12px; white-space:normal !important; border-top: .5px dashed gray">{PENJAMIN}</div>',c='<div style="font-size: 14px; font-weight: bold; color: [COLOR_VALUE]; white-space:normal !important;">[FIELD]</div>',g="black",l="",k="",j="",i="",n=a.getReferensi(m,"TAGIHAN_PENDAFTARAN"),b=n?n:[];l=h.replace("{TAGIHAN_ID}",m.ID);l=l.replace("{TAGIHAN_TANGGAL}",f.tanggalFormat(m.TANGGAL));b.forEach(function(C,D){var w=f.getReferensi(C,"PENDAFTARAN"),I=w.PENJAMIN?w.PENJAMIN:null,O=w?(w.TUJUAN?w.TUJUAN:null):null,q=a.getReferensi(O,"RUANGAN"),r=a.getReferensi(q,"JENIS_KUNJUNGAN"),p=f.getReferensi(w,"INACBG");k+=e.replace("{GABUNG_KE}","");k=k.replace("{PENDAFTARAN}",w.NOMOR+" - "+f.tanggalFormat(w.TANGGAL)+" | "+r.DESKRIPSI);if(q){if(q.JENIS_KUNJUNGAN==3){var B=f.getReferensi(w,"KUNJUNGAN_MASUK"),A=f.getReferensi(B,"RUANGAN"),z=f.getReferensi(A,"RUANG_KAMAR_TIDUR"),L=f.getReferensi(z,"RUANG_KAMAR"),N=f.getReferensi(w,"KUNJUNGAN_KELUAR"),J=f.getReferensi(N,"RUANGAN"),H=f.getReferensi(N,"RUANG_KAMAR_TIDUR"),s=f.getReferensi(H,"RUANG_KAMAR"),G=q.DESKRIPSI;if(O.STATUS==1){G+=' | <span style="color: orange">Belum di terima di ruangan</span>'}if(O.STATUS==0){G+=' | <span style="color: red">Tujuan ruangan dibatalkan</span>'}if(A){G=A.DESKRIPSI}if(z){G+=" | "+L.KAMAR+" | "+L.TEMPAT_TIDUR}if(J){if(J.ID!=A.ID){G="<b>Ruangan Awal:</b> "+G+"<br><b>Ruangan Akhir:</b> "+J.DESKRIPSI}if(H){G+=" | "+s.KAMAR+" | "+H.TEMPAT_TIDUR}G+="<br>Tgl. Keluar: "+(N.KELUAR?f.tanggalFormat(N.KELUAR):"")}k=k.replace("{RUANGAN}",G)}else{var K=q.DESKRIPSI,x=a.getReferensi(C,"KUNJUNGAN"),o=a.getReferensi(x,"RUANGAN");K=o?o.DESKRIPSI:K;k=k.replace("{RUANGAN}",K)}}if(C.UTAMA==1){var F=f.getReferensi(I,"JENIS_PENJAMIN"),v=f.getReferensi(I,"KELAS"),M=f.getReferensi(I,"KAP"),E=f.getReferensi(I,"JENIS_PESERTA"),P=F?F.DESKRIPSI:"",y=v?v.DESKRIPSI:"",u=P+(I.JENIS!=1?" - "+y:""),G="";if(M&&I.JENIS!=1){u+=" | "+M.NOMOR+" | "+I.NOMOR;if(E){u+=" | "+E.DESKRIPSI}}j=d.replace("{PENJAMIN}",u);if(F.CONFIG){g="red";G="Belum di Grouping";if(p){g="orange";G="Sudah Grouping belum Final";if(p.STATUS==1){g="green";G="Sudah Grouping Final"}}}if(G!=""){i=c.replace("[FIELD]",G).replace("[COLOR_VALUE]",g)}}});l+=k;l+=j;l+=i;l=l.replace("{STATUS}",b.length>1?'| <span style="color: red; font-weight: bold">Gabungan Tagihan</span>':"");return l}})},{xtype:"templatecolumn",flex:1,bind:{hidden:"{!listConfig.pasienInfo}"},tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 12px; white-space:normal !important;">{[this.getFormatNorm(values.REFERENSI.PASIEN.NORM)]} </div>','<div style="font-size: 12px; white-space:normal !important;">{[values.REFERENSI.PASIEN.NAMA]}</div>')},{xtype:"templatecolumn",flex:1,align:"right",tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 18px; white-space:normal !important;">{[this.getTotal(values)]} </div>',{getTotal:function(g){var q=Number(g.TOTAL),j=q,i=Number(g.PEMBULATAN),n=a.getReferensi(g,"PENJAMIN_TAGIHAN"),b=a.getReferensi(g,"DEPOSIT"),p=a.getReferensi(g,"PENGEMBALIAN_DEPOSIT"),d=a.getReferensi(g,"PIUTANG_PASIEN"),h=a.getReferensi(g,"PIUTANG_PERUSAHAAN"),f=a.getReferensi(g,"DISKON"),k=a.getReferensi(g,"DISKON_DOKTER"),c=a.getReferensi(g,"NON_TUNAI"),l=a.getReferensi(g,"SUBSIDI_TAGIHAN"),o=null,m=0,e=0;if(n){Ext.Array.each(n,function(r){m+=Number(r.TOTAL);if(r.PENJAMIN==2){o=r}})}if(o){if(o.NAIK_KELAS==1){j=Number(o.TOTAL_NAIK_KELAS)}if(o.NAIK_KELAS_VIP==1){j=Number(o.TOTAL_NAIK_KELAS);j+=Number(o.SELISIH_MINIMAL)}if(a.getPropertyConfig("9")=="TRUE"){if(o.NAIK_KELAS==1||o.NAIK_KELAS_VIP==1||o.NAIK_DIATAS_VIP==1){j=Number(o.TOTAL_NAIK_KELAS);e=0}}}j-=m;if(l){Ext.Array.each(l,function(r){j-=Number(r.TOTAL)})}if(b){Ext.Array.each(b,function(r){if(r.JENIS==1){j-=Number(r.TOTAL)}else{j+=Number(r.TOTAL)}})}if(p){Ext.Array.each(p,function(r){j+=Number(r.TOTAL)})}if(d){Ext.Array.each(d,function(r){j-=Number(r.TOTAL)})}if(h){Ext.Array.each(h,function(r){j-=Number(r.TOTAL)})}if(f){Ext.Array.each(f,function(r){j-=(Number(r.ADMINISTRASI)+Number(r.AKOMODASI)+Number(r.SARANA_NON_AKOMODASI)+Number(r.PARAMEDIS))})}if(k){Ext.Array.each(k,function(r){j-=Number(r.TOTAL)})}if(c){Ext.Array.each(c,function(r){j-=Number(r.TOTAL)})}j=j+i;return Ext.util.Format.number(j<0?0:j,"0,000")}})},{xtype:"widgetcolumn",text:"Status",align:"center",width:60,bind:{hidden:"{!listConfig.view}"},widget:{xtype:"fieldcontainer",defaults:{padding:2},items:[{xtype:"button",text:"View",action:0,margin:"0 1 0 0",handler:"onView"}]}}];a.callParent()},loadStore:function(a){if(a){if(a.NORM){a.REF=a.NORM;a.JENIS=1;a.STATUS=1;delete a.NORM}this.load(a)}},onBeforeLoad:function(c,b,a){c.setParams({REFERENSI:Ext.JSON.encode({Diskon:true,DiskonDokter:true,NonTunai:true,PenjaminTagihan:true,PiutangPasien:true,PiutangPerusahaan:true,Deposit:true,PengembalianDeposit:true,KwitansiPembayaran:true,SubsidiTagihan:true,TagihanPendaftaran:{REFERENSI:{Pendaftaran:{REFERENSI:{TujuanPasien:{REFERENSI:{Ruangan:true}},Penjamin:true,Kunjungan:true,PasienPulang:true,Inacbg:{REFERENSI:false}}},Kunjungan:true}}})})}});Ext.define("pembayaran.tagihan.ListController",{extend:"Ext.app.ViewController",alias:"controller.tagihan-list",onView:function(a){var b=this,c=a.ownerCt.getWidgetRecord();b.getView().fireEvent("viewtagihan",c)},onSearch:function(){var b=this,a=b.getView();a.openDialog("Pencarian Tagihan",true,300,50,{xtype:"form",title:"Pencarian Nomor Tagihan",bodyPadding:5,items:[{xtype:"search-field",anchor:"100%"}]},function(e,d){var c=d.down("search-field");c.on("search",function(f,g){if(g.trim()!=""){a.setLoading(true);a.loadStore({ID:g});a.onAfterLoad=function(j,i,k,h){if(Ext.isArray(i)){if(i.length>0){d.close()}}}}});c.focus(false,100)})}});Ext.define("pembayaran.tagihan.Workspace",{extend:"com.Form",xtype:"workspace-tagihan",controller:"workspace-tagihan",viewModel:{data:{pasien:undefined,tagihan:undefined,allowBatalFinal:false},formulas:{getNamaLengkap:function(e){var d=e("pasien.GELAR_DEPAN")||"",f=e("pasien.GELAR_BELAKANG")||"";d=d==""?"":d+". ";f=f==""?"":", "+f;return d+e("pasien.NAMA")+f},getFormatNorm:function(d){var c=d("pasien.NORM")||0;if(c>0){return this.toFormatNorm(c)}return""},getFormatTagihan:function(e){var f=e("tagihan.ID")+"",d=f?f.substring(0,6)+"."+f.substring(6):"";return d},getInfoTanggal:function(c){var f=c("tagihan.TANGGAL"),e=f?Ext.Date.format(f,"d F Y H:i:s"):"";return e},isAllowBatalFinal:function(a){var c=a("tagihan.STATUS")==2,b=a("allowBatalFinal");if(!c){return false}return b}},toFormatNorm:function(d){var e=Ext.String.leftPad(d,8,"0"),f=Ext.String.insert(Ext.String.insert(Ext.String.insert(e,".",2),".",5),".",8);return f}},layout:"border",border:false,bind:{title:"Tagihan Pasien An. <b>{getNamaLengkap} - {getFormatNorm}</b>"},header:{itemPosition:1,items:[{xtype:"component",bind:{html:"<strong>No. Tagihan: {getFormatTagihan} / {getInfoTanggal}</strong>"},margin:"0 5 0 0"},{xtype:"button",iconCls:"x-fa fa-chain-broken",tooltip:"Batalkan Final",bind:{hidden:"{!isAllowBatalFinal}"},ui:"soft-red",handler:"onBatalFinal"},{xtype:"button",ui:"soft-asperages",iconCls:"x-fa fa-refresh",tooltip:"Perbarui Data",handler:"onReload"}]},bodyPadding:0,items:[{region:"center",xtype:"tagihan-links",reference:"listtagihanlinks",listeners:{tabchange:"onTabChange"}},{region:"east",title:"Info Tagihan",iconCls:"x-fa fa-list",split:true,collapsible:true,xtype:"tagihan-info",reference:"tagihandetail",listeners:{hitungtagihan:"onHitungTagihan",afterfinalkunjungan:"onAfterFinalKunjungan"}}],load:function(d,g){var f=this,c=f.getViewModel(),b=f.down("tagihan-links"),a=b.getActiveTab(),h=f.app.xpriv("1208"),e=d.get("REFERENSI");c.set("pasien",g);c.set("tagihan",d);if(e){e.PASIEN=g}else{d.set("REFERENSI",{PASIEN:g})}if(a.notLoadLinks==undefined){b.load(d)}f.down("tagihan-info").load(d);c.set("allowBatalFinal",h)},onBeforeClose:function(d){var b=this,a=b.getViewModel(),c=a.get("tagihan");if(c.get("STATUS")==1){if(b.app.xpriv("1201",false)){b.showMessageBox({title:"Info",message:"Tagihan ini belum di finalkan...<br>Apakah anda ingin melakukan final tagihan?",ui:"window-red",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:b,fn:function(e){if(e==="yes"){d(false)}else{d(true)}}})}else{d(true)}}else{d(true)}}});Ext.define("pembayaran.tagihan.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-tagihan",onReload:function(f){var d=this,a=this.getView(),c=d.getViewModel(),b=c.get("tagihan"),e=c.get("pasien");a.setLoading(true);(new Ext.util.DelayedTask(function(){var g=Ext.create("data.model.Tagihan",{ID:b.get("ID")});g.load({callback:function(j,h,i){if(i){a.load(j,e)}if(Ext.isFunction(f)){f(j)}a.setLoading(false)}})})).delay(1500)},onTabChange:function(d,a){var c=this.getViewModel(),b=c.get("tagihan");if(a.loadRecord){a.loadRecord(b)}else{if(a.load){a.load(b)}}},onHitungTagihan:function(){this.onReload()},onAfterFinalKunjungan:function(){this.onReload()},onBatalFinal:function(c){var f=this,a=f.getView(),e=f.getViewModel(),d=e.get("tagihan"),b=true;if(a.app){b=!a.app.xpriv("1208")}if(b){a.notifyMessage("Anda tidak memiliki Hak Akses untuk melakukan Pembatalan tagihan final!");return}Ext.Msg.show({title:"Pembatalan Tagihan Final",message:"Anda yakin ingin membatalkan tagihan final?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,animateTarget:c,fn:function(g){if(g==="yes"){a.openDialog("",true,350,50,{xtype:"pembatalan-tagihan-form",title:"Pembatalan Tagihan Final"},function(h,j){var i=j.down("pembatalan-tagihan-form");i.on("save",function(m,k,l){f.onReload();j.close()});i.createRecord({TAGIHAN:d.get("ID"),JENIS:1,TANGGAL:a.getSysdate()})})}}})}});Ext.define("pembayaran.tagihan.deposit.Form",{extend:"com.Form",xtype:"deposit-form",controller:"deposit-form",model:"data.model.Deposit",defaults:{allowBlank:false},items:[{xtype:"fieldcontainer",fieldLabel:"Tanggal",layout:{type:"hbox"},defaults:{allowBlank:false},items:[{name:"TANGGAL",reference:"tanggal",flex:1,xtype:"datefield",emptyText:"[Tanggal]",format:"d/m/Y",margin:"0 1 0 0",bind:{readOnly:"{formConfig.viewOnly}",minValue:"{formConfig.minDate}",minValue:"{formConfig.maxDate}"}},{name:"WAKTU",reference:"waktu",width:105,xtype:"timefield",emptyText:"[Jam:Mnt:Dtk]",format:"H:i:s",hideTrigger:true,bind:{readOnly:"{formConfig.viewOnly}"}}]},{xtype:"textfield",anchor:"100%",fieldLabel:"Nama",name:"NAMA",enforceMaxLength:true,maxLength:75,bind:{readOnly:"{formConfig.viewOnly}"},emptyText:"[ Nama ]"},{xtype:"numberfield",fieldLabel:"Jumlah",name:"TOTAL",emptyText:"[ Rp. ]",minValue:0,bind:{readOnly:"{formConfig.viewOnly}"},hideTrigger:true},{xtype:"textarea",anchor:"100%",fieldLabel:"Keterangan",name:"KETERANGAN",emptyText:"[ Masukkan Keterangan ]",bind:{readOnly:"{formConfig.viewOnly}"}}],buttons:[{text:"Simpan",ui:"soft-blue",iconCls:"x-fa fa-save",handler:"onSimpan",bind:{hidden:"{!formConfig.simpan}"},tooltip:{text:"Simpan",mouseOffset:[0,-75]}},{text:"Reset",ui:"soft-red",iconCls:"x-fa fa-refresh",handler:"onReset",bind:{hidden:"{!formConfig.reset}"},tooltip:{text:"Reset",mouseOffset:[0,-75]}}],onLoadRecord:function(b,c){var a=b.down("[name=WAKTU]");a.setValue(c.get("TANGGAL"))},onBeforeGetRecord:function(b,d){var c=Ext.Date.clone(b.down("[reference=tanggal]").getValue()),a=b.down("[reference=waktu]").getValue();c.setHours(a.getHours());c.setMinutes(a.getMinutes());c.setSeconds(a.getSeconds());d.TANGGAL=c}});Ext.define("pembayaran.tagihan.deposit.FormController",{extend:"Ext.app.ViewController",alias:"controller.deposit-form",onSimpan:function(b){var c=this,a=c.getView();a.save(b,{},function(f,d,e){c.onReset()})},onReset:function(){var b=this,a=this.getView(),c=b.getViewModel().get("record");a.createRecord({TAGIHAN:c.get("TAGIHAN"),JENIS:c.get("JENIS"),TANGGAL:a.getSysdate(),TOTAL:0,STATUS:1});a.focus("NAMA")}});Ext.define("pembayaran.tagihan.deposit.List",{extend:"com.Grid",alias:"widget.deposit-list",controller:"deposit-list",viewModel:{data:{listConfig:{batal:true}},stores:{store:{type:"deposit-store"}}},border:false,columns:[{xtype:"rownumberer",text:"No",align:"left",width:60},{text:"Jenis Transaksi",dataIndex:"JENIS",width:120,renderer:"onRendererJenis"},{xtype:"datecolumn",text:"Tanggal",dataIndex:"TANGGAL",format:"d/m/Y H:i:s",width:140},{text:"Kasir",dataIndex:"OLEH",flex:1,renderer:"onRendererKasir"},{xtype:"templatecolumn",text:"Pembayar / Penerima",flex:1,tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 12px; white-space:normal !important;">{[values.NAMA]} </div>','<div style="font-size: 10px; white-space:normal !important;">{[values.KETERANGAN]}</div>')},{xtype:"numbercolumn",text:"Jumlah",dataIndex:"TOTAL",format:"0,00",align:"right",width:120},{xtype:"numbercolumn",text:"Saldo",format:"0,00",align:"right",width:120,renderer:"onRendererSaldo"},{xtype:"widgetcolumn",align:"center",text:"Status",width:110,bind:{hidden:"{!listConfig.batal}"},widget:{xtype:"fieldcontainer",flex:1,defaults:{padding:2},layout:"fit",items:[{xtype:"button",text:"Batalkan",action:0,handler:"onBatal"},{xtype:"button",text:"Dibatalkan",action:1,ui:"soft-red"}]},onWidgetAttach:"onWidgetAttach"},{text:"#",width:55,align:"center",xtype:"widgetcolumn",widget:{xtype:"button",iconCls:"x-fa fa-print",ui:"soft-green",tooltip:"Cetak Kuitansi",listeners:{click:"onCetakKwitansi"}}}]});Ext.define("pembayaran.tagihan.deposit.ListController",{extend:"Ext.app.ViewController",alias:"controller.deposit-list",onRendererJenis:function(d,b,c){var a=c.get("REFERENSI"),e=a?(a.JENIS?a.JENIS.DESKRIPSI:d):d;return e},onRendererKasir:function(e,c,d){var b=d.get("REFERENSI"),a=b?(b.PENGGUNA?b.PENGGUNA.NAMA:e):e;return a},onRendererSaldo:function(a,g,b,e,j,f){var d=0;for(var c=0;c<=e;c++){var h=f.getAt(c);if(h.get("JENIS")==1&&h.get("STATUS")==1){d+=h.get("TOTAL")}else{if(h.get("STATUS")==1){d-=h.get("TOTAL")}}}return Ext.util.Format.number(d,"0,00")},onWidgetAttach:function(h,b,g){var e=this,c=e.getViewModel().get("listConfig.batal"),a=g.get("STATUS"),i=b.down("[action=0]"),f=b.down("[action=1]");i.setHidden(a!=1);f.setHidden(!(a==0));if(!c){i.setHidden(true)}},onBatal:function(b){var d=this,a=d.getView(),e=b.ownerCt.getWidgetRecord();if(e){var c=e.get("REFERENSI"),f=c?(c.JENIS?c.JENIS.DESKRIPSI:""):"";e.showError=true;e.animateTarget=b;e.scope=d;a.showMessageBox({title:"Pembatalan "+f+" Deposit",message:"Anda yakin ingin membatalkan "+f+" Deposit ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:b,fn:function(g){if(g==="yes"){e.set("STATUS",0);e.save({callback:function(j,h,i){if(i){a.notifyMessage("Pembatalan "+f+" Deposit berhasil")}else{j.set("STATUS",1)}d.getView().fireEvent("batal")}})}else{e.set("STATUS",1)}}})}},onCetakKwitansi:function(c){var d=this,b=d.getView(),a=c.getWidgetRecord();if(a.get("STATUS")==0){b.notifyMessage("Anda tidak dapat mencetak, karena transaksi ini telah dibatalkan");return}b.openDialog("",true,100,50,{xtype:"kwitansi-form",title:"Kwitansi",ui:"panel-cyan",showCloseButton:true},function(e,g){var f=g.down("kwitansi-form");f.setFormConfig({hidden:true,cetak:true});f.createRecord({TAGIHAN:a.get("TAGIHAN"),TUNAI:0,JENIS_LAYANAN_ID:6,NAMA:a.get("NAMA"),STATUS:1});f.setParamReport({name:"pembayaran.CetakDeposit",params:{PID:a.get("ID")}});f.on("cetak",function(h){b.reload();g.close()})})}});Ext.define("pembayaran.tagihan.deposit.Workspace",{extend:"com.Form",xtype:"workspace-deposit",controller:"workspace-deposit",layout:"border",items:[{region:"north",layout:{type:"hbox",align:"stretch"},items:[{xtype:"deposit-form",title:"Penerimaan",flex:1,reference:"penerimaan",listeners:{save:"onReload"},margin:"0 5 0 0"},{xtype:"deposit-form",title:"Pengembalian",flex:1,reference:"pengembalian",listeners:{save:"onReload"}}]},{region:"center",xtype:"deposit-list",reference:"depositlist",listeners:{select:"onSelect",batal:"onReload"}}],onLoadRecord:function(c,g){var h=c.down("[reference=penerimaan]"),f=c.down("[reference=pengembalian]"),a=c.down("[reference=depositlist]"),b=g.get("STATUS")==1,e=c.app.xpriv("1202")?b:false,d=c.app.xpriv("1203")?b:false;h.setFormConfig({viewOnly:!e,simpan:e,reset:e,minDate:g.get("TANGGAL"),maxDate:c.getSysdate()});h.createRecord({TAGIHAN:g.get("ID"),JENIS:1,TANGGAL:c.getSysdate(),TOTAL:0,STATUS:1});f.setFormConfig({viewOnly:!d,simpan:d,reset:d,minDate:g.get("TANGGAL"),maxDate:c.getSysdate()});f.createRecord({TAGIHAN:g.get("ID"),JENIS:2,TANGGAL:c.getSysdate(),TOTAL:0,STATUS:1});h.focus("TANGGAL");a.setListConfig({paging:true,batal:b});a.load({TAGIHAN:g.get("ID")})}});Ext.define("pembayaran.tagihan.deposit.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-deposit",onSelect:function(b,d){var c=this,a=c.getReferences();if(d.get("JENIS")==1){a.penerimaan.loadRecord(d)}else{a.pengembalian.loadRecord(d)}},onReload:function(){var a=this.getReferences();a.depositlist.load();this.getView().fireEvent("load")}});Ext.define("pembayaran.tagihan.discount.Workspace",{extend:"com.Tab",xtype:"workspace-discount",controller:"workspace-discount",viewModel:{data:{tagihan:undefined}},defaults:{border:false,listeners:{save:"onSimpan"}},items:[{title:"Sarana",xtype:"discountsaranan-form",reference:"discountsarana"},{title:"Dokter",xtype:"workspace-discountdokter",reference:"discountdokter"}],load:function(c){var d=this,b=d.getViewModel(),a=d.getActiveTab();if(a){b.set("tagihan",c);if(a.load){a.load(c)}}},listeners:{tabchange:"onTabChange"}});Ext.define("pembayaran.tagihan.discount.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-discount",onTabChange:function(d,a){var c=this.getViewModel(),b=c.get("tagihan");if(a.load){a.load(b)}},onSimpan:function(a){this.getView().fireEvent("load")}});Ext.define("pembayaran.tagihan.discount.dokter.Form",{extend:"com.Form",xtype:"discountdokter-form",controller:"discountdokter-form",model:"data.model.DiskonDokter",defaults:{border:false,hideLabel:true,allowBlank:false,bind:{readOnly:"{formConfig.viewOnly}"}},header:{items:[{xtype:"button",ui:"soft-red",iconCls:"x-fa fa-file",bind:{hidden:"{!formConfig.simpan}"},margin:"0 1 0 0",handler:"onBaru",tooltip:{text:"Baru",mouseOffset:[0,-75]}},{xtype:"button",ui:"soft-blue",iconCls:"x-fa fa-save",bind:{hidden:"{!formConfig.simpan}"},handler:"onSimpan",tooltip:{text:"Simpan",mouseOffset:[0,-75]}}]},items:[{xtype:"dokter-combo",name:"DOKTER",anchor:"100%"},{xtype:"numberfield",anchor:"100%",hideTrigger:true,emptyText:"TOTAL",name:"TOTAL"}],onLoadRecord:function(c,d){var e=c.down("dokter-combo"),b=d.get("REFERENSI"),a=b?(b.DOKTER?Ext.create("data.model.Dokter",b.DOKTER):null):null;if(a){e.select(a);e.params.ID=a.get("ID");e.load()}}});Ext.define("pembayaran.tagihan.discount.dokter.FormController",{extend:"Ext.app.ViewController",alias:"controller.discountdokter-form",onBaru:function(){var b=this,a=b.getView(),c=a.getRecord();a.createRecord({TANGGAL:a.getSysdate(),TAGIHAN:c.get("ID"),STATUS:1});a.focus("DOKTER");a.fireEvent("baru")},onSimpan:function(b){var c=this,a=c.getView();a.setLoading(true);a.save(b,{},function(f,d,e){if(e){a.fireEvent("success",e);c.onBaru()}})}});Ext.define("pembayaran.tagihan.discount.dokter.List",{extend:"com.Grid",alias:"widget.discount-dokter-list",controller:"discount-dokter-list",viewModel:{stores:{store:{type:"diskon-dokter-store"}}},cls:"x-br-top",border:false,reference:"discountList",columns:[{xtype:"rownumberer",text:"No",align:"left",width:60},{text:"Nama Dokter",dataIndex:"DOKTER",flex:1,renderer:"onRendereNama"},{xtype:"numbercolumn",text:"Total",dataIndex:"TOTAL",flex:1,format:"0,00",align:"right"},{xtype:"datecolumn",text:"Tanggal",dataIndex:"TANGGAL",flex:1,format:"d-m-Y H:i:s",align:"center"}]});Ext.define("pembayaran.tagihan.discount.dokter.ListController",{extend:"Ext.app.ViewController",alias:"controller.discount-dokter-list",onRendereNama:function(e,c,d){var a=d.get("REFERENSI"),b=a?(a.DOKTER?a.DOKTER.NAMA:""):"";return b}});Ext.define("pembayaran.tagihan.discount.dokter.Workspace",{extend:"com.Form",xtype:"workspace-discountdokter",controller:"workspace-discountdokter",layout:"border",items:[{region:"east",title:"Form",width:300,split:true,collapsible:true,iconCls:"x-fa fa-file-o",xtype:"discountdokter-form",border:false,reference:"discountform",listeners:{save:"onSuccess",baru:"onBaru"}},{region:"center",title:"List",iconCls:"x-fa fa-server",xtype:"discount-dokter-list",border:false,reference:"discountlist",listeners:{select:"onSelect"}}],load:function(f){var d=this,e=this.down("discount-dokter-list"),c=this.down("discountdokter-form");if(f){var a=f.get("STATUS")==1,b=d.app.xpriv("1207")?a:false;c.setFormConfig({viewOnly:!b,simpan:b});e.loadStore({TAGIHAN:f.get("ID")});c.createRecord({TANGGAL:d.getSysdate(),TAGIHAN:f.get("ID"),STATUS:1})}}});Ext.define("pembayaran.tagihan.discount.dokter.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-discountdokter",onSuccess:function(e){var c=this,a=c.getView(),b=c.getReferences(),d=b.discountlist;d.reload();a.fireEvent("save",e)},onBaru:function(){var b=this,a=b.getReferences();a.discountlist.getSelectionModel().deselect(a.discountlist.getSelection())},onSelect:function(b,d){var c=this,a=c.getReferences();if(d){a.discountform.loadRecord(d)}}});Ext.define("pembayaran.tagihan.discount.sarana.Form",{extend:"com.Form",xtype:"discountsaranan-form",controller:"discountsaranan-form",viewModel:{stores:{store:{type:"diskon-store"}},formulas:{getTotal:function(b){var f=b("record.ADMINISTRASI"),a=b("record.AKOMODASI"),c=b("record.SARANA_NON_AKOMODASI"),d=b("record.PARAMEDIS"),e=f+a+c+d;return e}}},model:"data.model.Diskon",border:false,fieldDefaults:{labelAlign:"top"},layout:{type:"vbox",align:"stretch"},title:"Form",iconCls:"x-fa fa-file-o",border:false,items:[{layout:"hbox",defaults:{flex:1,margin:"2 2 2 2",bind:{readOnly:"{formConfig.viewOnly}"},border:false},bodyPadding:10,border:false,items:[{xtype:"numberfield",hideTrigger:true,reference:"administrasi",fieldLabel:"ADMINISTRASI",name:"ADMINISTRASI",bind:{value:"{record.ADMINISTRASI}"}},{xtype:"numberfield",hideTrigger:true,reference:"akomodasi",fieldLabel:"AKOMODASI",name:"AKOMODASI",bind:{value:"{record.AKOMODASI}"}}]},{layout:"hbox",defaults:{flex:1,margin:"2 2 2 2",border:false,bind:{readOnly:"{formConfig.viewOnly}"}},bodyPadding:10,border:false,items:[{xtype:"numberfield",hideTrigger:true,reference:"sarana",fieldLabel:"SARANA NON AKOMODASI",name:"SARANA_NON_AKOMODASI",bind:{value:"{record.SARANA_NON_AKOMODASI}"}},{xtype:"numberfield",hideTrigger:true,reference:"paramedis",fieldLabel:"PARAMEDIS",name:"PARAMEDIS",bind:{value:"{record.PARAMEDIS}"}}]},{xtype:"headervalue",fontSize:"25px",title:"Total Diskon:",paddingText:"7px 0 0 0",height:65,reference:"total",bind:{value:"{getTotal}"}}],buttons:[{text:"Simpan",ui:"soft-blue",iconCls:"x-fa fa-save",handler:"onSimpan",bind:{hidden:"{!formConfig.simpan}"},tooltip:{text:"Simpan",mouseOffset:[0,-75]}}],load:function(e){var f=this,d=f.getViewModel(),b=d.get("store");if(e){var a=e.get("STATUS")==1,c=f.app.xpriv("1207")?a:false;f.setFormConfig({viewOnly:!c,simpan:c});b.queryParams={TAGIHAN:e.get("ID")};b.load({callback:function(j,g,i){if(i){f.loadRecord(j[0])}else{var h={TAGIHAN:e.get("ID"),TANGGAL:f.getSysdate(),STATUS:1};f.createRecord(h)}}})}}});Ext.define("pembayaran.tagihan.discount.sarana.FormController",{extend:"Ext.app.ViewController",alias:"controller.discountsaranan-form",onSimpan:function(b){var c=this,a=c.getView();a.save(b)}});Ext.define("pembayaran.tagihan.discount.tenagamedis.List",{extend:"com.Grid",xtype:"discount-tenagamedis-list",controller:"discount-tenagamedis-list",viewModel:{data:{listConfig:{add:false}},stores:{store:{type:"discount-tenagamedis-store"}}},header:{items:[{xtype:"search-field",emptyText:"[Cari Tenaga Medis]",flex:1,listeners:{search:"onSearch",clear:"onClear"}},{xtype:"button",iconCls:"x-fa fa-plus",tooltip:"Tambah Baru",margin:"0 0 0 1",handler:"onAdd",bind:{hidden:"{!listConfig.add}"}}]},actions:{edit:{iconCls:"x-fa fa-pencil-square-o",tooltip:"Edit",handler:"onEdit"}},columns:[{xtype:"rownumberer",text:"No",width:60},{xtype:"templatecolumn",text:"Tindakan",align:"left",menuDisabled:true,sortable:false,flex:1,tpl:'<div style="white-space:normal !important;">{REFERENSI.TINDAKAN_MEDIS.REFERENSI.TINDAKAN.NAMA}</div>'},{xtype:"templatecolumn",text:"Jenis",align:"left",menuDisabled:true,sortable:false,flex:1,tpl:'<div style="white-space:normal !important;">{REFERENSI.JENIS.DESKRIPSI}</div>'},{xtype:"templatecolumn",text:"Nama",align:"left",menuDisabled:true,sortable:false,bind:{hidden:"{listConfig.phoneMode}"},flex:1,tpl:'<div style="white-space:normal !important;">{REFERENSI.TENAGA_MEDIS.NAMA}</div>'},{xtype:"datecolumn",text:"Tanggal",dataIndex:"TANGGAL",format:"d-m-Y H:i:s",menuDisabled:true,sortable:false,align:"center",width:140},{xtype:"templatecolumn",text:"Status",align:"left",menuDisabled:true,sortable:false,width:150,tpl:'<div style="white-space:normal !important;">{REFERENSI.STATUS.DESKRIPSI}</div>'},{text:"#",xtype:"actioncolumn",align:"center",menuDisabled:true,sortable:false,width:50,items:["@edit"]}]});Ext.define("pembayaran.tagihan.discount.tenagamedis.ListController",{extend:"Ext.app.ViewController",alias:"controller.discount-tenagamedis-list"});Ext.define("pembayaran.tagihan.discount.tenagamedis.Workspace",{extend:"com.Form",xtype:"workspace-discountenagamedis",controller:"workspace-discountenagamedis",layout:"fit",items:[{title:"Daftar Diskon",iconCls:"x-fa fa-list",xtype:"discount-tenagamedis-list"}],load:function(d){var b=this,c=this.down("discount-tenagamedis-list");if(d){var a=d.get("STATUS")==1;c.loadStore({TAGIHAN:d.get("ID")})}}});Ext.define("pembayaran.tagihan.discount.tenagamedis.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-discountenagamedis"});Ext.define("pembayaran.tagihan.gabung.Workspace",{extend:"com.Form",alias:"widget.workspace-gabung-tagihan",controller:"workspace-gabung-tagihan",model:"data.model.GabungTagihan",layout:{type:"hbox",align:"stretch"},items:[{title:"Sumber",xtype:"tagihan-list",reference:"sumber",flex:1},{xtype:"title",iconCls:"x-fa fa-arrow-right",style:"font-size: 30px",textAlign:"center",padding:"0 0 0 13",width:50},{title:"Tujuan",xtype:"tagihan-list",reference:"tujuan",flex:1}],buttons:[{text:"Gabungkan",handler:"onGabungkan"}],onLoadRecord:function(h,c){var i=h.down("[reference=sumber]"),f=h.down("[reference=tujuan]"),a=c.get("REFERENSI")?c.get("REFERENSI"):null,d=a?(a.DARI?a.DARI:null):null,g=a?(a.KE?a.KE:null):null,b={view:false,pasienInfo:true};if(d){i.setListConfig(b);i.getStore().loadData([d])}if(g){f.setListConfig(b);f.getStore().loadData([g])}else{var e=f.getHeader();e.addTool({type:"search",callback:"onSearch"});f.setListConfig(b)}}});Ext.define("pembayaran.tagihan.gabung.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-gabung-tagihan",onGabungkan:function(d){var e=this,a=e.getView(),b=e.getReferences(),f=a.getRecord();if(b.tujuan.getStore().getCount()==0){a.notifyMessage("Anda memilih tujuan tagihan","danger-blue");return}if(b.sumber.getStore().getCount()>0&&b.tujuan.getStore().getCount()>0){var g=b.sumber.getStore().getAt(0),c=b.tujuan.getStore().getAt(0);if(g.get("ID")==c.get("ID")){a.notifyMessage("ID Tagihan sumber & tujuan tidak boleh sama","danger-blue");return}f.set("KE",c.get("ID"))}Ext.Msg.show({title:"Penggabungan Tagihan",message:"Anda yakin ingin melakukan penggabungan tagihan?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,animateTarget:d,fn:function(h){if(h==="yes"){delete f.data.REFERENSI;a.setLoading(true);a.save({success:"Tagihan telah digabungkan"})}}})}});Ext.define("pembayaran.tagihan.header.Form",{extend:"com.Form",alias:"widget.pembayaran-tagihan-header-form",viewModel:{formulas:{getNamaLengkap:function(c){var b=c("record.REFERENSI.PENDAFTARAN.REFERENSI.PASIEN"),d=b.GELAR_DEPAN||"",a=b.NAMA||"",e=b.GELAR_BELAKANG||"";d=d==""?"":d+". ";e=e==""?"":", "+e;return d+a+e},getTempatLahir:function(c){var b=c("record.REFERENSI.PENDAFTARAN.REFERENSI.PASIEN"),e=b.REFERENSI,a=b.TEMPAT_LAHIR,d=e.TEMPATLAHIR?e.TEMPATLAHIR.DESKRIPSI:"";return Ext.isNumeric(a)?d:a},getTglLahir:function(b){var a=b("record.REFERENSI.PENDAFTARAN.REFERENSI.PASIEN"),c=Ext.Date.parse(a.TANGGAL_LAHIR,"Y-m-d H:i:s");return Ext.Date.format(c,"d F Y")},getKontak:function(b){var a=b("record.REFERENSI.PENDAFTARAN.REFERENSI.PASIEN"),c="";if(Ext.isArray(a.KONTAK)){a.KONTAK.forEach(function(d){if(d.JENIS==3){c=d.NOMOR}})}return c},getStatus:function(c){var b=c("record.REFERENSI.PENDAFTARAN.REFERENSI.PASIEN"),d=b.REFERENSI,a=d.STATUS?d.STATUS.DESKRIPSI:"";return a},getPenjamin:function(b){var d=b("record.JENIS"),c=b("record.REFERENSI.PENDAFTARAN.REFERENSI.PASIEN.KARTUASURANSI"),a="";if(Ext.isArray(c)){c.forEach(function(e){if(d==e.JENIS){a=e.REFERENSI.PENJAMIN.DESKRIPSI}})}return a},getPenjaminNoKartu:function(b){var d=b("record.JENIS"),c=b("record.REFERENSI.PENDAFTARAN.REFERENSI.PASIEN.KARTUASURANSI"),a="";if(Ext.isArray(c)){c.forEach(function(e){if(d==e.JENIS){a=e.NOMOR}})}return a},getPenjaminJenis:function(b){var d=b("record"),c=d.get("REFERENSI"),a=c.JENIS_PESERTA?c.JENIS_PESERTA.DESKRIPSI:"";return a},getPenjaminKelas:function(b){var d=b("record"),c=d.get("REFERENSI"),a=c.KELAS?c.KELAS.DESKRIPSI:"";return a},getStatusGrouping:function(b){var c=b("record.REFERENSI.PENDAFTARAN.REFERENSI"),a=c.INACBG?(c.INACBG.STATUS==1?"Final Grouping":"Grouping belum Final"):"Belum di grouping";return a},getKelasKlaim:function(b){var d=b("record"),c=d.get("REFERENSI"),a=c.KELAS_KLAIM?c.KELAS_KLAIM.DESKRIPSI:"";return a}}},bodyStyle:"background: white",bodyPadding:15,layout:{type:"vbox",align:"stretch"},defaults:{xtype:"container",layout:"hbox",plugins:"responsive",responsiveConfig:{"width < 600":{layout:{type:"vbox",align:"stretch"},flex:0}}},initComponent:function(){var a=this;a.callParent()},createLabelField:function(b,e,d){var a=d||{},c={xtype:"container",layout:{type:"vbox",align:"stretch"},defaultType:"component",margin:"0 0 5 0",items:[{html:b,style:"font-size: 12px; color: gray"},{bind:"<div style='white-space:normal !important;'>"+e+"</div>",style:"font-size: 14px;",margin:"0 0 5 0"}]};return Ext.apply(c,a)}});Ext.define("pembayaran.tagihan.klaim.List",{extend:"com.Grid",alias:"widget.pembayaran-tagihan-klaim-list",controller:"pembayaran-tagihan-klaim-list",viewModel:{data:{listConfig:{mode:"grid",periode:true,penjamin:false,autoRefresh:false}},stores:{store:{type:"pembayaran-tagihan-klaim-store"}},formulas:{isModeList:function(a){var b=a("listConfig.mode");return b==="list"}}},config:{periodeAwal:new Date(),periodeAkhir:new Date()},title:"Daftar Tagihan yang belum di klaim",dockedItems:[{xtype:"pagingtoolbar",hidden:true,bind:{store:"{store}",hidden:"{!listConfig.paging}"},dock:"bottom",beforePageText:"Hal.",afterPageText:"dari {0}",displayMsg:"Menampilkan {0} - {1} dari {2}",displayInfo:true},{xtype:"toolbar",dock:"top",overflowHandler:"menu",items:[{xtype:"referensi-combo",emptyText:"Pilih Penjamin",params:{JENIS:10,STATUS:1},firstLoad:true,bind:{hidden:"{!listConfig.penjamin}"},listeners:{select:"onSelectPenjamin",change:"onChangePenjamin"},flex:1},{xtype:"search-field",reference:"searchfield",flex:1,emptyText:"[Cari No. Tagihan]",listeners:{search:"onSearch",clear:"onSearch"}},{xtype:"search-field",reference:"searchfieldnopen",flex:1,emptyText:"[Cari No. Pendaftaran]",listeners:{search:"onSearch",clear:"onSearch"}},{xtype:"search-field",reference:"searchfieldnorm",flex:1,emptyText:"[Cari No. Rekam Medis]",listeners:{search:"onSearch",clear:"onSearch"}},{xtype:"checkboxfield",boxLabel:"Filter berdasarkan periode",reference:"filterbyperiode",bind:{hidden:"{!listConfig.periode}"},listeners:{change:"onSearch"}},{xtype:"checkbox",reference:"autorefresh",boxLabel:"Auto Refresh ?",labelAlign:"right",checked:false,margin:{left:10},listeners:{change:"onChangeAutoRefresh"},bind:{hidden:"{!listConfig.autoRefresh}"}},{xtype:"combo",reference:"cbAutoRefresh",store:{fields:["ID","DESKRIPSI"],data:[{ID:30,DESKRIPSI:"30s"},{ID:35,DESKRIPSI:"35s"},{ID:40,DESKRIPSI:"40s"},{ID:45,DESKRIPSI:"45s"},{ID:50,DESKRIPSI:"50s"}]},displayField:"DESKRIPSI",valueField:"ID",queryMode:"local",editable:false,value:30,width:75,bind:{hidden:"{!listConfig.autoRefresh}",disabled:"{!autorefresh.checked}"},listeners:{select:"onSelectAutoRefresh"}}]}],columns:[{dataIndex:"TAGIHAN",align:"center",text:"No. Tagihan",bind:{hidden:"{isModeList}"},width:100},{dataIndex:"NORM",text:"No. RM",align:"center",bind:{hidden:"{isModeList}"},width:100},{dataIndex:"NOPEN",text:"No. Pendaftaran",align:"center",bind:{hidden:"{isModeList}"},width:100},{xtype:"templatecolumn",tpl:"{[this.getNamaLengkap(this.getReferensi(values, 'PASIEN'))]}",bind:{hidden:"{isModeList}"},flex:2},{xtype:"datecolumn",dataIndex:"MASUK",text:"Tgl. Masuk",align:"center",format:"d/m/Y H:i:s",bind:{hidden:"{isModeList}"},width:140},{xtype:"datecolumn",dataIndex:"TANGGAL_FINAL",text:"Tagihan Final",align:"center",format:"d/m/Y H:i:s",bind:{hidden:"{isModeList}"},width:140},{xtype:"datecolumn",dataIndex:"KELUAR",text:"Tgl. Keluar",align:"center",format:"d/m/Y H:i:s",bind:{hidden:"{isModeList}"},width:140},{xtype:"templatecolumn",tpl:"{[this.getReferensi(this.getReferensi(this.getReferensi(values, 'TUJUAN'), 'RUANGAN'), 'JENIS_KUNJUNGAN', 'DESKRIPSI')]}",bind:{hidden:"{isModeList}"},flex:1},{xtype:"numbercolumn",dataIndex:"TOTAL",text:"Total",align:"right",format:"0,000",bind:{hidden:"{isModeList}"},flex:2},{xtype:"templatecolumn",flex:2,bind:{hidden:"{!isModeList}"},tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 14px; white-space:normal !important;">{[values.NORM]} - {[this.getNamaLengkap(this.getReferensi(values, "PASIEN"))]}</div>','<div style="font-size: 12px; white-space:normal !important;">No. Tagihan: {[values.TAGIHAN]} | No. Pendaftaran: {[values.NOPEN]} | {[this.getReferensi(this.getReferensi(this.getReferensi(values, "TUJUAN"), "RUANGAN"), "JENIS_KUNJUNGAN", "DESKRIPSI")]}</div>','<div style="font-size: 12px; white-space:normal !important;">Masuk: {[this.tanggalFormat(values.MASUK)]} | Keluar: {[this.tanggalFormat(values.KELUAR)]} | Tagihan Final: {[this.tanggalFormat(values.TANGGAL_FINAL)]}</div>')},{xtype:"templatecolumn",flex:0.5,align:"right",bind:{hidden:"{!isModeList}"},tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 18px; white-space:normal !important;">{[this.numberFormat(values.TOTAL)]} </div>')}],onBeforeLoad:function(d,b,a){var c=d.getReferences();if(b.get("listConfig").autoRefresh){d.getController().onChangeAutoRefresh(c.autorefresh,c.autorefresh.checked)}}});Ext.define("pembayaran.tagihan.klaim.ListController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-klaim-list",onSearch:function(){this.cariTagihan()},onSelectPenjamin:function(b,c){var a=this.getView();if(c){a.setParams({PENJAMIN:c.get("ID")});this.cariTagihan()}},onChangePenjamin:function(b,c){var a=this.getView();if(c==""||c==null){a.setParams({PENJAMIN:0});this.cariTagihan()}},onSelectAutoRefresh:function(b,d){var c=this,a=c.getView();a.stop();a.start(d.get("ID")*1000)},onChangeAutoRefresh:function(b,f){var d=this,a=d.getView(),c=d.getReferences(),e=c.cbAutoRefresh.getSelection();if(!f){a.stop()}else{if(e){a.start(e.get("ID")*1000)}}},privates:{cariTagihan:function(){var c=this,b=c.getReferences(),a=c.getView();if(b.searchfield.getValue().trim()==""){delete a.getParams().TAGIHAN}else{a.setParams({TAGIHAN:b.searchfield.getValue()})}if(b.searchfieldnopen.getValue().trim()==""){delete a.getParams().NOPEN}else{a.setParams({NOPEN:b.searchfieldnopen.getValue()})}if(b.searchfieldnorm.getValue().trim()==""){delete a.getParams().NORM}else{a.setParams({NORM:b.searchfieldnorm.getValue()})}if(!b.filterbyperiode.getValue()){delete a.getParams().AWAL;delete a.getParams().AKHIR}else{a.setParams({AWAL:Ext.util.Format.date(a.getPeriodeAwal(),"Y-m-d"),AKHIR:Ext.util.Format.date(a.getPeriodeAkhir(),"Y-m-d")})}a.loadPage(1)}}});Ext.define("pembayaran.tagihan.klaim.Workspace",{extend:"com.Form",xtype:"pembayaran-tagihan-klaim-workspace",layout:"fit",items:[{xtype:"pembayaran-tagihan-klaim-list"}],load:function(){var a=this,b=a.down("pembayaran-tagihan-klaim-list");b.setListConfig({paging:true,periode:false,penjamin:true,autoRefresh:true});b.load()}});Ext.define("pembayaran.tagihan.kwitansi.Form",{extend:"com.Form",xtype:"kwitansi-form",controller:"kwitansi-form",title:"Form Kwitansi",model:"data.model.KwitansiPembayaran",defaultType:"textfield",border:false,viewModel:{data:{formConfig:{autoNomorUrut:false},params:undefined}},defaults:{enforceMaxLength:true,readOnly:true,anchor:"100%",allowBlank:false,bind:{readOnly:"{formConfig.viewOnly}"},margin:"0 0 1 0"},header:{items:[{xtype:"button",iconCls:"x-fa fa-print",hidden:true,bind:{hidden:"{!formConfig.cetak}"},ui:"soft-cyan",handler:"onCetak"}]},items:[{emptyText:"[ No. Kwitansi ]",name:"NOMOR",bind:{hidden:"{formConfig.autoNomorUrut && !formConfig.viewOnly}"},maxLength:15},{emptyText:"[ Nama Pembayar ]",name:"NAMA",maxLength:75}],setParamReport:function(c){var b=this,a=b.getViewModel();if(c){a.set("params",c)}},onLoadRecord:function(a,b){var c=a.getPropertyConfig(55)=="TRUE";a.setFormConfig({autoNomorUrut:c});a.setAllowBlankFields(c,["NOMOR"])}});Ext.define("pembayaran.tagihan.kwitansi.FormController",{extend:"Ext.app.ViewController",alias:"controller.kwitansi-form",onCetak:function(b){var d=this,a=d.getView(),c=d.getViewModel();a.save(b,{},function(k,h,j){if(j){var e="Word",g="docx",i=true,f="Cetak Kwitansi";a.showMessageBox({title:f,message:"Tekan tombol Yes/Ya utk cetak langsung<br/>Tekan tombol No/Tidak untuk Preview",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:b,fn:function(m){if(m!="yes"){e="Pdf";g="pdf";i=false}var o={PTAGIHAN:k.get("TAGIHAN"),PJENIS:1},l=c.get("params"),n="pembayaran.CetakKwitansi";if(l){n=l.name;o=l.params}a.cetak({NAME:n,TYPE:e,EXT:g,PARAMETER:o,REQUEST_FOR_PRINT:i,PRINT_NAME:"CetakKwitansi"},function(p){a.printPreview(f,p)});a.fireEvent("cetak",k)}})}})}});Ext.define("pembayaran.tagihan.monitoring.Grid",{extend:"com.Grid",xtype:"pembayaran-tagihan-monitoring-grid",controller:"pembayaran-tagihan-monitoring-grid",viewModel:{stores:{store:{type:"tagihan-store"}},data:{listConfig:{paging:true}}},title:"Daftar Tagihan",ui:"panel-purple",iconCls:"fas fa-money",header:{height:40,items:[{xtype:"search-field",emptyText:"[NO RM]",listeners:{search:"onSearch",clear:"onClear"}},{xtype:"button",iconCls:"x-fa fa-bars",ui:"soft-green",tooltip:"Pilihan",arrowVisible:false,menu:[{text:"Filter",iconCls:"x-fa fa-filter",menu:[{xtype:"fieldcontainer",layout:"hbox",margin:5,items:[{xtype:"checkbox",boxLabel:"Tanggal",reference:"filtertanggal",checked:false,listeners:{change:"onFilterTanggalChange"}},{xtype:"datefield",name:"TANGGAL",format:"d-m-Y",value:new Date(),bind:{disabled:"{!filtertanggal.checked}"},listeners:{change:"onFilterTanggalChange"}}]},{xtype:"referensi-combo",reference:"filterjeniskjgn",params:{JENIS:15,STATUS:1},emptyText:"Pilih Jenis Kunjungan",margin:5,listeners:{select:"onSelectJenisKunjungan"}},{xtype:"combobox",reference:"posisiruangan",store:Ext.create("Ext.data.Store",{fields:["id","name"],data:[{id:1,name:"Ruangan Awal"},{id:2,name:"Ruangan Akhir"}]}),displayField:"name",valueField:"id",emptyText:"Pilih Posisi Pencarian Ruangan",editable:false,value:1,margin:5,listeners:{select:"onPosisiRuangan"}},{xtype:"ruangan-combo",reference:"ruangan",params:{JENIS:5,STATUS:1},emptyText:"Pilih Ruangan",margin:5,listeners:{select:"onSelectRuangan",change:"onChangeRuangan"}},{xtype:"referensi-combo",reference:"filterjenis",params:{JENIS:10,STATUS:1},emptyText:"Pilih Penjamin",margin:5,listeners:{select:"onSelectPenjamin",change:"onChangePenjamin"}},{xtype:"combobox",reference:"grouping",store:Ext.create("Ext.data.Store",{fields:["id","name"],data:[{id:0,name:"Semua"},{id:1,name:"Belum di Grouping"},{id:2,name:"Sudah Grouping belum Final"},{id:3,name:"Sudah Grouping Final"}]}),displayField:"name",valueField:"id",emptyText:"Pilih Status Grouping",editable:false,value:0,margin:5,listeners:{select:"onSelectGrouping"}}]}]}]},hideHeaders:true,initComponent:function(){var a=this;a.columns=[{xtype:"templatecolumn",text:"Daftar Tagihan",flex:1,tpl:new Ext.XTemplate("{[this.info(values)]}",{info:function(m){var f=this,h='<div style="font-weight: bold; font-size: 12px; white-space:normal !important;">{TAGIHAN_ID} - {TAGIHAN_TANGGAL} {STATUS}</div><div style="font-weight: bold; font-size: 14px; white-space:normal !important;">{NAMA}</div>',e='<div style="font-weight: bold; white-space:normal !important; border-top: .5px dashed gray">{GABUNG_KE}</div><div style="white-space:normal !important;">Pendaftaran: {PENDAFTARAN}</div><div style="white-space:normal !important;">{RUANGAN}</div>',d='<div style="font-size: 12px; white-space:normal !important; border-top: .5px dashed gray">{PENJAMIN}</div>',c='<div style="font-size: 14px; font-weight: bold; color: [COLOR_VALUE]; white-space:normal !important;">[FIELD]</div>',g="black",l="",k="",j="",i="",n=a.getReferensi(m,"TAGIHAN_PENDAFTARAN"),b=n?n:[];l=h.replace("{TAGIHAN_ID}",m.ID);l=l.replace("{TAGIHAN_TANGGAL}",f.tanggalFormat(m.TANGGAL));b.forEach(function(B,C){var v=f.getReferensi(B,"PENDAFTARAN"),H=f.getReferensi(v,"PASIEN","NAMA"),I=v.PENJAMIN?v.PENJAMIN:null,N=v?(v.TUJUAN?v.TUJUAN:null):null,p=a.getReferensi(N,"RUANGAN"),q=a.getReferensi(p,"JENIS_KUNJUNGAN"),o=f.getReferensi(v,"INACBG"),z=m.REF;if(H){z+=" - "+H}l=l.replace("{NAMA}",z);k+=e.replace("{GABUNG_KE}","");k=k.replace("{PENDAFTARAN}",v.NOMOR+" - "+f.tanggalFormat(v.TANGGAL)+" | "+q.DESKRIPSI);if(p){if(p.JENIS_KUNJUNGAN==3){var A=f.getReferensi(v,"KUNJUNGAN_MASUK"),y=f.getReferensi(A,"RUANGAN"),x=f.getReferensi(y,"RUANG_KAMAR_TIDUR"),K=f.getReferensi(x,"RUANG_KAMAR"),M=f.getReferensi(v,"KUNJUNGAN_KELUAR"),J=f.getReferensi(M,"RUANGAN"),G=f.getReferensi(M,"RUANG_KAMAR_TIDUR"),r=f.getReferensi(G,"RUANG_KAMAR"),F=p.DESKRIPSI;if(N.STATUS==1){F+=' | <span style="color: orange">Belum di terima di ruangan</span>'}if(N.STATUS==0){F+=' | <span style="color: red">Tujuan ruangan dibatalkan</span>'}if(y){F=y.DESKRIPSI}if(x){F+=" | "+K.KAMAR+" | "+K.TEMPAT_TIDUR}if(J){if(J.ID!=y.ID){F="<b>Ruangan Awal:</b> "+F+"<br><b>Ruangan Akhir:</b> "+J.DESKRIPSI}if(G){F+=" | "+r.KAMAR+" | "+G.TEMPAT_TIDUR}F+="<br>Tgl. Keluar: "+(M.KELUAR?f.tanggalFormat(M.KELUAR):"")}k=k.replace("{RUANGAN}",F)}else{k=k.replace("{RUANGAN}",p.DESKRIPSI)}}if(B.UTAMA==1){var E=f.getReferensi(I,"JENIS_PENJAMIN"),u=f.getReferensi(I,"KELAS"),L=f.getReferensi(I,"KAP"),D=f.getReferensi(I,"JENIS_PESERTA"),O=E?E.DESKRIPSI:"",w=u?u.DESKRIPSI:"",s=O+(I.JENIS!=1?" - "+w:""),F="";if(L&&I.JENIS!=1){s+=" | "+L.NOMOR+" | "+I.NOMOR;if(D){s+=" | "+D.DESKRIPSI}}j=d.replace("{PENJAMIN}",s);if(E.CONFIG){g="red";F="Belum di Grouping";if(o){g="orange";F="Sudah Grouping belum Final";if(o.STATUS==1){g="green";F="Sudah Grouping Final"}}}if(F!=""){i=c.replace("[FIELD]",F).replace("[COLOR_VALUE]",g)}}});l+=k;l+=j;l+=i;l=l.replace("{NAMA}","-");l=l.replace("{STATUS}",b.length>1?'| <span style="color: red; font-weight: bold">Gabungan Tagihan</span>':"");return l}})},{xtype:"templatecolumn",flex:0.5,text:"Total",align:"right",tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 18px; white-space:normal !important;">Rp. {[this.getTotal(values)]} </div>',{getTotal:function(g){var q=Number(g.TOTAL),j=q,i=Number(g.PEMBULATAN),n=a.getReferensi(g,"PENJAMIN_TAGIHAN"),b=a.getReferensi(g,"DEPOSIT"),p=a.getReferensi(g,"PENGEMBALIAN_DEPOSIT"),d=a.getReferensi(g,"PIUTANG_PASIEN"),h=a.getReferensi(g,"PIUTANG_PERUSAHAAN"),f=a.getReferensi(g,"DISKON"),k=a.getReferensi(g,"DISKON_DOKTER"),c=a.getReferensi(g,"NON_TUNAI"),l=a.getReferensi(g,"SUBSIDI_TAGIHAN"),o=null,m=0,e=0;if(n){Ext.Array.each(n,function(r){m+=Number(r.TOTAL);if(r.PENJAMIN==2){o=r}})}if(o){if(o.NAIK_KELAS==1){j=Number(o.TOTAL_NAIK_KELAS)}if(o.NAIK_KELAS_VIP==1){j=Number(o.TOTAL_NAIK_KELAS);j+=Number(o.SELISIH_MINIMAL)}if(a.getPropertyConfig("9")=="TRUE"){if(o.NAIK_KELAS==1||o.NAIK_KELAS_VIP==1||o.NAIK_DIATAS_VIP==1){j=Number(o.TOTAL_NAIK_KELAS);e=0}}}j-=m;if(l){Ext.Array.each(l,function(r){j-=Number(r.TOTAL)})}if(b){Ext.Array.each(b,function(r){if(r.JENIS==1){j-=Number(r.TOTAL)}else{j+=Number(r.TOTAL)}})}if(p){Ext.Array.each(p,function(r){j+=Number(r.TOTAL)})}if(d){Ext.Array.each(d,function(r){j-=Number(r.TOTAL)})}if(h){Ext.Array.each(h,function(r){j-=Number(r.TOTAL)})}if(f){Ext.Array.each(f,function(r){j-=(Number(r.ADMINISTRASI)+Number(r.AKOMODASI)+Number(r.SARANA_NON_AKOMODASI)+Number(r.PARAMEDIS))})}if(k){Ext.Array.each(k,function(r){j-=Number(r.TOTAL)})}if(c){Ext.Array.each(c,function(r){j-=Number(r.TOTAL)})}j=j+i;return Ext.util.Format.number(j<0?0:j,"0,000")}})},{xtype:"widgetcolumn",align:"center",width:60,widget:{xtype:"fieldcontainer",defaults:{padding:2},items:[{xtype:"button",text:"View",ui:"soft-red",action:0,margin:"0 1 0 0",handler:"onViewTagihan"}]}}];a.callParent(arguments)},loadStore:function(){var a=this.getParams();if(!a.JENIS){this.setParams({STATUS:1,JENIS:1,TOTAL:1})}this.load()},onBeforeLoad:function(e,d,b){var c=e.down("[reference=filterjeniskjgn]"),a=e.down("[reference=filterjenis]");e.setParams({REFERENSI:Ext.JSON.encode({Diskon:true,DiskonDokter:true,NonTunai:true,PenjaminTagihan:true,PiutangPasien:true,PiutangPerusahaan:true,Deposit:true,PengembalianDeposit:true,KwitansiPembayaran:true,SubsidiTagihan:true,TagihanPendaftaran:{REFERENSI:{Pendaftaran:{REFERENSI:{TujuanPasien:{REFERENSI:{Ruangan:true}},Penjamin:true,Pasien:{KeluargaPasien:false,KIP:false,KAP:false,KontakPasien:false,TempatLahir:false,Referensi:false},Kunjungan:true,PasienPulang:true,Inacbg:{REFERENSI:false}}}}}})});if(c){c.load(function(g,f,h){if(h){if(g.length>0){g[0].set("DESKRIPSI","Semua Kunjungan")}}})}if(a){a.load()}}});Ext.define("pembayaran.tagihan.monitoring.GridController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-monitoring-grid",init:function(){this.filter={tanggal:{checked:false,value:new Date()},query:"",jenisKunjungan:0,posisiRuangan:1,ruangan:"",penjamin:0,grouping:0}},privates:{cari:function(){var e=this,a=e.getView(),c=a.getStore(),b=a.down("pagingtoolbar"),d={};if(e.filter.query==""){delete c.queryParams.REF}else{d.REF=e.filter.query}a.setParams(d);if(b){b.moveFirst()}else{a.load()}},doFilterTanggal:function(){var c=this,a=c.getView(),b=a.down("pagingtoolbar"),d={};if(!c.filter.tanggal.checked){delete a.getStore().queryParams.TANGGAL}else{d.TANGGAL=Ext.Date.format(c.filter.tanggal.value,"Y-m-d")}a.setParams(d);if(b){b.moveFirst()}else{a.load()}},doFilterJenisKunjungan:function(){var c=this,a=c.getView(),b=a.down("pagingtoolbar"),d={JENIS:1};if(c.filter.jenisKunjungan==0){delete a.getStore().queryParams.JENIS_KUNJUNGAN}else{d.JENIS_KUNJUNGAN=c.filter.jenisKunjungan}d.POSISI_RUANGAN=c.filter.posisiRuangan;a.setParams(d);if(b){b.moveFirst()}else{a.load()}},doFilterPosisiRuangan:function(){var c=this,a=c.getView(),b=a.down("pagingtoolbar"),d={JENIS:1};d.POSISI_RUANGAN=c.filter.posisiRuangan;a.setParams(d);if(b){b.moveFirst()}else{a.load()}},doFilterRuangan:function(){var c=this,a=c.getView(),b=a.down("pagingtoolbar"),d={JENIS:1};if(c.filter.ruangan==""){delete a.getStore().queryParams.RUANGAN}else{d.RUANGAN=c.filter.ruangan}a.setParams(d);if(b){b.moveFirst()}else{a.load()}},doFilterPenjamin:function(){var c=this,a=c.getView(),b=a.down("pagingtoolbar"),d={};if(c.filter.penjamin==0){delete a.getStore().queryParams.PENJAMIN}else{d.PENJAMIN=c.filter.penjamin}a.setParams(d);if(b){b.moveFirst()}else{a.load()}},doFilterGrouping:function(){var c=this,a=c.getView(),b=a.down("pagingtoolbar"),d={JENIS:1};if(c.filter.grouping==0){delete a.getStore().queryParams.GROUPING}else{d.GROUPING=c.filter.grouping}a.setParams(d);if(b){b.moveFirst()}else{a.load()}}},onChangePenjamin:function(a){this.onSelectPenjamin(a,null)},onSearch:function(a,b){this.filter.query=b;this.cari()},onClear:function(a){this.filter.query="";this.cari()},onFilterTanggalChange:function(b,c,a){var d=this;if(Ext.getClassName(b)=="Ext.form.field.Checkbox"){d.filter.tanggal.checked=c}else{d.filter.tanggal.value=c}d.doFilterTanggal()},onSelectJenisKunjungan:function(b,d){var c=this,a=c.getReferences();c.filter.jenisKunjungan=0;if(d){c.filter.jenisKunjungan=d.get("ID")}c.doFilterJenisKunjungan();a.ruangan.select(null);a.ruangan.setQueryParams({JENIS_KUNJUNGAN:c.filter.jenisKunjungan});a.ruangan.load()},onPosisiRuangan:function(a,b){this.filter.posisiRuangan=1;if(b){this.filter.posisiRuangan=b.get("id")}this.doFilterPosisiRuangan()},onChangeRuangan:function(a){this.onSelectRuangan(a,null)},onSelectRuangan:function(a,b){this.filter.ruangan="";if(b){this.filter.ruangan=b.get("ID")}this.doFilterRuangan()},onSelectPenjamin:function(a,b){this.filter.penjamin=0;if(b){this.filter.penjamin=b.get("ID")}this.doFilterPenjamin()},onSelectGrouping:function(a,b){this.filter.grouping=0;if(b){this.filter.grouping=b.get("id")}this.doFilterGrouping()},onViewTagihan:function(b){var c=this,d=b.ownerCt.getWidgetRecord(),a=c.getView();a.openDialog("",true,0,0,{xtype:"workspace-tagihan",ui:"panel-cyan",showCloseButton:true},function(f,h){var g=h.down("workspace-tagihan"),e=Ext.create("data.model.Pasien",{NORM:d.get("REF")});a.setLoading(true);a.app.pauseAutoRefresh=true;e.load({success:function(i,j){a.setLoading(false);g.load(d,i)}});h.on({close:function(){a.app.pauseAutoRefresh=false}})})}});Ext.define("pembayaran.tagihan.nontunai.Form",{extend:"com.Form",xtype:"pembayaran-tagihan-nontunai-form",controller:"pembayaran-tagihan-nontunai-form",model:"data.model.Tagihan",viewModel:{stores:{layananstore:{type:"referensi-store"}}},ui:"panel-black",jenis:0,title:"Transaksi Non Tunai",titleFieldConfig:{},fullscreenEnabled:true,menuConfig:{enabled:true,width:230,buttonConfig:{}},fullscreenConfig:{},header:{items:[{}]},onBeforeCallParentInitComponent:function(b){var a=null;b.items.forEach(function(c){if(c.reference){if(c.reference=="contentitem"){a=c}}});if(a){a.items={xtype:"fieldcontainer",layout:"border",defaultType:"fieldcontainer",items:[{region:"center",layout:{type:"vbox",align:"stretch"},defaultType:"fieldcontainer",items:[{layout:{type:"hbox",align:"stretch"},defaults:{padding:0,labelAlign:"top",enterFocus:true},items:[{xtype:"pembayaran-penyedia-layanan-combo",fieldLabel:"Penyedia",params:{STATUS_ID:1},flex:1,forceSelection:false,reference:"layananpenyediacombo",tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="x-boundlist-item">','<div"><strong>{REFERENSI.PENYEDIA.NAMA}</strong></div>',"</div>","</tpl>"),displayTpl:Ext.create("Ext.XTemplate",'<tpl for=".">',"{REFERENSI.PENYEDIA.NAMA}","</tpl>"),listeners:{select:"onSelectPenyedia"}}]},{layout:"fit",flex:1,reference:"container-penyedia"}]},{xtype:"pembayaran-pembayarantagihan-list",region:"east",title:"Daftar Non Tunai",ui:"panel-cyan",header:{items:[{xtype:"button",iconCls:"x-fa fa-refresh",ui:"soft-asperages",handler:"onRefresh"}]},collapsible:true,split:true,width:250}]}}},onNavSelectionChange:function(k,e){var j=this,d=j.getViewModel(),c=j.down("[reference=layananpenyediacombo]"),b=j.down("pembayaran-pembayarantagihan-list"),a=j.getController(),g=e.get("text"),f=j.titleField.getText(),i=d.get("record"),h=e.get("record")||{};if(e){f=f.indexOf("-")<0?f:f.substring(0,f.indexOf("-")).trim();j.titleField.setText(f+" - "+g);c.setFieldLabel(h.get("TEKS"));c.setEmptyText("Pilih "+h.get("TEKS"));c.removeDataStore();c.setQueryParams({JENIS_LAYANAN_ID:h.get("ID")});c.load();c.select(null);a.onSelectPenyedia(c,null);c.focus();b.setParams({TAGIHAN:i.get("ID"),JENIS_LAYANAN_ID:h.get("ID"),NOT:Ext.JSON.encode({STATUS:[0]})});b.load()}},onLoadRecord:function(b,e){var a=b.getViewModel(),d=a.get("layananstore"),c=[];d.setQueryParams({JENIS:172,STATUS:1});d.load(function(g,f,h){if(h){g.forEach(function(j,i){c.push({text:j.get("DESKRIPSI"),record:j,leaf:true})});b.setMenus(c)}})}});Ext.define("pembayaran.tagihan.nontunai.FormController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-nontunai-form",onSelectPenyedia:function(b,h){var d=this,a=d.getView(),c=d.getViewModel(),g=a.down("[reference=container-penyedia]");g.suspendLayouts();g.removeAll();if(h){if(h.get("DRIVER")){try{var i=g.add(Ext.create(h.get("DRIVER"),{}));i.setJenis(a.jenis);i.setLayananPenyedia(h);i.loadRecord(c.get("record"));i.on("load",function(e){a.fireEvent("load",function(j){if(j){c.set("record",j)}if(Ext.isFunction(e)){e(j)}});d.onRefresh()})}catch(f){a.notifyMessage("Driver layanan tidak ditemukan / belum terdaftar / belum diberikan hak akses")}}}g.resumeLayouts();g.updateLayout()},onRefresh:function(b){var c=this,a=c.getView(),d=a.down("pembayaran-pembayarantagihan-list");d.reload()}});Ext.define("pembayaran.tagihan.nontunai.Workspace",{extend:"com.Form",xtype:"workspace-nontunai",controller:"workspace-nontunai",model:"data.model.Tagihan",layout:"fit",bodyPadding:0,items:[{xtype:"pembayaran-tagihan-nontunai-form",listeners:{load:"onLoad"}}],onLoadRecord:function(b,c){var a=b.down("pembayaran-tagihan-nontunai-form");a.jenis=b.jenis;a.loadRecord(c)}});Ext.define("pembayaran.tagihan.nontunai.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-nontunai",onLoad:function(d){var c=this,a=c.getView(),b=c.getViewModel();a.fireEvent("load",function(e){if(e){b.set("record",e)}if(Ext.isFunction(d)){d(e)}})}});Ext.define("pembayaran.tagihan.nontunai.bank.transfer.Form",{extend:"com.Form",xtype:"pembayaran-tagihan-nontunai-bank-transfer-form",controller:"pembayaran-tagihan-nontunai-bank-transfer-form",model:"pembayaran.pembayarantagihan.Model",layout:{type:"hbox",align:"stretch"},defaultType:"fieldcontainer",items:[{flex:1,layout:{type:"vbox",align:"stretch"},defaults:{bind:{readOnly:"{formConfig.viewOnly}"}},items:[{xtype:"master-rekening-combo",params:{STATUS:1},name:"REKENING_ID",selectOnTab:true,editable:true,allowBlank:false,margin:"2 2 1 1",fieldLabel:"Rekening RS",typeAhead:true,emptyText:"[Rekening RS]"},{xtype:"textfield",fieldLabel:"Rekening Penyetor",name:"NO_ID",emptyText:"[ Rekening Penyetor ]",enforceMaxLength:true,maxLength:25},{xtype:"textfield",fieldLabel:"Nama Penyetor",name:"NAMA",emptyText:"[ Nama Penyetor ]",stripCharsRe:new RegExp("[^a-zA-Z0-9.\\s]"),allowBlank:false,enforceMaxLength:true,maxLength:135},{xtype:"referensi-combo",params:{JENIS:16,STATUS:1},name:"BANK_ID",selectOnTab:true,editable:true,allowBlank:false,margin:"2 2 1 1",fieldLabel:"Bank Penyetor",typeAhead:true,emptyText:"[ Bank Penyetor ]"}]},{flex:1,layout:{type:"vbox",align:"stretch"},margin:"0 0 0 20",items:[{xtype:"textfield",fieldLabel:"Nomor Referensi",name:"REF",bind:{readOnly:"{formConfig.viewOnly}"},emptyText:"[ Nomor Referensi ]",allowBlank:false},{xtype:"numberfield",textAlign:"right",fieldLabel:"Total",name:"TOTAL",emptyText:"[ Rp. ]",minValue:0,hideTrigger:true,bind:{readOnly:"{formConfig.viewOnly}"},allowBlank:false},{xtype:"fieldcontainer",fieldLabel:"Tanggal",layout:{type:"hbox"},defaults:{allowBlank:false},items:[{name:"TANGGAL",reference:"tanggal",flex:1,xtype:"datefield",emptyText:"[Tanggal]",format:"d/m/Y",margin:"0 1 0 0",bind:{readOnly:"{formConfig.viewOnly}",maxValue:"{formConfig.maxDate}"}},{name:"WAKTU",reference:"waktu",width:105,xtype:"timefield",emptyText:"[Jam:Mnt:Dtk]",format:"H:i:s",hideTrigger:true,bind:{readOnly:"{formConfig.viewOnly}"}}]}]}],buttons:[{text:"Simpan",ui:"soft-blue",iconCls:"x-fa fa-save",handler:"onSimpan",bind:{hidden:"{!formConfig.simpan}"},tooltip:{text:"Simpan",mouseOffset:[0,-75]}},{text:"Reset",ui:"soft-red",iconCls:"x-fa fa-refresh",handler:"onReset",bind:{hidden:"{!formConfig.reset}"},tooltip:{text:"Reset",mouseOffset:[0,-75]}}],onLoadRecord:function(c,g){var e=c.down("master-rekening-combo"),d=c.down("referensi-combo"),b=c.down("[name=WAKTU]"),a=c.getViewModel(),f=a.get("formConfig");b.setValue(g.get("TANGGAL"));d.load();e.setQueryParams({BANK:f.penyedia.REFERENSI_ID,JENIS:1,STATUS:1});e.load()},onBeforeGetRecord:function(b,e){var d=Ext.Date.clone(b.down("[reference=tanggal]").getValue()),a=b.down("[reference=waktu]").getValue(),f=b.app,c=f?(f.trxksr?f.trxksr:0):0;d.setHours(a.getHours());d.setMinutes(a.getMinutes());d.setSeconds(a.getSeconds());e.TANGGAL=d;e.TRANSAKSI_KASIR_NOMOR=c}});Ext.define("pembayaran.tagihan.nontunai.bank.transfer.FormController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-nontunai-bank-transfer-form",onReset:function(){var b=this,a=b.getView(),c=b.getViewModel().get("record");a.createRecord({TAGIHAN:c.get("TAGIHAN"),JENIS:c.get("JENIS"),PENYEDIA_ID:c.get("PENYEDIA_ID"),JENIS_LAYANAN_ID:c.get("JENIS_LAYANAN_ID"),TOTAL:0,TANGGAL:a.getSysdate(),STATUS:2});a.focus("NO_ID")},onSimpan:function(c){var b=this,a=b.getView(),e=a.app,d=e?(e.trxksr?e.trxksr:false):false;if(!d){a.notifyMessage("Anda belum membuka transaksi kasir / open cashier","danger-blue");return}a.save(c,{},function(h,f,g){b.onReset()})}});Ext.define("pembayaran.tagihan.nontunai.bank.transfer.Grid",{extend:"com.Grid",xtype:"pembayaran-tagihan-nontunai-bank-transfer-grid",controller:"pembayaran-tagihan-nontunai-bank-transfer-grid",viewModel:{stores:{store:{type:"pembayaran-pembayarantagihan-store"}},data:{listConfig:{tagihan:undefined,batal:true}}},border:false,cls:"x-br-top",columns:[{xtype:"rownumberer",text:"No",align:"left",width:60},{text:"Nomor",width:90,dataIndex:"NOMOR"},{text:"Bank RS",width:200,dataIndex:"PENYEDIA_ID",renderer:"onRendererPenyedia"},{text:"Rekening RS",width:200,dataIndex:"REKENING_ID",renderer:"onRendererRekening"},{text:"Penyetor",flex:2,columns:[{text:"Nama",dataIndex:"NAMA",flex:1},{text:"No. Rekening",width:150,dataIndex:"NO_ID"},{text:"Bank",width:200,dataIndex:"BANK_ID",renderer:"onRendererBank"}]},{text:"Nomor Referensi",width:150,dataIndex:"REF"},{xtype:"templatecolumn",text:"No. Seri",width:110,tpl:'{[this.getReferensi(values, "KWITANSI_PEMBAYARAN", "NOMOR")]}'},{xtype:"numbercolumn",text:"Total",format:"0,00",align:"right",width:120,dataIndex:"TOTAL"},{xtype:"widgetcolumn",align:"center",text:"Action",width:110,bind:{hidden:"{!listConfig.status}"},widget:{xtype:"fieldcontainer",flex:1,defaults:{padding:2},layout:"fit",items:[{xtype:"button",text:"Batalkan",action:0,handler:"onBatal"},{xtype:"button",text:"Dibatalkan",action:1,ui:"soft-red"}]},onWidgetAttach:"onWidgetAttach"},{text:"#",width:55,align:"center",xtype:"widgetcolumn",widget:{xtype:"button",iconCls:"x-fa fa-print",ui:"soft-green",tooltip:"Cetak Kuitansi",listeners:{click:"onCetakKwitansi"}}}]});Ext.define("pembayaran.tagihan.nontunai.bank.transfer.GridController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-nontunai-bank-transfer-grid",onRendererPenyedia:function(e,c,d){var b=d.get("REFERENSI"),a=b?(b.PENYEDIA?b.PENYEDIA.NAMA:""):"";return a},onRendererRekening:function(e,c,d){var b=d.get("REFERENSI"),a=b?(b.REKENING?b.REKENING.NOMOR+"<br/>"+b.REKENING.PEMILIK:""):"";return a},onRendererBank:function(e,c,d){var b=d.get("REFERENSI"),a=b?(b.BANK?b.BANK.DESKRIPSI:""):"";return a},onWidgetAttach:function(h,b,g){var e=this,c=e.getViewModel().get("listConfig.batal"),a=g.get("STATUS"),i=b.down("[action=0]"),f=b.down("[action=1]");i.setHidden(a==0);f.setHidden(!(a==0));if(!c){i.setHidden(true)}},onBatal:function(c){var e=this,b=e.getView(),f=c.ownerCt.getWidgetRecord();if(f){var d=f.get("REFERENSI"),g=d?(d.JENIS?d.JENIS.DESKRIPSI:""):"",a=f.get("STATUS");f.showError=true;f.animateTarget=c;f.scope=e;b.showMessageBox({title:"Pembatalan Transfer",message:"Anda yakin ingin membatalkan Transaksi Transfer ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"no",animateTarget:c,fn:function(h){if(h==="yes"){f.set("STATUS",0);f.save({callback:function(k,i,j){if(j){b.notifyMessage("Pembatalan Transfer berhasil")}else{k.set("STATUS",a)}e.getView().fireEvent("batal")}})}else{f.set("STATUS",a)}}})}},onCetakKwitansi:function(e){var d=this,b=d.getView(),c=b.getGridConfig(),f=c.tagihan,a=e.getWidgetRecord();if(f){if(f.get("STATUS")==1){b.notifyMessage("Silahkan lakukan final tagihan terlebih dahulu...");return}}else{b.notifyMessage("Transaksi ini belum memiliki tagihan");return}b.openDialog("",true,100,50,{xtype:"kwitansi-form",title:"Kwitansi",ui:"panel-cyan",showCloseButton:true},function(g,i){var h=i.down("kwitansi-form");h.setFormConfig({hidden:true,cetak:true});h.createRecord({TAGIHAN:a.get("TAGIHAN"),TUNAI:0,JENIS_LAYANAN_ID:3,NAMA:a.get("NAMA"),STATUS:1});h.setParamReport({name:"pembayaran.CetakKwitansiTransfer",params:{PNOMOR:a.get("NOMOR")}});h.on("cetak",function(j){b.reload();i.close()})})}});Ext.define("pembayaran.tagihan.nontunai.bank.transfer.Workspace",{extend:"com.Form",xtype:"pembayaran-tagihan-nontunai-bank-transfer-workspace",controller:"pembayaran-tagihan-nontunai-bank-transfer-workspace",viewModel:{data:{tagihan:undefined}},viewModel:{data:{layananPenyedia:undefined,jenis:undefined}},layout:{type:"vbox",align:"stretch"},items:[{xtype:"pembayaran-tagihan-nontunai-bank-transfer-form",reference:"transferform",listeners:{save:"onReload"}},{title:"Daftar Transfer",xtype:"pembayaran-tagihan-nontunai-bank-transfer-grid",flex:1,reference:"transferlist",listeners:{select:"onSelect",batal:"onReload"}}],setJenis:function(b){var a=this.getViewModel();a.set("jenis",b)},setLayananPenyedia:function(b){var a=this.getViewModel();a.set("layananPenyedia",b)},onLoadRecord:function(g,d){var b=g.getViewModel(),h=b.get("jenis"),f=b.get("layananPenyedia"),c=g.down("[reference=transferform]"),i=g.down("[reference=transferlist]"),e=d.get("STATUS")==1,a=g.app.xpriv("1206")?e:false;c.setFormConfig({viewOnly:!a,simpan:a,reset:a,minDate:d.get("TANGGAL"),maxDate:g.getSysdate()});i.setListConfig({tagihan:d,batal:a});new Ext.util.DelayedTask(function(){i.load({TAGIHAN:d.get("ID"),PENYEDIA_ID:f.get("PENYEDIA_ID"),JENIS_LAYANAN_ID:f.get("JENIS_LAYANAN_ID"),NOT:Ext.JSON.encode({STATUS:[0]})});c.setFormConfig({penyedia:f.get("REFERENSI").PENYEDIA});c.createRecord({TAGIHAN:d.get("ID"),JENIS:h,PENYEDIA_ID:f.get("PENYEDIA_ID"),JENIS_LAYANAN_ID:f.get("JENIS_LAYANAN_ID"),TOTAL:0,TANGGAL:g.getSysdate(),STATUS:2});c.focus("REKENING_ID")}).delay(1000)}});Ext.define("pembayaran.tagihan.nontunai.bank.transfer.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-nontunai-bank-transfer-workspace",onSelect:function(b,e){var d=this,c=d.getViewModel(),f=c.get("jenis"),a=d.getReferences();e.set("JENIS",f);a.transferform.loadRecord(e)},onReload:function(){var a=this.getReferences();a.transferlist.load();this.getView().fireEvent("load")}});Ext.define("pembayaran.tagihan.nontunai.edc.Form",{extend:"com.Form",xtype:"pembayaran-tagihan-nontunai-edc-form",controller:"pembayaran-tagihan-nontunai-edc-form",model:"pembayaran.pembayarantagihan.Model",layout:{type:"hbox",align:"stretch"},defaultType:"fieldcontainer",items:[{flex:1,layout:{type:"vbox",align:"stretch"},defaults:{bind:{readOnly:"{formConfig.viewOnly}"}},items:[{xtype:"radiogroup",fieldLabel:"Jenis Kartu",columns:2,defaults:{allowBlank:false},name:"JENIS_KARTU_ID",layout:{autoFlex:false},defaults:{margin:"0 15 0 0"},items:[{boxLabel:"Master Card",checked:true,inputValue:"1"},{boxLabel:"Visa",inputValue:"2"}]},{xtype:"textfield",fieldLabel:"No. Kartu",name:"NO_ID",emptyText:"[ Nomor Kartu ]",allowBlank:false,stripCharsRe:new RegExp("[^0-9]"),enforceMaxLength:true,maxLength:25},{xtype:"textfield",fieldLabel:"Nama Pemilik Kartu",name:"NAMA",emptyText:"[ Nama Pemilik Kartu ]",stripCharsRe:new RegExp("[^a-zA-Z0-9.\\s]"),allowBlank:false,enforceMaxLength:true,maxLength:135},{xtype:"referensi-combo",params:{JENIS:16,STATUS:1},name:"BANK_ID",selectOnTab:true,editable:true,allowBlank:false,margin:"2 2 1 1",fieldLabel:"Bank Penerbit",typeAhead:true,emptyText:"[Bank]"}]},{flex:1,layout:{type:"vbox",align:"stretch"},margin:"0 0 0 20",items:[{xtype:"textfield",fieldLabel:"Kode Aprove",name:"REF",bind:{readOnly:"{formConfig.viewOnly}"},emptyText:"[ Kode Aprove ]",stripCharsRe:new RegExp("[^a-zA-Z0-9]"),allowBlank:false},{xtype:"numberfield",textAlign:"right",fieldLabel:"Total",name:"TOTAL",emptyText:"[ Rp. ]",minValue:0,hideTrigger:true,bind:{readOnly:"{formConfig.viewOnly}"},allowBlank:false},{xtype:"fieldcontainer",fieldLabel:"Tanggal",layout:{type:"hbox"},defaults:{allowBlank:false},items:[{name:"TANGGAL",reference:"tanggal",flex:1,xtype:"datefield",emptyText:"[Tanggal]",format:"d/m/Y",margin:"0 1 0 0",bind:{readOnly:"{formConfig.viewOnly}",minValue:"{formConfig.minDate}",maxValue:"{formConfig.maxDate}"}},{name:"WAKTU",reference:"waktu",width:105,xtype:"timefield",emptyText:"[Jam:Mnt:Dtk]",format:"H:i:s",hideTrigger:true,bind:{readOnly:"{formConfig.viewOnly}"}}]}]}],buttons:[{text:"Simpan",ui:"soft-blue",iconCls:"x-fa fa-save",handler:"onSimpan",bind:{hidden:"{!formConfig.simpan}"},tooltip:{text:"Simpan",mouseOffset:[0,-75]}},{text:"Reset",ui:"soft-red",iconCls:"x-fa fa-refresh",handler:"onReset",bind:{hidden:"{!formConfig.reset}"},tooltip:{text:"Reset",mouseOffset:[0,-75]}}],onLoadRecord:function(b,d){var c=b.down("referensi-combo"),a=b.down("[name=WAKTU]");a.setValue(d.get("TANGGAL"));c.load()},onBeforeGetRecord:function(b,e){var d=Ext.Date.clone(b.down("[reference=tanggal]").getValue()),a=b.down("[reference=waktu]").getValue(),f=b.app,c=f?(f.trxksr?f.trxksr:0):0;d.setHours(a.getHours());d.setMinutes(a.getMinutes());d.setSeconds(a.getSeconds());e.TANGGAL=d;e.TRANSAKSI_KASIR_NOMOR=c}});Ext.define("pembayaran.tagihan.nontunai.edc.FormController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-nontunai-edc-form",onReset:function(){var a=this;view=a.getView(),rec=a.getViewModel().get("record");view.createRecord({TAGIHAN:rec.get("TAGIHAN"),JENIS:rec.get("JENIS"),PENYEDIA_ID:rec.get("PENYEDIA_ID"),JENIS_LAYANAN_ID:rec.get("JENIS_LAYANAN_ID"),TOTAL:0,TANGGAL:view.getSysdate(),STATUS:2});view.focus("NO_ID")},onSimpan:function(c){var b=this,a=b.getView(),e=a.app,d=e?(e.trxksr?e.trxksr:false):false;if(!d){a.notifyMessage("Anda belum membuka transaksi kasir / open cashier","danger-blue");return}a.save(c,{},function(h,f,g){b.onReset()})}});Ext.define("pembayaran.tagihan.nontunai.edc.Grid",{extend:"com.Grid",xtype:"pembayaran-tagihan-nontunai-edc-grid",controller:"pembayaran-tagihan-nontunai-edc-grid",viewModel:{stores:{store:{type:"pembayaran-pembayarantagihan-store"}},data:{listConfig:{batal:true}}},border:false,cls:"x-br-top",columns:[{xtype:"rownumberer",text:"No",align:"left",width:60},{text:"Nomor",width:90,dataIndex:"NOMOR"},{text:"Jenis Kartu",width:100,dataIndex:"JENIS_KARTU_ID",renderer:"onRendererJenisKartu"},{text:"Nama Pemilik Kartu",flex:2,dataIndex:"NAMA"},{text:"No. Kartu",width:200,dataIndex:"NO_ID"},{text:"Bank Penerbit",flex:2,dataIndex:"BANK_ID",renderer:"onRendererBank"},{text:"Kode Aprove",flex:1,dataIndex:"REF"},{xtype:"templatecolumn",text:"No. Seri",width:110,tpl:'{[this.getReferensi(values, "KWITANSI_PEMBAYARAN", "NOMOR")]}'},{xtype:"numbercolumn",text:"Total",format:"0,00",align:"right",width:120,dataIndex:"TOTAL"},{xtype:"widgetcolumn",align:"center",text:"Action",width:110,bind:{hidden:"{!listConfig.status}"},widget:{xtype:"fieldcontainer",flex:1,defaults:{padding:2},layout:"fit",items:[{xtype:"button",text:"Batalkan",action:0,handler:"onBatal"},{xtype:"button",text:"Dibatalkan",action:1,ui:"soft-red"}]},onWidgetAttach:"onWidgetAttach"},{text:"#",width:55,align:"center",xtype:"widgetcolumn",widget:{xtype:"button",iconCls:"x-fa fa-print",ui:"soft-green",tooltip:"Cetak Kuitansi",listeners:{click:"onCetakKwitansi"}}}]});Ext.define("pembayaran.tagihan.nontunai.edc.GridController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-nontunai-edc-grid",onRendererBank:function(e,c,d){var b=d.get("REFERENSI"),a=b?(b.BANK?b.BANK.DESKRIPSI:""):"";return a},onRendererJenisKartu:function(e,c,d){var b=d.get("REFERENSI"),a=b?(b.JENIS_KARTU?b.JENIS_KARTU.DESKRIPSI:""):"";return a},onWidgetAttach:function(h,b,g){var e=this,c=e.getViewModel().get("listConfig.batal"),a=g.get("STATUS"),i=b.down("[action=0]"),f=b.down("[action=1]");i.setHidden(a==0);f.setHidden(!(a==0));if(!c){i.setHidden(true)}},onBatal:function(c){var e=this,b=e.getView(),f=c.ownerCt.getWidgetRecord();if(f){var d=f.get("REFERENSI"),g=d?(d.JENIS?d.JENIS.DESKRIPSI:""):"",a=f.get("STATUS");f.showError=true;f.animateTarget=c;f.scope=e;b.showMessageBox({title:"Pembatalan EDC",message:"Anda yakin ingin membatalkan EDC ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"no",animateTarget:c,fn:function(h){if(h==="yes"){f.set("STATUS",0);f.save({callback:function(k,i,j){if(j){b.notifyMessage("Pembatalan EDC berhasil")}else{k.set("STATUS",a)}e.getView().fireEvent("batal")}})}else{f.set("STATUS",a)}}})}},onCetakKwitansi:function(e){var d=this,b=d.getView(),c=b.getGridConfig(),f=c.tagihan,a=e.getWidgetRecord();if(f){if(f.get("STATUS")==1){b.notifyMessage("Silahkan lakukan final tagihan terlebih dahulu...");return}}else{b.notifyMessage("Transaksi ini belum memiliki tagihan");return}b.openDialog("",true,100,50,{xtype:"kwitansi-form",title:"Kwitansi",ui:"panel-cyan",showCloseButton:true},function(g,i){var h=i.down("kwitansi-form");h.setFormConfig({hidden:true,cetak:true});h.createRecord({TAGIHAN:a.get("TAGIHAN"),TUNAI:0,JENIS_LAYANAN_ID:2,NAMA:a.get("NAMA"),STATUS:1});h.setParamReport({name:"pembayaran.CetakKwitansiEdc",params:{PNOMOR:a.get("NOMOR")}});h.on("cetak",function(j){b.reload();i.close()})})}});Ext.define("pembayaran.tagihan.nontunai.edc.Workspace",{extend:"com.Form",xtype:"pembayaran-tagihan-nontunai-edc-workspace",controller:"pembayaran-tagihan-nontunai-edc-workspace",viewModel:{data:{layananPenyedia:undefined,jenis:undefined}},layout:{type:"vbox",align:"stretch"},items:[{xtype:"pembayaran-tagihan-nontunai-edc-form",reference:"nontunaiedcform",listeners:{save:"onReload"}},{xtype:"pembayaran-tagihan-nontunai-edc-grid",flex:1,reference:"nontunaiedclist",listeners:{select:"onSelect",batal:"onReload"}}],setJenis:function(b){var a=this.getViewModel();a.set("jenis",b)},setLayananPenyedia:function(b){var a=this.getViewModel();a.set("layananPenyedia",b)},onLoadRecord:function(g,d){var b=g.getViewModel(),h=b.get("jenis"),f=b.get("layananPenyedia"),c=g.down("[reference=nontunaiedcform]"),i=g.down("[reference=nontunaiedclist]"),e=d.get("STATUS")==1,a=g.app.xpriv("1206")?e:false;c.setFormConfig({viewOnly:!a,simpan:a,reset:a,minDate:d.get("TANGGAL"),maxDate:g.getSysdate()});i.setListConfig({tagihan:d,batal:a});new Ext.util.DelayedTask(function(){i.load({TAGIHAN:d.get("ID"),PENYEDIA_ID:f.get("PENYEDIA_ID"),JENIS_LAYANAN_ID:f.get("JENIS_LAYANAN_ID"),NOT:Ext.JSON.encode({STATUS:[0]})});c.createRecord({TAGIHAN:d.get("ID"),JENIS:h,PENYEDIA_ID:f.get("PENYEDIA_ID"),JENIS_LAYANAN_ID:f.get("JENIS_LAYANAN_ID"),TOTAL:0,TANGGAL:g.getSysdate(),STATUS:2});c.focus("NO_ID")}).delay(1000)}});Ext.define("pembayaran.tagihan.nontunai.edc.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-nontunai-edc-workspace",onSelect:function(b,e){var d=this,c=d.getViewModel(),f=c.get("jenis"),a=d.getReferences();e.set("JENIS",f);a.nontunaiedcform.loadRecord(e)},onReload:function(){var a=this.getReferences();a.nontunaiedclist.load();this.getView().fireEvent("load")}});Ext.define("pembayaran.tagihan.pembatalan.Form",{extend:"com.Form",xtype:"pembatalan-tagihan-form",controller:"pembatalan-tagihan-form",model:"pembayaran.tagihan.pembatalan.Model",bodyPadding:5,layout:"fit",items:[{xtype:"referensi-combo",name:"JENIS",params:{JENIS:60},firstLoad:true,allowBlank:false,editable:false,emptyText:"[Jenis Pembatalan]"}],buttons:[{text:"Batalkan",ui:"soft-blue",iconCls:"x-fa fa-minus-circle",handler:"onBatalkan"}]});Ext.define("pembayaran.tagihan.pembatalan.FormController",{extend:"Ext.app.ViewController",alias:"controller.pembatalan-tagihan-form",onBatalkan:function(c){var b=this,a=b.getView();a.save(c,{success:"Tagihan Final telah dibatalkan"})}});Ext.define("pembayaran.tagihan.penjamin.List",{extend:"com.Grid",alias:"widget.penjamintagihan-list",controller:"penjamintagihan-list",viewModel:{stores:{store:{type:"penjamin-tagihan-store"}}},tagihan:undefined,border:false,columns:[{text:"Penjamin",dataIndex:"PENJAMIN",flex:1,editor:{xtype:"referensi-combo",params:{JENIS:10,STATUS:1},firstLoad:true,allowBlank:false,listeners:{select:"onPenjaminCombo"}},renderer:"onRendererPenjamin"},{text:"Ke",dataIndex:"KE",flex:1,hidden:true},{xtype:"numbercolumn",text:"Total",dataIndex:"TOTAL",width:100,align:"right",format:"0,000",editor:{xtype:"numberfield",listeners:{change:"onChange"}}},{menuDisabled:true,sortable:false,align:"center",xtype:"actioncolumn",width:50,items:["@hapus"],bind:{hidden:"{isFinal}"}}],plugins:{ptype:"cellediting",clicksToEdit:1,listeners:{beforeedit:"onBeforeEdit"}},actions:{hapus:{iconCls:"x-fa fa-remove",tooltip:"Hapus Penjamin",handler:"onHapus"}},dockedItems:[{xtype:"toolbar",dock:"top",items:["->",{xtype:"button",iconCls:"x-fa fa-retweet",tooltip:"Refresh",margin:"2.2.2.2",ui:"soft-purple",handler:"onRefresh"},{xtype:"button",margin:"2.2.2.2",tooltip:"Tambah / Add",iconCls:"x-fa fa-plus-circle",ui:"soft-green",handler:"onAdd",hidden:true,bind:{hidden:"{isFinal}"}},{xtype:"button",margin:"2.2.2.2",tooltip:"Tambah / Add",iconCls:"x-fa fa-save",ui:"soft-blue",handler:"onSave",hidden:true,bind:{hidden:"{isFinal}"}}]}],setTagihan:function(b){var a=this.getViewModel();this.tagihan=b;a.set("isFinal",this.app.xpriv("1212")?b.get("STATUS")==2:true)}});Ext.define("pembayaran.tagihan.penjamin.ListController",{extend:"Ext.app.ViewController",alias:"controller.penjamintagihan-list",recordSelected:undefined,onRendererPenjamin:function(e,c,d){var b=d.get("REFERENSI"),a=b?b.PENJAMIN:null;if(a){return a.DESKRIPSI}return e},onBeforeEdit:function(d,c){var b=this.getView(),g=b.tagihan,h=c.record,a=b.getReferensi(h.data,"PENJAMIN"),e=false;if(h.get("KE")==1){e=true;if(a){var f=a.REF_ID.split(".");if(f.length>1){if(f[1]=="1"){e=false}}}}if(g){if(g.get("STATUS")==2){e=true}}if(e){c.cancel=true;return}this.recordSelected=h},onChange:function(a,c,b){if(c!=b){if(this.recordSelected){this.recordSelected.set("MANUAL",1)}}},onPenjaminCombo:function(a,d){var c=this.getView().getSelection();if(d){if(Ext.isArray(c)){if(c.length>0){var b=c[0].get("REFERENSI")||{};b.PENJAMIN=d.data;c[0].set("REFERENSI",b)}}}},onRefresh:function(a){this.getView().refresh()},onAdd:function(d){var e=this,a=e.getView(),f=a.tagihan,b=e.getStore("store"),c=Ext.create("data.model.PenjaminTagihan");c.set("TAGIHAN",f.get("ID"));b.insert(b.getCount(),c)},onHapus:function(c,h,b,i,d,f){var a=this.getView(),e=a.tagihan;if(f.get("KE")==1){a.notifyMessage("Penjamin ini tidak dapat di hapus","danger-red");return}a.showMessageBox({title:"Hapus Penjamin",message:"Anda yakin ingin menghapus penjamin ini ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"no",animateTarget:c,fn:function(g){if(g==="yes"){f.drop();f.set("id",e.get("ID")+"-"+f.get("PENJAMIN"));f.save({callback:function(j,k,l){if(l){a.notifyMessage("Data telah dihapus","danger-red");a.reload();a.fireEvent("changed")}}})}}})},onSave:function(d){var e=this,b=e.getView(),g=b.tagihan,c=e.getStore("store"),f=c.getModifiedRecords(),a=0;Ext.Array.each(f,function(h){h.set("id",g.get("ID")+"-"+h.get("PENJAMIN"));h.save({callback:function(i,j,k){if(k){if(a===(f.length-1)){e.getView().notifyMessage("Data telah disimpan")}}a++}})});b.reload();b.fireEvent("changed")}});Ext.define("pembayaran.tagihan.penjamin.Workspace",{extend:"com.Form",xtype:"workspace-penjamintagihan",controller:"workspace-penjamintagihan",layout:"border",items:[{region:"center",xtype:"penjamintagihan-list",reference:"penjamintagihanlist",listeners:{changed:"onChanged"}}],onLoadRecord:function(b,c){var a=b.down("penjamintagihan-list");a.load({TAGIHAN:c.get("ID")});a.setTagihan(c)}});Ext.define("pembayaran.tagihan.penjamin.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-penjamintagihan",onChanged:function(){this.getView().fireEvent("load")}});Ext.define("pembayaran.tagihan.penjualan.Info",{extend:"com.Form",xtype:"tagihan-penjualan-info",controller:"tagihan-penjualan-info",viewModel:{stores:{nonTunai:{type:"pembayaran-pembayarantagihan-store"},pengunjung:{type:"penjualan-store"}},data:{tagihan:undefined,id_tagihan:undefined,total:0,nama:undefined,viewConfig:{tagihanFinal:false}}},layout:{type:"vbox",align:"stretch"},bodyPadding:5,defaults:{margin:5},fieldDefaults:{labelAlign:"top"},border:true,autoScroll:true,header:{itemPosition:1,items:[{xtype:"button",ui:"soft-red",iconCls:"x-fa fa-calculator",tooltip:"Hitung Ulang Tagihan",bind:{hidden:"{!viewConfig.tagihanFinal}"},handler:"onHitungUlang",margin:"0 1 0 0"}]},initComponent:function(){var a=this;a.items=[{xtype:"button",text:"Cetak Rincian",reference:"btnprintrincian",tooltip:"Cetak Rincian",iconCls:"x-fa fa-print",handler:"onCetakRincianPenjualan"},{fieldLabel:"No.Tagihan",name:"TAGIHAN",xtype:"textfield",readOnly:true,bind:"{id_tagihan}"},{fieldLabel:"Nama",xtype:"textfield",readOnly:true,bind:"{nama}"},{xtype:"headervalue",fontSize:"20px",paddingText:"7px 0 0 0",height:60,reference:"totaltagihan",title:"Total Tagihan"},{xtype:"headervalue",reference:"totalnon",title:"Total Pembayaran Non Tunai"},{xtype:"headervalue",reference:"totalbulat",title:"Pembulatan"},{xtype:"headervalue",reference:"sisapembayaran",title:"<b>Sisa Pembayaran</b>"},{xtype:"header-input-number",reference:"pembayarantunai",title:"<b>Input Pembayaran Tunai</b>",height:100,listeners:{numberchange:function(d){var c=0,b=a.down("[reference=sisapembayaran]"),e=a.down("[reference=kembalian]");if(d){c=d}c=c-b.getValue();if(c<0){c=0}e.setValue(c)}}},{xtype:"headervalue",reference:"kembalian",title:"<b>Sisa Kembalian</b>",fontSize:"24px",paddingText:"7px 0 0 0",height:65},{xtype:"kwitansi-form",title:"Kwitansi",bind:{hidden:"{total < 1}"},reference:"kwitansi"}];a.callParent()},buttons:[{text:"Final Tagihan",reference:"btnfinaltagihanpenjualan",tooltip:"Selesai",flex:1,iconCls:"x-fa fa-save",handler:"onFinalTagihanPenjualan",hidden:true,bind:{hidden:"{!viewConfig.tagihanFinal}"}},{xtype:"button",iconCls:"x-fa fa-print",ui:"soft-cyan",text:"Cetak Kwitansi",bind:{hidden:"{viewConfig.tagihanFinal}"},handler:"onCetakKwitansi"}],load:function(e){var h=this,a=h.getViewModel(),g=h.down("kwitansi-form"),b=h.down("[reference=totaltagihan]"),j=h.down("[reference=totalnon]"),c=h.down("[reference=totalbulat]"),f=h.down("[reference=sisapembayaran]"),k=a.get("nonTunai"),d=a.get("pengunjung");if(e){var i=h.getReferensi(e.data,"KWITANSI_PEMBAYARAN");if(i){Ext.Array.each(i,function(l){g.loadRecord(Ext.create("data.model.KwitansiPembayaran",l));g.setFormConfig({viewOnly:true,cetak:false})})}a.set("tagihan",e);a.set("total",e.get("TOTAL"));a.set("id_tagihan",e.get("ID"));a.set("viewConfig.tagihanFinal",e.get("STATUS")==1&&h.app.xpriv("121401",false));b.setValue(e.get("TOTAL"));c.setValue(e.get("PEMBULATAN"));d.removeAll();d.setQueryParams({NOMOR:e.get("ID")});d.load({callback:function(l){if(l.length>0){a.set("nama",l[0].get("PENGUNJUNG"))}}});k.removeAll();k.setQueryParams({TAGIHAN:e.get("ID"),JENIS:2});k.load({callback:function(n){var m=0;if(n.length>0){m=n[0].get("TOTAL")}j.setValue(m);var l=e.get("TOTAL")-m+e.get("PEMBULATAN");l=l<0?0:l;f.setValue(l);a.set("total",l)}})}}});Ext.define("pembayaran.tagihan.penjualan.InfoController",{extend:"Ext.app.ViewController",alias:"controller.tagihan-penjualan-info",onHitungUlang:function(c){var e=this,a=e.getView(),d=e.getViewModel(),f=d.get("tagihan"),b=Ext.create("data.model.Tagihan",{ID:f.get("ID")});b.set("HITUNGULANG",1);b.set("JENIS",4);a.ownerCt.setLoading(true);b.animateTarget=c;b.scope=e;b.showError=true;b.timeout=600000;b.save({callback:function(i,g,h){if(h){a.fireEvent("hitungtagihan")}a.ownerCt.setLoading(false)}})},onFinalTagihanPenjualan:function(b){var c=this,a=c.getView(),f=a.app,e=f?f.xpriv:false,d=f?(f.trxksr?f.trxksr:false):false;if(!e("121401",false)){a.notifyMessage("Anda tidak memiliki hak akses untuk melakukan Tagihan Final","danger-blue");return}if(!d){a.notifyMessage("Anda belum membuka transaksi kasir / open cashier","danger-blue");return}a.showMessageBox({title:"Finalkan Tagihan",message:"Anda yakin ingin memfinalkan tagihan ini ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"no",animateTarget:b,fn:function(g){if(g==="yes"){c.finalTagihanPenjualan(b)}}})},finalTagihanPenjualan:function(k){var g=this,i=g.getView(),c=g.getViewModel(),b=c.get("tagihan"),h=c.get("total"),d=i.app,f=d?(d.trxksr?d.trxksr:false):false,a=i.getForm().getValues(),j=Ext.create("data.model.KwitansiPembayaran",{TAGIHAN:a.TAGIHAN,NOMOR:a.KWITANSI,NAMA:a.NAMA_PEMBAYAR}),e=Ext.create("pembayaran.pembayarantagihan.Model",{TAGIHAN:a.TAGIHAN,JENIS:8,REF:f,TRANSAKSI_KASIR_NOMOR:f,TOTAL:h,STATUS:2});k.setDisabled(true);j.animateTarget=k;j.scope=g;j.showError=true;j.save({callback:function(n,l,m){if(m){e.animateTarget=k;e.scope=g;e.showError=true;e.save({callback:function(q,o,p){if(p){i.setLoading(false);c.set("viewConfig.tagihanFinal",false);b.set("STATUS",2);i.notifyMessage("Tagihan telah di finalkan");if(h>0){i.showMessageBox({title:"Cetak Kwitansi",message:"Anda ingin mencetak kwitansi ?",ui:"window-cyan",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:k,fn:function(r){if(r==="yes"){g.onCetakKwitansi()}}})}i.fireEvent("suksesfinaltagihan",b)}k.setDisabled(false)}})}else{k.setDisabled(false)}}})},onCetakKwitansi:function(){var d=this,a=d.getView(),c=d.getViewModel(),b=d.getReferences(),e=c.get("tagihan");a.openDialog("",true,100,50,{xtype:"kwitansi-form",title:"Kwitansi",ui:"panel-cyan",showCloseButton:true},function(f,g){kw=g.down("kwitansi-form");kw.setFormConfig({viewOnly:false,cetak:true});kw.setParamReport({name:"pembayaran.CetakKwitansiPenjualan",params:{PTAGIHAN:e.get("ID"),PJENIS:4}});kw.createRecord({TAGIHAN:e.get("ID"),STATUS:1});kw.on("cetak",function(h){b.kwitansi.loadRecord(h);g.close()})})},onCetakRekapPenjualan:function(){this.cetakRincian(2)},onCetakRincianPenjualan:function(){this.cetakRincian(1)},privates:{cetakRincian:function(c){var f=this,a=f.getView(),h=f.getViewModel().get("tagihan"),b="Word",e="docx",g=true,d="Cetak Rincian";a.showMessageBox({title:d,message:"Tekan tombol Yes/Ya utk cetak langsung<br/>Tekan tombol No/Tidak untuk Preview",ui:"window-cyan",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:f,fn:function(i){if(i!="yes"){b="Pdf";e="pdf";g=false}a.cetak({NAME:"pembayaran."+(c==1?"CetakRincianPenjualan":"CetakRekapRincianPenjualan"),TYPE:b,EXT:e,PARAMETER:{PTAGIHAN:h.get("ID"),PSTATUS:1},REQUEST_FOR_PRINT:g,PRINT_NAME:"CetakRincian"},function(j){a.printPreview(d,j)})}})}}});Ext.define("pembayaran.tagihan.penjualan.Links",{extend:"com.Tab",alias:"widget.tagihan-penjualan-links",cls:"x-br-top",border:false,ui:"header-tab",defaults:{flex:1,border:false},items:[{title:"Rincian",xtype:"rincian-tagihan-penjualan-Workspace",iconCls:"x-fa fa-list-alt",reference:"workspacerinciantagihanpenjualan"},{title:"Non Tunai",xtype:"workspace-nontunai",jenis:2,notLoadLinks:true,listeners:{load:"onReload"},iconCls:"x-fa fa-credit-card"},{title:"Info Pembayaran",xtype:"pembayaran-pembayarantagihan-workspace",listeners:{load:"onReload"},iconCls:"x-fa fa-info"}],load:function(b){var c=this,a=c.getActiveTab();if(a){if(a.loadRecord){a.loadRecord(b)}else{if(a.load){a.load(b)}}}}});Ext.define("pembayaran.tagihan.penjualan.Workspace",{extend:"com.Form",alias:"widget.tagihan-penjualan-Workspace",controller:"tagihan-penjualan-WorkspaceController",viewModel:{data:{tagihan:undefined}},layout:"border",bodyPadding:0,items:[{region:"center",xtype:"tagihan-penjualan-links",reference:"tagihanpenjualanlink",flex:3,listeners:{tabchange:"onTabChange"}},{region:"east",xtype:"tagihan-penjualan-info",reference:"tagihanpenjualaninfo",flex:1,collapsible:true,split:true,title:"Info tagihan",listeners:{suksesfinaltagihan:"onSuksesFinal",hitungtagihan:"onReload"}}],load:function(e){var b=this.getViewModel(),c=this.down("[reference=tagihanpenjualanlink]"),d=this.down("[reference=tagihanpenjualaninfo]"),a=c.getActiveTab();b.set("tagihan",e);if(a.notLoadLinks==undefined){c.load(e)}c.load(e);d.load(e)}});Ext.define("pembayaran.tagihan.penjualan.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.tagihan-penjualan-WorkspaceController",onReload:function(){var d=this,a=this.getView(),c=d.getViewModel(),b=c.get("tagihan");a.setLoading(true);(new Ext.util.DelayedTask(function(){var e=Ext.create("data.model.Tagihan",{ID:b.get("ID")});e.load({callback:function(h,f,g){if(g){a.load(h)}a.setLoading(false)}})})).delay(1500)},onSelectedTagihanPenjualan:function(j,h){var i=this,f=i.getReferences(),g=h.get("ID");f.tagihanpenjualandetil.loadStore(g)},onSuksesFinal:function(b){var a=this;a.getView().load(b)},onTabChange:function(d,a){var c=this.getViewModel(),b=c.get("tagihan");if(a.loadRecord){a.loadRecord(b)}else{if(a.load){a.load(b)}}}});Ext.define("pembayaran.tagihan.penjualan.rincian.List",{extend:"com.Grid",alias:"widget.rincian-tagihan-penjualan-list",controller:"rincian-tagihan-penjualan-list",viewModel:{stores:{store:{type:"penjualan-detil-store"}}},columns:[{xtype:"rownumberer",text:"No",align:"left",width:50},{xtype:"templatecolumn",text:"Nama Obat",flex:1,sortable:false,tpl:'<div style="white-space:normal !important;">{REFERENSI.FARMASI.NAMA}</div>'},{text:"Jml",dataIndex:"JUMLAH",hideTrigger:true,width:75,align:"right",editor:{xtype:"numberfield",hideTrigger:true,reference:"jumlah",name:"JUMLAH"}},{text:"Harga (Rp)",format:"0,00",renderer:"Renderhargasatuan",align:"right",width:100,summaryRenderer:"onSummaryInfoRenderer"},{xtype:"numbercolumn",text:"Jumlah (Rp)",align:"right",format:"0,00",width:120,renderer:"onTotalRenderer",summaryRenderer:"onSummaryRenderer"}],features:[{ftype:"summary",dock:"bottom"}]});Ext.define("pembayaran.tagihan.penjualan.rincian.ListController",{extend:"Ext.app.ViewController",alias:"controller.rincian-tagihan-penjualan-list",initViewModel:function(){var c=this,a=c.getView(),b=c.getStore("store");b.doAfterLoad=function(e){var d=0;e.each(function(h){var f=h.get("REFERENSI"),o=Number(f?(f.MARGIN_PENJAMIN?f.MARGIN_PENJAMIN.MARGIN:0):0),l=Number(f?(f.PPN?f.PPN.PPN:0):0),i=Number(f?(f.HARGA_BARANG?f.HARGA_BARANG.HARGA_JUAL:0):0),g=i*(o/100),k=parseFloat(i)+parseFloat(g),m=h.get("JUMLAH")*k,j=parseFloat(k*(l/100)),n=parseFloat(m+j);d=d+n});a.total=d}},onTotalRenderer:function(a,m,d){var h=this,k=h.getView(),b=d.get("REFERENSI"),n=Number(b?(b.MARGIN_PENJAMIN?b.MARGIN_PENJAMIN.MARGIN:0):0),j=Number(b?(b.PPN?b.PPN.PPN:0):0),e=Number(b?(b.HARGA_BARANG?b.HARGA_BARANG.HARGA_JUAL:0):0),c=e*(n/100),g=parseFloat(e)+parseFloat(c),i=d.get("JUMLAH")*g,f=parseFloat(g*(j/100)),l=parseFloat(i+f);this.initViewModel();return'<span style="color:black;"> Rp. '+Ext.util.Format.number(l,"0,00")+"</span>"},onSummaryRenderer:function(d,b,c){var a='<span style="font-size: 12px; font-weight: bold">'+Ext.util.Format.number(this.getView().total,"0,00")+"</span>";return a},Renderhargasatuan:function(a,j,d){var b=d.get("REFERENSI"),k=Number(b?(b.MARGIN_PENJAMIN?b.MARGIN_PENJAMIN.MARGIN:0):0),i=Number(b?(b.PPN?b.PPN.PPN:0):0),f=Number(b?(b.HARGA_BARANG?b.HARGA_BARANG.HARGA_JUAL:0):0),c=f*(k/100),h=parseFloat(f)+parseFloat(c),g=parseFloat(h*(i/100)),e=parseFloat(h+g);return'<span style="color:black;"> Rp. '+Ext.util.Format.number(e,"0,00")+"</span>"},onSummaryInfoRenderer:function(){return'<span style="font-size: 12px; font-weight: bold">Total (Rp.): </span>'}});Ext.define("pembayaran.tagihan.penjualan.rincian.Workspace",{extend:"com.Form",alias:"widget.rincian-tagihan-penjualan-Workspace",layout:"fit",items:[{xtype:"rincian-tagihan-penjualan-list",reference:"rinciantagihanpenjualan",flex:1}],onLoadRecord:function(a,b){a.down("rincian-tagihan-penjualan-list").load({PENJUALAN_ID:b.get("ID")})}});Ext.define("pembayaran.tagihan.piutang.Workspace",{extend:"com.Tab",xtype:"workspace-piutang",controller:"workspace-piutang",viewModel:{data:{tagihan:undefined}},items:[{title:"Perorangan",xtype:"workspace-piutangperorangan",reference:"piutangperorangan",listeners:{save:"onSimpan",batal:"onSimpan"}},{title:"Perusahaan",xtype:"workspace-piutang-penjamin",reference:"piutangpenjaminform",listeners:{save:"onSimpan",batal:"onSimpan"}}],load:function(c){var b=this;vm=b.getViewModel();vm.set("tagihan",c);var a=b.getActiveTab();if(a){if(a.loadRecord){a.loadRecord(c)}else{if(a.load){a.load(c)}}}},listeners:{tabchange:"onTabChange",save:"onSimpan"}});Ext.define("pembayaran.tagihan.piutang.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-piutang",onTabChange:function(d,a){var c=this.getViewModel(),b=c.get("tagihan");if(a.loadRecord){a.loadRecord(b)}else{if(a.load){a.load(b)}}},onSimpan:function(){this.getView().fireEvent("load")}});Ext.define("pembayaran.tagihan.piutang.penjamin.Form",{extend:"com.Form",xtype:"piutangpenjamin-form",controller:"piutangpenjamin-form",model:"data.model.PiutangPerusahaan",layout:{type:"vbox",align:"stretch"},defaults:{border:false,margin:" 5 5 5 5 "},items:[{flex:1,layout:{type:"hbox",align:"stretch"},defaults:{border:false,flex:1,margin:" 2 5 2 5 ",allowBlank:false,bind:{readOnly:"{formConfig.viewOnly}"}},items:[{xtype:"referensi-combo",params:{JENIS:10},emptyText:"[ PENJAMIN ]",name:"PENJAMIN",flex:1,monitorTab:true,selectOnTab:true,editable:true,firstLoad:true},{xtype:"textfield",flex:1,name:"TELEPON",emptyText:"[ NO. TELPON ]"}]},{flex:1,layout:{type:"hbox",align:"stretch"},defaults:{border:false,allowBlank:false,flex:1,margin:" 2 5 2 5 ",bind:{readOnly:"{formConfig.viewOnly}"}},items:[{xtype:"textfield",name:"TOTAL",emptyText:"[ TOTAL ]"},{flex:1,name:"ALAMAT",emptyText:"[ ALAMAT ]",xtype:"textfield"}]}],buttons:[{text:"Simpan",ui:"soft-blue",iconCls:"x-fa fa-save",handler:"onSimpan",bind:{hidden:"{!formConfig.simpan}"},tooltip:{text:"Simpan",mouseOffset:[0,-75]}},{text:"Cetak Surat Piutang",ui:"soft-green",iconCls:"x-fa fa-print",handler:"onCetak",tooltip:{text:"Cetak",mouseOffset:[0,-75]}},{text:"Reset",ui:"soft-red",iconCls:"x-fa fa-refresh",handler:"onReset",bind:{hidden:"{!formConfig.simpan}"},tooltip:{text:"Reset",mouseOffset:[0,-75]}}]});Ext.define("pembayaran.tagihan.piutang.penjamin.FormController",{extend:"Ext.app.ViewController",alias:"controller.piutangpenjamin-form",onReset:function(){var b=this,a=b.getView(),c=b.getViewModel().get("record");a.createRecord({TAGIHAN:c.get("TAGIHAN"),STATUS:1,TANGGAL:a.getSysdate()})},onSimpan:function(b){var c=this,a=c.getView();a.save(b,{},function(f,d,e){if(e){c.onReset();a.fireEvent("success",e)}})}});Ext.define("pembayaran.tagihan.piutang.penjamin.List",{extend:"com.Grid",alias:"widget.piutang-penjamin-list",controller:"piutang-penjamin-list",viewModel:{data:{listConfig:{action:false}},stores:{store:{type:"piutang-perusahaan-store"}}},cls:"x-br-top",border:false,columns:[{xtype:"rownumberer",text:"No",align:"left",width:60},{text:"Penjamin",dataIndex:"PENJAMIN",flex:2,renderer:"onRendererPenjamin"},{text:"No. Telpon",dataIndex:"TELEPON",flex:1},{text:"Alamat",dataIndex:"ALAMAT",flex:2},{xtype:"numbercolumn",text:"Total",dataIndex:"TOTAL",flex:1,format:"0,00",align:"right"},{xtype:"datecolumn",text:"Tanggal",dataIndex:"TANGGAL",flex:1,format:"d-m-Y H:i:s",align:"center"},{xtype:"widgetcolumn",align:"center",text:"#",bind:{hidden:"{!listConfig.action}"},widget:{xtype:"button",iconCls:"x-fa fa-trash",ui:"soft-red",tooltip:"Batalkan piutang",action:0,handler:"onBatal"}}]});Ext.define("pembayaran.tagihan.piutang.penjamin.ListController",{extend:"Ext.app.ViewController",alias:"controller.piutang-penjamin-list",onRendererPenjamin:function(e,b,d){var c=d.get("REFERENSI"),a=c?(c.PENJAMIN?c.PENJAMIN.DESKRIPSI:""):"";return a},onBatal:function(b){var c=this,a=c.getView(),d=b.getWidgetRecord();if(d){d.showError=true;d.animateTarget=b;d.scope=c;a.showMessageBox({title:"Pembatalan Piutang Perusahaan",message:"Anda yakin ingin membatalkan piutang perusahaan ini ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:b,fn:function(e){if(e==="yes"){d.set("STATUS",0);d.save({callback:function(h,f,g){if(g){a.notifyMessage("Pembatalan Piutang Perusahaan berhasil")}else{h.set("STATUS",1)}a.reload();a.fireEvent("batal")}})}else{d.set("STATUS",1)}}})}}});Ext.define("pembayaran.tagihan.piutang.penjamin.Workspace",{extend:"com.Form",xtype:"workspace-piutang-penjamin",controller:"workspace-piutang-penjamin",layout:"border",items:[{region:"north",title:"Form",iconCls:"x-fa fa-file-o",xtype:"piutangpenjamin-form",border:false,reference:"piutangpenjaminform",listeners:{save:"onSuccess"}},{region:"center",title:"List",iconCls:"x-fa fa-server",xtype:"piutang-penjamin-list",flex:1,border:false,reference:"piutangpenjaminlist",listeners:{select:"onSelect",batal:"onBatal"}}],onLoadRecord:function(d,g){var e=d.down("piutang-penjamin-list"),c=d.down("piutangpenjamin-form");if(g){var a=g.get("STATUS")==1,b=d.app.xpriv("1204")?a:false,f={TAGIHAN:g.get("ID"),TANGGAL:c.getSysdate(),STATUS:1};c.setFormConfig({viewOnly:!b,simpan:b});c.createRecord(f);e.setListConfig({action:g.get("STATUS")==1});e.load({TAGIHAN:g.get("ID"),STATUS:1})}}});Ext.define("pembayaran.tagihan.piutang.penjamin.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-piutang-penjamin",onSuccess:function(e){var c=this,a=c.getView(),b=c.getReferences(),d=b.piutangpenjaminlist;d.reload();a.fireEvent("save",e)},onSelect:function(b,f){var d=this,c=d.getViewModel(),e=c.get("record"),a=d.getReferences();if(f){a.piutangpenjaminform.setFormConfig({viewOnly:e.get("STATUS")==2,simpan:e.get("STATUS")==1});a.piutangpenjaminform.loadRecord(f)}},onBatal:function(){var b=this,a=b.getView();a.fireEvent("batal")}});Ext.define("pembayaran.tagihan.piutang.perorangan.Form",{extend:"com.Form",xtype:"piutangperorangan-form",controller:"piutangperorangan-form",model:"data.model.PiutangPasien",layout:{type:"hbox",align:"stretch"},defaultType:"fieldcontainer",defaults:{margin:"0 5 0 5"},items:[{layout:{type:"vbox",align:"stretch"},flex:1,defaults:{allowBlank:false,margin:"0 0 1 0",labelWidth:150,bind:{readOnly:"{formConfig.viewOnly}"}},items:[{xtype:"textfield",fieldLabel:"Nama",name:"NAMA",enforceMaxLength:true,maxLength:75},{xtype:"referensi-combo",fieldLabel:"Hubungan dgn Pasien",params:{JENIS:7},name:"SHDK",editable:false,firstLoad:true,emptyText:"[Hubungan Dengan Pasien]"},{xtype:"referensi-combo",fieldLabel:"Kartu Tanda Pengenal",params:{JENIS:9},name:"JENIS_KARTU",editable:false,firstLoad:true,emptyText:"[Kartu Tanda Pengenal]"},{xtype:"textfield",fieldLabel:"No. Kartu Pengenal",name:"NO_KARTU_IDENTITAS",enforceMaxLength:true,maxLength:16},{xtype:"textfield",fieldLabel:"Alamat KTP",name:"ALAMAT_KARTU",enforceMaxLength:true,maxLength:150},{xtype:"textfield",fieldLabel:"Alamat Tempat Tinggal",name:"ALAMAT_TEMPAT_TINGGAL",enforceMaxLength:true,maxLength:150}]},{layout:{type:"vbox",align:"stretch"},flex:1,defaults:{margin:"0 0 1 0",labelWidth:150},items:[{xtype:"textfield",fieldLabel:"No. Telepon",name:"TELEPON",enforceMaxLength:true,maxLength:35,bind:{readOnly:"{formConfig.viewOnly}"}},{xtype:"textfield",fieldLabel:"Alasan",name:"ALASAN",enforceMaxLength:true,maxLength:35,bind:{readOnly:"{formConfig.viewOnly}"}},{xtype:"fieldcontainer",fieldLabel:"Tgl. Piutang",layout:{type:"hbox"},defaults:{allowBlank:false},items:[{name:"TANGGAL",reference:"tanggal",flex:1,xtype:"datefield",emptyText:"[Tanggal]",format:"d/m/Y",margin:"0 1 0 0",bind:{readOnly:"{formConfig.viewOnly}",minValue:"{formConfig.minDate}",maxValue:"{formConfig.maxDate}"}},{name:"WAKTU",reference:"waktu",width:105,xtype:"timefield",emptyText:"[Jam:Mnt:Dtk]",format:"H:i:s",hideTrigger:true,bind:{readOnly:"{formConfig.viewOnly}"}}]},{xtype:"numberfield",textAlign:"right",fieldLabel:"Jumlah Piutang",reference:"jumlahpiutang",name:"TOTAL",emptyText:"[ Rp. ]",minValue:0,hideTrigger:true,bind:{readOnly:"{formConfig.viewOnly}"},allowBlank:false,listeners:{change:"onChange"}},{xtype:"radiogroup",fieldLabel:"Jenis Pembayaran",reference:"jenispembayaran",columns:2,simpleValue:true,defaults:{allowBlank:false},bind:{readOnly:"{formConfig.viewOnly}",value:"{record.JENIS_PEMBAYARAN}"},layout:{autoFlex:false},defaults:{margin:"0 15 0 0"},items:[{boxLabel:"Bayar Sekaligus",name:"JENIS_PEMBAYARAN",checked:true,inputValue:"1"},{boxLabel:"Angsuran",name:"JENIS_PEMBAYARAN",inputValue:"2"}],listeners:{change:"onChange"}},{xtype:"numberfield",fieldLabel:"Lama Angsuran",name:"LAMA_ANGSURAN",reference:"lamaangsuran",value:0,minValue:0,allowBlank:false,bind:{readOnly:"{formConfig.viewOnly}",value:"{record.LAMA_ANGSURAN}"},listeners:{change:"onChange"}},{xtype:"numberfield",textAlign:"right",fieldLabel:"Besar Angsuran",name:"BESAR_ANGSURAN",emptyText:"[ Rp. ]",minValue:0,hideTrigger:true,bind:{readOnly:"{formConfig.viewOnly}",value:"{record.BESAR_ANGSURAN}"},allowBlank:false}]}],buttons:[{text:"Simpan",ui:"soft-blue",iconCls:"x-fa fa-save",handler:"onSimpan",bind:{hidden:"{!formConfig.simpan}"},tooltip:{text:"Simpan",mouseOffset:[0,-75]}},{text:"Reset",ui:"soft-red",iconCls:"x-fa fa-refresh",handler:"onReset",bind:{hidden:"{!formConfig.simpan}"},tooltip:{text:"Reset",mouseOffset:[0,-75]}}],onLoadRecord:function(b,c){var a=b.down("[name=WAKTU]");a.setValue(c.get("TANGGAL"))},onBeforeGetRecord:function(b,d){var c=Ext.Date.clone(b.down("[reference=tanggal]").getValue()),a=b.down("[reference=waktu]").getValue();c.setHours(a.getHours());c.setMinutes(a.getMinutes());c.setSeconds(a.getSeconds());d.TANGGAL=c}});Ext.define("pembayaran.tagihan.piutang.perorangan.FormController",{extend:"Ext.app.ViewController",alias:"controller.piutangperorangan-form",onFocusEnter:function(d,a){},onReset:function(){var b=this,a=b.getView(),c=b.getViewModel().get("record");a.createRecord({TAGIHAN:c.get("TAGIHAN"),NAMA:"",SHDK:"",JENIS_KARTU:"",TANGGAL:a.getSysdate(),TOTAL:0,LAMA_ANGSURAN:0,BESAR_ANGSURAN:0,STATUS:1});a.focus("NAMA")},onSimpan:function(c){var b=this,a=b.getView();a.save(c,{},function(f,d,e){b.onReset()})},onChange:function(c,a,b){this.hitungBesarAngsuran()},privates:{hitungBesarAngsuran:function(){try{var b=this,a=b.getReferences();rec=b.getViewModel().get("record"),tp=a.jumlahpiutang.getValue(),jp=a.jenispembayaran.getValue(),la=a.lamaangsuran.getValue();if(rec){if(jp==2){var d=la>0?tp/la:0;rec.set("JENIS_PEMBAYARAN",jp);rec.set("BESAR_ANGSURAN",d)}else{rec.set("LAMA_ANGSURAN",1);rec.set("BESAR_ANGSURAN",tp)}}}catch(c){}}}});Ext.define("pembayaran.tagihan.piutang.perorangan.List",{extend:"com.Grid",alias:"widget.piutangperorangan-list",controller:"piutangperorangan-list",viewModel:{data:{listConfig:{action:false}},stores:{store:{type:"piutang-pasien-store"}}},columns:[{xtype:"rownumberer",text:"No",align:"left",width:60},{text:"Nama",dataIndex:"NAMA",width:300},{text:"No. Kartu Identitas",dataIndex:"NO_KARTU_IDENTITAS",width:150},{text:"Jenis Kartu",dataIndex:"JENIS_KARTU",width:120,renderer:"onRendererJenisKartu"},{text:"Alamat",dataIndex:"ALAMAT_TEMPAT_TINGGAL",flex:1},{xtype:"datecolumn",text:"Tanggal",dataIndex:"TANGGAL",format:"d/m/Y H:i:s",width:140},{xtype:"numbercolumn",text:"Total",dataIndex:"TOTAL",format:"0,00",align:"right",width:120},{xtype:"templatecolumn",text:"Jenis Pembayaran",dataIndex:"JENIS_PEMBAYARAN",width:120,xtype:"templatecolumn",tpl:Ext.create("Ext.XTemplate",'<div style="white-space:normal;">{[this.getDeskripsi(values.JENIS_PEMBAYARAN)]}</div>',{getDeskripsi:function(a){return(a==1)?"Bayar Sekaligus":(a==2)?"Angsuran":""}})},{text:"Lama Angsuran",dataIndex:"LAMA_ANGSURAN",align:"right",width:120},{xtype:"numbercolumn",text:"Besar Angsuran",dataIndex:"BESAR_ANGSURAN",format:"0,00",align:"right",width:120},{xtype:"widgetcolumn",align:"center",text:"#",bind:{hidden:"{!listConfig.action}"},widget:{xtype:"button",iconCls:"x-fa fa-trash",ui:"soft-red",tooltip:"Batalkan piutang",action:0,handler:"onBatal"}}]});Ext.define("pembayaran.tagihan.piutang.perorangan.ListController",{extend:"Ext.app.ViewController",alias:"controller.piutangperorangan-list",onRendererJenisKartu:function(e,c,d){var b=d.get("REFERENSI"),a=b?(b.JENIS_KARTU?b.JENIS_KARTU.DESKRIPSI:e):e;return a},onRendererJenisPembayaran:function(e,c,d){var b=d.get("REFERENSI"),a=b?(b.JENIS_PEMBAYARAN?b.JENIS_PEMBAYARAN.DESKRIPSI:e):e;return a},onBatal:function(b){var c=this,a=c.getView(),d=b.getWidgetRecord();if(d){d.showError=true;d.animateTarget=b;d.scope=c;a.showMessageBox({title:"Pembatalan Piutang Perorangan",message:"Anda yakin ingin membatalkan piutang perorangan ini ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"yes",animateTarget:b,fn:function(e){if(e==="yes"){d.set("STATUS",0);d.save({callback:function(h,f,g){if(g){a.notifyMessage("Pembatalan Piutang Perorangan berhasil")}else{h.set("STATUS",1)}a.reload();a.fireEvent("batal")}})}else{d.set("STATUS",1)}}})}}});Ext.define("pembayaran.tagihan.piutang.perorangan.Workspace",{extend:"com.Form",xtype:"workspace-piutangperorangan",controller:"workspace-piutangperorangan",layout:"border",items:[{region:"north",xtype:"piutangperorangan-form",title:"Form",reference:"piutangperoranganform",listeners:{save:"onSuccess"}},{region:"center",xtype:"piutangperorangan-list",title:"List",reference:"piutangperoranganlist",listeners:{select:"onSelect",batal:"onBatal"}}],onLoadRecord:function(d,g){var e=d.down("piutangperorangan-list"),c=d.down("piutangperorangan-form");if(g){var a=g.get("STATUS")==1,b=d.app.xpriv("1204")?a:false,f={TAGIHAN:g.get("ID"),NAMA:"",SHDK:"",JENIS_KARTU:"",TANGGAL:c.getSysdate(),TOTAL:0,LAMA_ANGSURAN:0,BESAR_ANGSURAN:0,STATUS:1};c.setFormConfig({viewOnly:!b,simpan:b,minDate:g.get("TANGGAL"),maxDate:c.getSysdate()});c.createRecord(f);e.setListConfig({action:g.get("STATUS")==1});e.load({TAGIHAN:g.get("ID"),STATUS:1})}}});Ext.define("pembayaran.tagihan.piutang.perorangan.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-piutangperorangan",onSuccess:function(e){var c=this,a=c.getView(),b=c.getReferences(),d=b.piutangperoranganlist;d.reload();a.fireEvent("save",e)},onSelect:function(b,f){var d=this,c=d.getViewModel(),e=c.get("record"),a=d.getReferences();if(f){a.piutangperoranganform.setFormConfig({viewOnly:e.get("STATUS")==2,simpan:e.get("STATUS")==1});a.piutangperoranganform.loadRecord(f)}},onBatal:function(){var b=this,a=b.getView();a.fireEvent("batal")}});Ext.define("pembayaran.tagihan.piutang.widget.Info",{extend:"com.Form",xtype:"pembayaran-tagihan-piutang-widget-info",controller:"pembayaran-tagihan-piutang-widget-info",viewModel:{stores:{piutangPasienStore:{type:"piutang-pasien-store"},piutangPenjaminStore:{type:"piutang-perusahaan-store"}},data:{total:0,pasien:undefined},formulas:{formatTotal:function(b){var c=b("total"),a=1;if(c.length<=5){a=2}else{if(c.length==6){a=3}else{if(c.length==7){a=1}else{if(c.length==8){a=2}else{if(c.length==9){a=3}else{if(c.length==10){a=1}else{if(c.length==11){a=2}else{if(c.length==11){a=3}}}}}}}}return Ext.util.Format.substr(c,0,a)+this.getDeskripsi(c.length)}},getDeskripsi:function(b){var a="";if(b>=5&&b<7){a="rb"}else{if(b>=7&&b<10){a="jt"}else{if(b>=10){a="m"}}}return a}},cls:"shadow-panel",border:true,firstLoad:true,layout:{type:"vbox",align:"stretch"},jenisPiutang:1,iconCls:"fas fa-file-invoice-dollar",title:"Piutang Pasien",header:{margin:0,padding:"5 10 5 10",cls:"x-color-w"},bodyPadding:5,items:[{xtype:"component",flex:1,style:"text-align: center; padding-top: 20px; font-size: 5em; font-weight: bold",bind:{html:"<h1>{formatTotal}</h1>"}}],dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{flex:1,style:"border-radius:10px",text:"Pembayaran",xtype:"button",ui:"soft-red",handler:"onClickPembayaran"}]}],refresh:function(){var c=this,b=c.getViewModel(),a=b.get("pasien",a);c.getTotalPiutang(a.get("NORM")).then(function(d){b.set("total",d)})},getTotalPiutang:function(c){var e=this,g=e.jenisPiutang,d=e.getViewModel(),a=d.get("piutangPasienStore"),f=d.get("piutangPenjaminStore"),b=new Ext.Deferred();if(g==1){a.setQueryParams({NORM:c,GET_TOTAL:true});a.load({callback:function(i,h,k){if(k){var j=i[0];b.resolve(j.get("SISA_HARUS_BAYAR"))}else{b.reject("data tidak ditemukan")}}})}else{f.setQueryParams({NORM:c,GET_TOTAL:true});f.load({callback:function(i,h,k){if(k){var j=i[0];b.resolve(j.get("SISA_HARUS_BAYAR"))}else{b.reject("data tidak ditemukan")}}})}return b.promise}});Ext.define("pembayaran.tagihan.piutang.widget.InfoController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-tagihan-piutang-widget-info",onClickPembayaran:function(c){var e=this,a=e.getView(),b="pembayaran-piutang-pasien-workspace",d=e.getViewModel();if(a.jenisPiutang==2){b="pembayaran-piutang-perusahaan-workspace"}a.openDialog("",true,0,0,{title:"Pembayaran piutang Perorangan",xtype:b,showCloseButton:true},function(g,h){var f=h.down(b);f.load(d.get("pasien"));a.fireEvent("openpiutang");h.on("close",function(){a.refresh();a.fireEvent("closepiutang")})},c)}});Ext.define("pembayaran.tagihan.rincian.List",{extend:"com.Grid",alias:"widget.rincian-tagihan-list",controller:"rincian-tagihan-list",viewModel:{stores:{store:{type:"rincian-tagihan-store"}},data:{listConfig:{kunci:false}},formulas:{getKunciStatusText:function(a){return a("record.KUNCI")==1?"Terkunci":""},getTidakTerkunciStatusText:function(a){return a("record.KUNCI")==0?"Tdk Terkunci":""}}},total:0,tagihan:undefined,border:false,columns:[{xtype:"rownumberer",text:"No",align:"left",width:50,resizable:true},{xtype:"templatecolumn",tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 12px; white-space:normal !important;">{[values.RUANGAN]} </div>'),text:"Unit Pelayanan",dataIndex:"RUANGAN",flex:1.3},{xtype:"templatecolumn",tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 12px; white-space:normal !important;">{[values.LAYANAN]} </div>'),text:"Nama Pelayanan",dataIndex:"LAYANAN",flex:2},{xtype:"datecolumn",text:"Tgl Pelayanan",dataIndex:"TANGGAL",format:"d/m/Y H:i:s",width:150},{text:"JENIS RINCIAN",dataIndex:"JENIS_RINCIAN",width:150,hidden:true},{xtype:"numbercolumn",text:"Qty",dataIndex:"JUMLAH",width:60,align:"right"},{xtype:"numbercolumn",text:"Tarif/Harga (Rp)",dataIndex:"TARIF",align:"right",width:120,summaryRenderer:"onSummaryInfoRenderer"},{xtype:"numbercolumn",text:"TOTAL (Rp)",align:"right",format:"0,00",width:120,renderer:"onTotalRenderer",summaryRenderer:"onSummaryRenderer"}],features:[{ftype:"summary",dock:"bottom"}],dockedItems:[{xtype:"toolbar",dock:"top",items:["->",{xtype:"search-field",cls:"x-text-border",iconCls:"iconSearch",autoFocus:true,emptyText:"Cari Nama Pelayanan / Pemeriksaan",enableKeyEvents:true,width:400,listeners:{search:"onSearch",clear:"onClear",change:"onChange"}},{xtype:"referensi-combo",reference:"filterby",triggers:{clear:{weight:0,cls:Ext.baseCSSPrefix+"form-clear-trigger",hidden:true,handler:"onClearClick"}},params:{JENIS:30},firstLoad:true,emptyText:"Filter berdasarkan:",width:300,listeners:{select:"onFilterBy",change:"onFilterByChange"}},{xtype:"fieldcontainer",defaultType:"button",border:false,layout:"hbox",bind:{hidden:"{!listConfig.kunci}"},defaults:{width:100,padding:5,handler:"onKunci"},border:false,items:[{reference:"btnKunci",style:"border-bottom-left-radius: 15px 15px; border-top-left-radius: 15px 15px;",bind:{text:"{getKunciStatusText}"},kunci:1},{reference:"btnTdkTerkunci",style:"border-bottom-right-radius: 15px 15px; border-top-right-radius: 15px 15px;",bind:{text:"{getTidakTerkunciStatusText}"},kunci:0}]}]}],onBeforeLoad:function(c,b,a){var d=c.down("referensi-combo");c.total=0;if(a){if(a.clearFilter){a.clearFilter(true)}}d.select(null);c.setUiButtons(c.tagihan.get("KUNCI"))},doAfterLoad:function(b,c,d,a){if(d){if(Ext.isArray(c)){Ext.Array.each(c,function(f){var e=f.get("JUMLAH")*f.get("TARIF");b.total+=e})}}},setUiButtons:function(c){var b=this,a=b.getReferences();a.btnKunci.setTooltip(c==1?"Terkunci":"Kunci");a.btnTdkTerkunci.setTooltip(c==1?"Buka Kunci":"Tdk Terkunci");a.btnKunci.setUI(c==1?"soft-green":"soft-black");a.btnTdkTerkunci.setUI(c==1?"soft-black":"soft-red");a.btnKunci.setWidth(c==1?100:30);a.btnTdkTerkunci.setWidth(c==1?30:100);a.btnKunci.setIconCls(c==1?"":"x-fa fa-circle");a.btnTdkTerkunci.setIconCls(c==1?"x-fa fa-circle":"")}});Ext.define("pembayaran.tagihan.rincian.ListController",{extend:"Ext.app.ViewController",alias:"controller.rincian-tagihan-list",onTotalRenderer:function(d,b,c){var a=c.get("JUMLAH")*c.get("TARIF");return Ext.util.Format.number(a,"0,00")},onSummaryRenderer:function(d,b,c){var a='<span style="font-size: 17px; font-weight: bold">'+Ext.util.Format.number(this.getView().total,"0,00")+"</span>";return a},onSummaryInfoRenderer:function(){return'<span style="font-size: 17px; font-weight: bold">Total: </span>'},onFilterBy:function(a,b){if(b){this.onChange(null,"");this.doFilterBy(b);this.getReferences().filterby.getTrigger("clear").show()}},onFilterByChange:function(a,c,b){if(c==null){this.doFilterBy(c);this.getReferences().filterby.getTrigger("clear").hide();this.getReferences().filterby.select(null)}},onClearClick:function(a){this.onFilterByChange(a,null)},onChange:function(c,e){var d=this,a=d.getView(),b=a.down("search-field");if(e==""){b.onClearClick()}},onSearch:function(a,b){this.onClearClick(null,null);this.doCari(b)},onClear:function(){this.doCari("")},onKunci:function(l){var g=this,i=g.getView(),c=i.tagihan;if(c.get("KUNCI")!=l.kunci){if(l.kunci==1){var j=i.getReferensi(c.getData(),"TAGIHAN_PENDAFTARAN"),e=i.getReferensi(c.getData(),"PASIEN"),d=null,k="";j.forEach(function(m){if(m.UTAMA==1){k=m.PENDAFTARAN;d=i.getReferensi(m,"KUNJUNGAN")}});if(d==null){var b=Ext.create("kunjungan.List",{ui:"panel-cyan",showCloseButton:true,title:"History Kunjungan Pasien "+e.get("NAMA")+"("+e.get("NORM")+")"}),f=true;b.setListConfig({paging:false,hiddenPencarian:true,hiddenLihatAction:true,hiddenFinalAction:false});b.setParams({TAGIHAN:c.get("ID"),JENIS_KUNJUNGAN:"!3",STATUS:1});if(i.app.xpriv("1215",false)){var a=Ext.create("pendaftaran.penerimaanlayanan.List",{ui:"panel-cyan",showCloseButton:true,title:"Daftar Penerimaan Layanan yang belum di terima an. Pasien "+e.get("NAMA")+"("+e.get("NORM")+")"}),h=true;a.load({NOPEN:k,STATUS:1});a.doAfterLoad=function(m,o,p,n){if(p){if(o.length>0){if(h){h=false;i.openDialog("",true,"70%","60%",a,function(q,r){g.windowDlgPl=r})}return}}if(g.windowDlgPl){g.windowDlgPl.close()}b.load()}}else{b.load()}b.doAfterLoad=function(m,o,p,n){if(p){if(o.length>0){if(f){f=false;i.openDialog("",true,"90%","70%",b,function(q,r){g.windowDlg=r;r.on("close",function(){i.fireEvent("afterfinalkunjungan")})})}}else{if(g.windowDlg){g.windowDlg.close()}g.doKunciTagihan(g,i,c,l)}}else{if(g.windowDlg){g.windowDlg.close()}g.doKunciTagihan(g,i,c,l)}}}}else{g.doKunciTagihan(g,i,c,l)}}},doKunciTagihan:function(e,a,d,c){var b=Ext.create("data.model.Tagihan",{ID:d.get("ID")});a.setLoading(true);b.set("KUNCI",c.kunci);console.log(b);d.set("KUNCI",c.kunci);b.showError=true;a.setUiButtons(c.kunci);b.save({callback:function(h,f,g){if(g){a.notifyMessage("Tagihan berhasil "+(c.kunci==1?"terkunci":"tidak terkunci"),"danger-blue")}else{d.set("KUNCI",c.kunci==1?0:1);a.setUiButtons(c.kunci==1?0:1);a.notifyMessage("Tagihan gagal untuk "+(c.kunci==1?"terkunci":"tidak terkunci"),"danger-red");delete b}a.setLoading(false)}})},privates:{doFilterBy:function(d){var c=this,a=c.getView(),b=c.getStore("store");if(b){b.clearFilter(true);a.total=0;b.filterBy(function(f){if(d){var e=f.get("JENIS")==d.get("ID");if(e){a.total+=f.get("JUMLAH")*f.get("TARIF")}return e}a.total+=f.get("JUMLAH")*f.get("TARIF");return true})}},doCari:function(d){var c=this,a=c.getView(),b=c.getStore("store");if(b){b.clearFilter(true);a.total=0;b.filterBy(function(f){if(d!=""){var e=f.get("LAYANAN").toLowerCase().indexOf(d.toLowerCase())>-1;if(e){a.total+=f.get("JUMLAH")*f.get("TARIF")}return e}a.total+=f.get("JUMLAH")*f.get("TARIF");return true})}}}});Ext.define("pembayaran.tagihan.rincian.Workspace",{extend:"com.Form",xtype:"workspace-rincian",controller:"workspace-rincian",layout:"fit",items:[{xtype:"rincian-tagihan-list"}],onLoadRecord:function(a,c){var b=a.down("rincian-tagihan-list");b.tagihan=c;b.setListConfig({kunci:a.getPropertyConfig(69)=="TRUE"});b.load({RINCIAN:1,TAGIHAN:c.get("ID"),STATUS:1})}});Ext.define("pembayaran.tagihan.rincian.WorkspaceController",{extend:"Ext.app.ViewController",alias:"controller.workspace-rincian"});Ext.define("pembayaran.transaksikasir.Detil",{extend:"com.Form",alias:"widget.transaksikasir-detil",controller:"transaksikasir-detil",layout:{type:"hbox",align:"stretch"},items:[{xtype:"fieldset",flex:1,defaultType:"displayfield",cls:" shadow-panel x-color-w",fieldDefaults:{labelWidth:"100%"},items:[{style:"font-size: 2em; font-weight: bold;",fieldLabel:"Unit"},{style:"font-size: 1em; font-weight: bold;",fieldLabel:"NAMA KASIR"},{xtype:"label",text:"Transaksi yang anda lakukan akan berpengaruh ke setoran kasir"}]},{xtype:"fieldset",layout:{type:"vbox",align:"stretch"},flex:1,defaultType:"displayfield",cls:" shadow-panel x-color-w",fieldDefaults:{labelWidth:"100%"},items:[{xtype:"textarea",emptyText:"[ Keterangan ]"},{xtype:"textfield",emptyText:"[ Tanggal / Jam ]"}]}]});Ext.define("pembayaran.transaksikasir.DetilController",{extend:"Ext.app.ViewController",alias:"controller.transaksikasir-detil"});Ext.define("pembayaran.transaksikasir.List",{extend:"com.Grid",alias:"widget.transaksi-kasir-list",controller:"transaksi-kasir-list",viewModel:{data:{listConfig:{filter:{enabled:false,kasir:false}}},stores:{store:{type:"transaksi-kasir-store"}}},title:"Transaksi Kasir",hideHeaders:true,tools:[{type:"refresh",callback:"onRefresh"}],dockedItems:[{xtype:"pagingtoolbar",hidden:true,bind:{store:"{store}",hidden:"{!listConfig.paging}"},dock:"bottom",beforePageText:"Hal.",afterPageText:"dari {0}",displayMsg:"Menampilkan {0} - {1} dari {2}",displayInfo:true},{xtype:"toolbar",dock:"top",overflowHandler:"menu",bind:{hidden:"{!listConfig.filter.enabled}"},items:[{xtype:"kasir-combo",reference:"kasircombo",listeners:{select:"onSelectKasirCombo"},bind:{hidden:"{!listConfig.filter.kasir}"}}]}],columns:[{xtype:"templatecolumn",flex:2,tpl:new Ext.XTemplate('<div style="font-weight: bold; font-size: 12px; white-space:normal !important;">No. {[values.NOMOR]} </div>','<div style="font-size: 12px; white-space:normal !important;"><span class="x-fa fa-folder-open"></span> {[this.tanggalFormat(values.BUKA)]}</div>','<div style="font-size: 12px; white-space:normal !important;"><span class="x-fa fa-folder"></span> {[this.tanggalFormat(values.TUTUP)]}</div>',{tanggalFormat:function(c){var d=Ext.isDate(c)?c:Ext.Date.parse(c,"Y-m-d H:i:s");return Ext.Date.format(d,"d-m-Y H:i:s")}})},{text:"Status",dataIndex:"STATUS",renderer:"onRendererStatus"}],listeners:{afterrender:"onAfterRender"}});Ext.define("pembayaran.transaksikasir.ListController",{extend:"Ext.app.ViewController",alias:"controller.transaksi-kasir-list",onRendererStatus:function(a){return a==1?"Buka":"Tutup"},onAfterRender:function(){var c=this,a=c.getView(),b=c.getReferences();b.kasircombo.setValue(a.app.usrid);b.kasircombo.load();a.setLoading(true);a.load({KASIR:a.app.usrid})},onSelectKasirCombo:function(c,e){var d=this,a=d.getView(),b=d.getReferences();if(e){a.setLoading(true);a.load({KASIR:e.get("ID")})}},onRefresh:function(){this.getView().reload()}});Ext.define("pembayaran.transaksikasir.Tab",{extend:"com.Tab",alias:"widget.listpasien-tab",viewModel:{type:"pembayaranmodel",data:{disableGrid:true}},bind:{disabled:"disableGrid"},cls:"x-br-top",border:false,items:[{title:"View Pasien Belum Bayar",layout:"fit",items:[{xtype:"pasienbelumbayar-list",reference:"pasienbelumbayarlist",showSearch:true}]}],load:function(a){var b=this.down("[reference=pasienbelumbayarlist]");b.load(a)}});Ext.define("pembayaran.widget.Info",{extend:"com.Form",alias:"widget.pembayaran-widget-info",controller:"pembayaran-widget-info",viewModel:{data:{pasien:undefined,dataFound:false},stores:{store:{type:"data-store-gabung-tagihan"}}},cls:"shadow-panel",border:true,firstLoad:true,isAfterRender:false,layout:{type:"vbox",align:"stretch"},header:{iconCls:"x-fa fa-credit-card",title:"Tagihan / Pembayaran",margin:0,padding:"5 10 5 10",cls:"x-color-w",layout:{type:"hbox",align:"middle"},items:[{xtype:"component",flex:1},{xtype:"button",iconCls:"x-fa fa-history",tooltip:"History Tagihan / Pembayaran",ui:"soft-cyan",bind:{},margin:"0 0 0 1",handler:"onHistoryTagihan"}]},bodyPadding:5,initComponent:function(){var a=this;a.items=[{xtype:"tagihan-list",viewConfig:{loadMask:false},multiSelect:true,reference:"tagihanlist",listeners:{viewtagihan:"onViewTagihan",rowcontextmenu:"onKlikKananTagihan"}}];a.callParent();a.createMenuContext()},createMenuContext:function(){var b=this,c=b.app.xpriv,a=[{text:"Gabung Tagihan",glyph:"xf05a@FontAwesome",scope:b.getController(),handler:"onGabungTagihan"}];if(c("1211",false)){a.push({text:"Batal Gabung Tagihan",glyph:"xf00d@FontAwesome",scope:b.getController(),handler:"onBatalGabungTagihan"})}b.menucontext=new Ext.menu.Menu({items:a});return b.menucontext},refresh:function(){var c=this,b=c.getViewModel(),a=c.getReferences(),d=b.get("pasien");if(a&&c.isAfterRender){if(c.firstLoad){a.tagihanlist.setGridConfig({paging:true});a.tagihanlist.setListConfig({pasienInfo:false});a.tagihanlist.loadStore({NORM:d.get("NORM")});c.firstLoad=false}else{a.tagihanlist.refresh()}}},listeners:{afterrender:"onAfterRender"}});Ext.define("pembayaran.widget.InfoController",{extend:"Ext.app.ViewController",alias:"controller.pembayaran-widget-info",tagihans:[],onViewTagihan:function(a){this.getView().fireEvent("viewtagihan",a)},onHistoryTagihan:function(h){var c=this,g=c.getViewModel(),b=g.get("pasien");this.getView().fireEvent("historytagihan",b)},onKlikKananTagihan:function(b,g,d,h,f){var c=this;refs=c.getReferences(),tagihan=refs.tagihanlist,pilihan=tagihan.getSelection();c.tagihans=[];if(pilihan.length<=2){var a=f.getXY();c.tagihans=pilihan;f.stopEvent();c.getView().menucontext.showAt(a)}},onGabungTagihan:function(c){var d=this,b=d.getReferences(),a=d.getView();a.openDialog("",true,900,220,{xtype:"workspace-gabung-tagihan",title:"Penggabungan Tagihan",ui:"panel-blue",showCloseButton:true},function(g,f){var e=f.down("workspace-gabung-tagihan");e.on("save",function(h){b.tagihanlist.refresh();f.close()});if(d.tagihans.length==2){e.createRecord({DARI:d.tagihans[0].get("ID"),KE:d.tagihans[1].get("ID"),STATUS:1,REFERENSI:{DARI:d.tagihans[0].data,KE:d.tagihans[1].data}})}else{if(d.tagihans.length==1){e.createRecord({DARI:d.tagihans[0].get("ID"),STATUS:1,REFERENSI:{DARI:d.tagihans[0].data}})}}})},onBatalGabungTagihan:function(d){var f=this,e=f.getViewModel(),c=e.get("store"),b=f.getView(),h=d.scope.tagihans?d.scope.tagihans:null,g=h?(h.length>0?h[0]:null):null,a=b.getReferensi(g.data,"TAGIHAN_PENDAFTARAN");if(g){if(g.get("STATUS")==1){if(a.length>1){c.setQueryParams({KE:g.get("ID")});c.load({scope:d,callback:function(i,j,k){if(k){if(i.length>0){b.showMessageBox({title:"Batal Gabung Tagihan",message:"Anda yakin ingin membatalkan gabung tagihan ini ?",ui:"window-warning",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,defaultButton:"no",animateTarget:d,fn:function(l){if(l==="yes"){c.removeAt(0);c.sync({callback:function(){refs.tagihanlist.load()}})}}})}}}})}}}},onAfterRender:function(){var b=this,a=b.getView();a.isAfterRender=true}});